<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ตั้งค่า (เฉพาะแอดมิน) | HOME PPK 2026</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@400;600;700&display=swap');

        :root {
            --bg: #f8fafc;
            --surface: #ffffff;
            --border: #e5e7eb;
            --text: #0f172a;
            --muted: #64748b;
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #06b6d4;
            --shadow: 0 8px 24px rgba(15,23,42,.06);
            --thead: #e2e8f0;
            --hover: #f1f5f9;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Kanit', sans-serif;
            background: var(--bg);
            min-height: 100vh;
            margin: 0;
            color: var(--text);
        }

        /* Sidebar */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            width: 62px;
            background: linear-gradient(135deg, #2563eb 0%, #38e8ff 100%);
            box-shadow: 2px 0 12px rgba(0,0,0,0.07);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1.2rem 0.3rem;
            transition: width 0.2s;
            z-index: 100;
        }
        .sidebar.expanded { width: 280px; align-items: flex-start; padding-left: 0.7rem; }
        .sidebar-toggle {
            background: none;
            border: none;
            color: #fff;
            font-size: 1.7rem;
            margin-bottom: 1.2rem;
            cursor: pointer;
            outline: none;
            align-self: flex-end;
        }
        .sidebar-menu { display: flex; flex-direction: column; gap: 0.2rem; width: 100%; flex: 1; }
        .sidebar-link {
            display: flex;
            align-items: center;
            gap: 0.9rem;
            color: #fff;
            background: none;
            border: none;
            font-size: 1.08rem;
            font-family: inherit;
            padding: 0.5rem;
            border-radius: 8px;
            cursor: pointer;
            text-align: left;
            width: 100%;
            transition: background 0.15s, color 0.15s;
        }
        .sidebar-link.active, .sidebar-link:hover { background: #fff; color: #2563eb; }
        .sidebar-link-icon { font-size: 1.25rem; min-width: 1.5em; text-align: center; }
        .sidebar-label { display: none; font-size: 1rem; line-height: 1.3; }
        .sidebar.expanded .sidebar-label { display: inline; }

        @media (max-width: 600px) {
            .sidebar { width: 48px; }
            .sidebar.expanded { width: 160px; }
        }

        /* Dashboard Container */
        .dashboard-container {
            margin-left: 62px;
            background: var(--bg);
            padding: 2rem;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            align-items: center;
            transition: margin-left 0.2s;
        }
        .sidebar.expanded ~ .dashboard-container { margin-left: 280px; }
        @media (max-width: 600px) {
            .dashboard-container { margin-left: 48px; padding: 1rem; }
            .sidebar.expanded ~ .dashboard-container { margin-left: 160px; }
        }

        /* Header */
        .dashboard-header {
            display: flex;
            align-items: center;
            gap: 0.7rem;
            margin-bottom: 0.5rem;
            justify-content: center;
        }
        .dashboard-header-icon {
            font-size: 2.1rem;
            color: var(--danger);
        }
        .dashboard-container h2 {
            margin: 0;
            color: var(--danger);
            font-weight: 700;
            font-size: 1.8rem;
            text-align: center;
        }

        /* Back Button */
        .back-btn {
            align-self: flex-start;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.6rem 1rem;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: var(--surface);
            font: inherit;
            font-weight: 700;
            cursor: pointer;
            color: var(--text);
            text-decoration: none;
        }
        .back-btn:hover { background: var(--hover); }

        /* Tabs */
        .tabs-container {
            width: 100%;
            max-width: 1200px;
        }
        .tabs {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
            border-bottom: 2px solid var(--border);
            padding-bottom: 0.5rem;
        }
        .tab-btn {
            padding: 0.7rem 1.2rem;
            border: 1px solid var(--border);
            border-radius: 10px 10px 0 0;
            background: var(--surface);
            font: inherit;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            color: var(--muted);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .tab-btn:hover { background: var(--hover); color: var(--text); }
        .tab-btn.active {
            background: var(--primary);
            color: #fff;
            border-color: var(--primary);
        }
        .tab-btn-icon { font-size: 1.1rem; }

        /* Tab Content */
        .tab-content {
            display: none;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
        }
        .tab-content.active { display: block; }

        /* Section */
        .section {
            margin-bottom: 1.5rem;
        }
        .section:last-child { margin-bottom: 0; }
        .section-title {
            font-size: 1.15rem;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .section-desc {
            font-size: 0.9rem;
            color: var(--muted);
            margin-bottom: 1rem;
        }

        /* Form */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
        }
        .form-group label {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text);
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 0.7rem 0.9rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            font: inherit;
            font-size: 0.95rem;
            background: #fff;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37,99,235,0.1);
        }
        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }
        .form-group .hint {
            font-size: 0.85rem;
            color: var(--muted);
        }

        /* Buttons */
        .btn {
            padding: 0.6rem 1.2rem;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--surface);
            font: inherit;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
        }
        .btn:hover { background: var(--hover); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: var(--primary); color: #fff; border-color: var(--primary); }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-success { background: var(--success); color: #fff; border-color: var(--success); }
        .btn-success:hover { background: #059669; }
        .btn-danger { background: var(--danger); color: #fff; border-color: var(--danger); }
        .btn-danger:hover { background: #dc2626; }
        .btn-warning { background: var(--warning); color: #fff; border-color: var(--warning); }
        .btn-warning:hover { background: #d97706; }
        .btn-info { background: var(--info); color: #fff; border-color: var(--info); }
        .btn-info:hover { background: #0891b2; }

        .btn-group {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-top: 1rem;
        }

        /* Table */
        .table-container {
            overflow-x: auto;
            margin-top: 1rem;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }
        th, td {
            border: 1px solid var(--border);
            padding: 0.6rem 0.8rem;
            text-align: center;
        }
        th {
            background: var(--thead);
            font-weight: 700;
            white-space: nowrap;
        }
        tbody tr:hover { background: var(--hover); }
        td { vertical-align: middle; }
        .action-btns {
            display: flex;
            gap: 0.3rem;
            justify-content: center;
            flex-wrap: wrap;
        }
        .action-btns .btn {
            padding: 0.35rem 0.6rem;
            font-size: 0.85rem;
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background: var(--surface);
            border-radius: 14px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            background: var(--surface);
            z-index: 10;
        }
        .modal-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text);
        }
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--muted);
            padding: 0;
            line-height: 1;
        }
        .modal-close:hover { color: var(--danger); }
        .modal-body {
            padding: 1.5rem;
        }
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border);
            background: var(--hover);
        }

        /* Alert */
        .alert {
            padding: 0.8rem 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .alert-success { background: #d1fae5; color: #065f46; border: 1px solid #10b981; }
        .alert-danger { background: #fee2e2; color: #991b1b; border: 1px solid #ef4444; }
        .alert-warning { background: #fef3c7; color: #92400e; border: 1px solid #f59e0b; }
        .alert-info { background: #cffafe; color: #155e75; border: 1px solid #06b6d4; }

        /* Badge */
        .badge {
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .badge-success { background: #d1fae5; color: #065f46; }
        .badge-warning { background: #fef3c7; color: #92400e; }
        .badge-danger { background: #fee2e2; color: #991b1b; }
        .badge-info { background: #cffafe; color: #155e75; }

        /* Checkbox/Radio */
        .checkbox-group, .radio-group {
            display: flex;
            flex-wrap: wrap;
            gap: 0.8rem;
        }
        .checkbox-item, .radio-item {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            cursor: pointer;
        }
        .checkbox-item input, .radio-item input {
            width: 1.1rem;
            height: 1.1rem;
            cursor: pointer;
        }

        /* Settings Card */
        .settings-card {
            background: var(--hover);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .settings-card:last-child { margin-bottom: 0; }
        .settings-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .settings-card-title {
            font-weight: 700;
            color: var(--text);
            font-size: 1rem;
        }
        .settings-card-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        /* Search Box */
        .search-box {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        .search-box input {
            flex: 1;
            padding: 0.7rem 1rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            font: inherit;
        }

        /* Footer */
        .footer-credit {
            text-align: center;
            margin-top: 2rem;
            font-size: 0.9rem;
            color: var(--muted);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .tabs { flex-direction: column; }
            .tab-btn { border-radius: 8px; }
            .form-grid { grid-template-columns: 1fr; }
            .modal { max-width: 95%; }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <button class="sidebar-toggle" id="sidebarToggle" title="ขยาย/ย่อเมนู">☰</button>
        <nav class="sidebar-menu">
            <button class="sidebar-link" onclick="navigate('?page=dashboard')">
                <span class="sidebar-link-icon">🏠</span>
                <span class="sidebar-label">แดชบอร์ด</span>
            </button>
            <button class="sidebar-link" onclick="navigate('?page=payment-history')">
                <span class="sidebar-link-icon">💸</span>
                <span class="sidebar-label">ข้อมูลการชำระย้อนหลัง</span>
            </button>
            <button class="sidebar-link" onclick="navigate('?page=form')">
                <span class="sidebar-link-icon">📝</span>
                <span class="sidebar-label">แบบฟอร์มคำร้อง</span>
            </button>
            <button class="sidebar-link" onclick="navigate('?page=regulations')">
                <span class="sidebar-link-icon">📚</span>
                <span class="sidebar-label">ระเบียบ</span>
            </button>
            <button class="sidebar-link" onclick="navigate('?page=settings')">
                <span class="sidebar-link-icon">⚙️</span>
                <span class="sidebar-label">ตั้งค่าส่วนตัว</span>
            </button>
            <button class="sidebar-link active" onclick="navigate('?page=team-management')">
                <span class="sidebar-link-icon">👥</span>
                <span class="sidebar-label">โปรแกรมบริหารจัดการ</span>
            </button>
            <button class="sidebar-link" onclick="doLogout()" style="margin-top:auto;border-top:1px solid rgba(255,255,255,0.12);color:#fca5a5;">
                <span class="sidebar-link-icon">🚪</span>
                <span class="sidebar-label">ออกจากระบบ</span>
            </button>

        </nav>
    </div>

    <div class="dashboard-container" id="dashboardContainer">
        <button class="back-btn" onclick="navigate('?page=team-management')">⬅ กลับ</button>

        <div class="dashboard-header">
            <span class="dashboard-header-icon">🔧</span>
            <h2>ตั้งค่า (เฉพาะแอดมิน)</h2>
        </div>

        <div class="alert alert-warning" id="adminWarning">
            ⚠️ หน้านี้สำหรับผู้ดูแลระบบ (Admin) เท่านั้น การแก้ไขค่าต่างๆ จะส่งผลต่อระบบทั้งหมด กรุณาตรวจสอบให้ละเอียดก่อนบันทึก
        </div>

        <!-- Tabs -->
        <div class="tabs-container">
            <div class="tabs">
                <button class="tab-btn active" onclick="showTab('housing', this)">
                    <span class="tab-btn-icon">�</span> ที่พักอาศัย
                </button>
                <button class="tab-btn" onclick="showTab('water', this)">
                    <span class="tab-btn-icon">💧</span> ค่าน้ำ
                </button>
                <button class="tab-btn" onclick="showTab('electric', this)">
                    <span class="tab-btn-icon">⚡</span> ค่าไฟ
                </button>
                <button class="tab-btn" onclick="showTab('common', this)">
                    <span class="tab-btn-icon">🏢</span> ค่าส่วนกลาง
                </button>
                <button class="tab-btn" onclick="showTab('permissions', this)">
                    <span class="tab-btn-icon">🔐</span> จัดการสิทธิ์
                </button>
                <button class="tab-btn" onclick="showTab('announcements', this)">
                    <span class="tab-btn-icon">📢</span> ประกาศ
                </button>
                <button class="tab-btn" onclick="showTab('system', this)">
                    <span class="tab-btn-icon">⚙️</span> ตั้งค่าระบบ
                </button>
                <button class="tab-btn" onclick="showTab('registration', this)" id="tabBtnRegistration">
                    <span class="tab-btn-icon">📝</span> อนุมัติการสมัคร <span class="badge badge-danger" id="pendingCount" style="margin-left:4px; display:none;">0</span>
                </button>
            </div>

            <!-- Tab: Housing + Residents (merged) -->
            <div class="tab-content active" id="tab-housing">
                <div class="section">
                    <div class="section-title">🏨 จัดการที่พักอาศัย</div>
                    <div class="section-desc">จัดการบ้านพัก/แฟลต และผู้พักอาศัยทั้งหมดในที่เดียว</div>

                    <!-- Action Buttons -->
                    <div class="btn-group">
                        <button class="btn btn-success" onclick="openModal('addHousing')">&#xFF0B; เพิ่มบ้าน/แฟลต</button>
                        <button class="btn btn-primary" onclick="openModal('addResident')">&#xFF0B; เพิ่มผู้พักอาศัย</button>
                        <button class="btn btn-info" onclick="exportResidents()">📥 ส่งออกข้อมูล</button>
                    </div>

                    <!-- Format Settings (collapsible) -->
                    <details style="margin-top:1rem; background:var(--bg); border:1px solid var(--border); border-radius:10px; padding:0.1rem 1rem;">
                        <summary style="cursor:pointer; padding:0.75rem 0; font-weight:600; color:var(--muted); font-size:0.9rem; user-select:none;">⚙️ ตั้งค่ารูปแบบเลขที่ (คลิกเพื่อขยาย)</summary>
                        <div style="padding-bottom:1rem;">
                        <div class="form-grid" style="margin-top:0.75rem;">
                            <div class="form-group">
                                <label>รูปแบบเลขที่บ้านพัก</label>
                                <select id="houseNumberFormat">
                                    <option value="number">ตัวเลขอย่างเดียว (1, 2, 3...)</option>
                                    <option value="prefix-number" selected>คำนำหน้า + ตัวเลข (บ้าน 1, บ้าน 2...)</option>
                                    <option value="zone-number">โซน + ตัวเลข (A-1, A-2, B-1...)</option>
                                    <option value="custom">กำหนดเอง</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>คำนำหน้าบ้านพัก</label>
                                <input type="text" id="housePrefix" value="บ้าน " placeholder="เช่น บ้าน, H, House">
                            </div>
                            <div class="form-group">
                                <label>รูปแบบเลขที่แฟลต</label>
                                <select id="flatNumberFormat">
                                    <option value="number">ตัวเลขอย่างเดียว (101, 102...)</option>
                                    <option value="prefix-number" selected>คำนำหน้า + ตัวเลข (ห้อง 101, ห้อง 102...)</option>
                                    <option value="floor-room">ชั้น + ห้อง (1-01, 1-02, 2-01...)</option>
                                    <option value="building-floor-room">อาคาร + ชั้น + ห้อง (F1-101, F2-201...)</option>
                                    <option value="custom">กำหนดเอง</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>คำนำหน้าแฟลต</label>
                                <input type="text" id="flatPrefix" value="แฟลต" placeholder="เช่น แฟลต, ห้อง, F, Flat">
                            </div>
                        </div>
                        <div class="btn-group" style="margin-top:0.5rem;">
                            <button class="btn btn-success" onclick="saveHousingFormat()">💾 บันทึกรูปแบบ</button>
                        </div>
                        </div>
                    </details>

                    <!-- View Mode Toggle -->
                    <div style="margin-top:1rem; display:flex; gap:0.5rem; align-items:center; flex-wrap:wrap;">
                        <span style="font-weight:600; font-size:0.9rem; color:var(--muted)">👁️ มุมมอง:</span>
                        <button class="btn" id="viewModeByHouse" onclick="setResidentViewMode('byHouse')" style="background:var(--primary);color:#fff;">🏠 ตามบ้าน/ห้อง</button>
                        <button class="btn" id="viewModeIndividual" onclick="setResidentViewMode('individual')">👤 รายบุคคล</button>
                        <button class="btn" id="viewModeManageHousing" onclick="setResidentViewMode('manageHousing')">📋 จัดการบ้านพัก</button>
                    </div>

                    <!-- Unified Search -->
                    <div class="search-box" style="margin-top:1rem;">
                        <input type="text" id="searchResident" placeholder="🔍 ค้นหาผู้พักอาศัย/บ้านพัก (ชื่อ, อีเมล, เลขที่)..." oninput="filterResidentView(); filterHousingTable();">
                    </div>

                    <!-- View: By House (cards) -->
                    <div id="residentViewByHouse" style="margin-top:1rem;">
                        <div id="houseCardsContainer" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(280px, 1fr)); gap:1rem;"></div>
                    </div>

                    <!-- View: Individual Table -->
                    <div id="residentViewIndividual" style="display:none;">
                        <div class="table-container">
                            <table id="residentTable">
                                <thead>
                                    <tr>
                                        <th style="width:50px;">ลำดับ</th>
                                        <th>ชื่อ-นามสกุล</th>
                                        <th>บ้าน/ห้อง</th>
                                        <th>ประเภท</th>
                                        <th>ตำแหน่ง</th>
                                        <th>เบอร์โทร</th>
                                        <th>สถานะ</th>
                                        <th style="width:120px;">จัดการ</th>
                                    </tr>
                                </thead>
                                <tbody id="residentTableBody"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- View: Manage Housing (cards) -->
                    <div id="residentViewManageHousing" style="display:none;">
                        <div style="margin-top:0.75rem;">
                            <!-- Summary Stats -->
                            <div id="manageHousingSummary" style="display:flex; gap:1rem; flex-wrap:wrap; margin-bottom:1rem;"></div>
                            <!-- Card Grid -->
                            <div id="manageHousingGrid" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(230px, 1fr)); gap:1rem;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab: Water -->
            <div class="tab-content" id="tab-water">
                <div class="section">
                    <div class="section-title">💧 ตั้งค่าอัตราค่าน้ำ</div>
                    <div class="section-desc">กำหนดอัตราค่าน้ำต่อหน่วย ซึ่งจะมีผลต่อการคำนวณในหน้าบันทึกค่าน้ำ</div>

                    <div class="settings-card">
                        <div class="settings-card-header">
                            <span class="settings-card-title">อัตราค่าน้ำปัจจุบัน</span>
                            <span class="settings-card-value" id="currentWaterRate">18 บาท/หน่วย</span>
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label for="waterRate">อัตราค่าน้ำต่อหน่วย (บาท)</label>
                            <input type="number" id="waterRate" value="18" min="0" step="0.01">
                            <span class="hint">ค่าเริ่มต้น: 18 บาท/หน่วย</span>
                        </div>
                        <div class="form-group">
                            <label for="waterMinCharge">ค่าน้ำขั้นต่ำ (บาท)</label>
                            <input type="number" id="waterMinCharge" value="0" min="0" step="1">
                            <span class="hint">0 = ไม่มีขั้นต่ำ</span>
                        </div>
                        <div class="form-group">
                            <label for="waterRounding">การปัดเศษค่าน้ำ</label>
                            <select id="waterRounding">
                                <option value="none">ไม่ปัดเศษ</option>
                                <option value="round" selected>ปัดเศษตามปกติ (≥0.5 ปัดขึ้น)</option>
                                <option value="ceil">ปัดขึ้นเสมอ</option>
                                <option value="floor">ปัดลงเสมอ</option>
                            </select>
                        </div>
                    </div>

                    <div class="btn-group">
                        <button class="btn btn-success" onclick="saveWaterSettings()">💾 บันทึกการตั้งค่าค่าน้ำ</button>
                    </div>

                    <div class="settings-card" style="margin-top: 1.5rem;">
                        <div class="settings-card-header">
                            <span class="settings-card-title">📊 ประวัติการเปลี่ยนอัตราค่าน้ำ</span>
                        </div>
                        <div class="table-container" style="margin-top: 0.5rem;">
                            <table>
                                <thead>
                                    <tr>
                                        <th>วันที่เปลี่ยน</th>
                                        <th>อัตราเดิม</th>
                                        <th>อัตราใหม่</th>
                                        <th>ผู้แก้ไข</th>
                                    </tr>
                                </thead>
                                <tbody id="waterRateHistory">
                                    <tr>
                                        <td colspan="4" style="color:var(--muted);">ยังไม่มีประวัติการเปลี่ยนแปลง</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab: Electric -->
            <div class="tab-content" id="tab-electric">
                <div class="section">
                    <div class="section-title">⚡ ตั้งค่าค่าไฟฟ้า</div>
                    <div class="section-desc">กำหนดวิธีการปัดเศษและการคำนวณค่าไฟฟ้า</div>

                    <div class="settings-card">
                        <div class="settings-card-header">
                            <span class="settings-card-title">การคำนวณค่าไฟปัจจุบัน</span>
                            <span class="settings-card-value" id="currentElectricMethod">ตามใบแจ้งหนี้</span>
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label for="electricMethod">วิธีการคำนวณค่าไฟ</label>
                            <select id="electricMethod">
                                <option value="bill" selected>ตามใบแจ้งหนี้ (กรอกยอดตรง)</option>
                                <option value="unit">ตามหน่วยที่ใช้</option>
                            </select>
                        </div>
                        <div class="form-group" id="electricRateGroup" style="display:none;">
                            <label for="electricRate">อัตราค่าไฟต่อหน่วย (บาท)</label>
                            <input type="number" id="electricRate" value="4" min="0" step="0.01">
                        </div>
                        <div class="form-group">
                            <label for="electricRounding">การปัดเศษค่าไฟ</label>
                            <select id="electricRounding">
                                <option value="none">ไม่ปัดเศษ</option>
                                <option value="round" selected>ปัดเศษตามปกติ (≥0.5 ปัดขึ้น)</option>
                                <option value="ceil">ปัดขึ้นเสมอ</option>
                                <option value="floor">ปัดลงเสมอ</option>
                                <option value="round10">ปัดเป็นหลัก 10 (123 → 120)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="electricMinCharge">ค่าไฟขั้นต่ำ (บาท)</label>
                            <input type="number" id="electricMinCharge" value="0" min="0" step="1">
                            <span class="hint">0 = ไม่มีขั้นต่ำ</span>
                        </div>
                    </div>

                    <div class="btn-group">
                        <button class="btn btn-success" onclick="saveElectricSettings()">💾 บันทึกการตั้งค่าค่าไฟ</button>
                    </div>
                </div>
            </div>

            <!-- Tab: Common Fee -->
            <div class="tab-content" id="tab-common">
                <div class="section">
                    <div class="section-title">🏢 ตั้งค่าค่าส่วนกลาง</div>
                    <div class="section-desc">กำหนดอัตราค่าส่วนกลาง ซึ่งจะมีผลต่อหน้าแจ้งยอดชำระ</div>

                    <div class="settings-card">
                        <div class="settings-card-header">
                            <span class="settings-card-title">ค่าส่วนกลางปัจจุบัน</span>
                            <span class="settings-card-value" id="currentCommonFee">110 บาท/เดือน</span>
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label for="commonFeeHouse">ค่าส่วนกลาง - บ้านพัก (บาท/เดือน)</label>
                            <input type="number" id="commonFeeHouse" value="110" min="0" step="10">
                        </div>
                        <div class="form-group">
                            <label for="commonFeeFlat">ค่าส่วนกลาง - แฟลต (บาท/เดือน)</label>
                            <input type="number" id="commonFeeFlat" value="110" min="0" step="10">
                        </div>
                        <div class="form-group">
                            <label for="commonFeeNote">หมายเหตุค่าส่วนกลาง</label>
                            <textarea id="commonFeeNote" placeholder="เช่น รวมค่าขยะ, ค่าซ่อมบำรุงส่วนกลาง ฯลฯ">รวมค่าขยะและค่าดูแลส่วนกลาง</textarea>
                        </div>
                    </div>

                    <div class="btn-group">
                        <button class="btn btn-success" onclick="saveCommonFeeSettings()">💾 บันทึกการตั้งค่าค่าส่วนกลาง</button>
                    </div>

                    <div class="settings-card" style="margin-top: 1.5rem;">
                        <div class="settings-card-header">
                            <span class="settings-card-title">🏠 ยกเว้นค่าส่วนกลางรายหลัง (เฉพาะแอดมิน)</span>
                        </div>
                        <div class="section-desc" style="margin-top: 0.5rem; margin-bottom: 1rem;">
                            กำหนดบ้านพัก/แฟลตที่ได้รับการยกเว้นค่าส่วนกลาง เช่น กรณีไม่มีผู้พักอาศัย หรือตามเงื่อนไขพิเศษ
                        </div>
                        <div class="search-box">
                            <input type="text" id="searchExemption" placeholder="🔍 ค้นหาบ้านพัก/แฟลต..." oninput="filterExemptionTable()">
                        </div>
                        <div class="table-container">
                            <table id="exemptionTable">
                                <thead>
                                    <tr>
                                        <th style="width:50px;">ลำดับ</th>
                                        <th>บ้าน/ห้อง</th>
                                        <th>ผู้พักอาศัย</th>
                                        <th style="width:120px;">ยกเว้นค่าส่วนกลาง</th>
                                        <th>หมายเหตุ</th>
                                    </tr>
                                </thead>
                                <tbody id="exemptionTableBody">
                                    <!-- Data will be loaded dynamically -->
                                </tbody>
                            </table>
                        </div>
                        <div class="btn-group" style="margin-top: 1rem;">
                            <button class="btn btn-success" onclick="saveExemptions()">💾 บันทึกการยกเว้น</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab: Permissions -->
            <div class="tab-content" id="tab-permissions">
                <div class="section">
                    <div class="section-title">🔐 จัดการสิทธิ์การเข้าถึง</div>
                    <div class="section-desc">กำหนดสิทธิ์เมนูต่างๆ ให้กับบุคลากรที่มีอีเมลในระบบ — แต่ละคนมีหลายสิทธิ์พร้อมกันได้ | คลิก ⚙️ ที่หัวคอลัมน์เพื่อดูชื่อสิทธิ์</div>

                    <details style="margin-top:0.75rem; background:var(--bg); border:1px solid var(--border); border-radius:10px; padding:0.1rem 1rem;">
                        <summary style="cursor:pointer; padding:0.6rem 0; font-weight:600; color:var(--muted); font-size:0.85rem; user-select:none;">⚙️ คำอธิบายสิทธิ์แต่ละประเภท (คลิกเพื่อขยาย)</summary>
                        <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(220px, 1fr)); gap:0.4rem; padding-bottom:0.75rem; margin-top:0.25rem; font-size:0.85rem;">
                            <div>💧 <strong>ค่าน้ำ</strong> — บันทึก/อ่านมิเตอร์น้ำ</div>
                            <div>⚡ <strong>ค่าไฟ</strong> — บันทึก/อ่านมิเตอร์ไฟ</div>
                            <div>📢 <strong>แจ้งยอด</strong> — ส่งอีเมลแจ้งยอดชำระ</div>
                            <div>🧾 <strong>ตรวจสลิป</strong> — อนุมัติ/ปฏิเสธสลิปโอน</div>
                            <div>💰 <strong>เบิกยอด</strong> — เบิกยอดรวมประจำเดือน</div>
                            <div>📑 <strong>บัญชี</strong> — ดูและส่งออกรายงานการเงิน</div>
                            <div>📋 <strong>คำร้อง</strong> — ตรวจ/อนุมัติคำร้องซ่อมและคิว</div>
                            <div>🔧 <strong>แอดมิน</strong> — สิทธิ์สูงสุด เข้าถึงได้ทุกส่วน</div>
                        </div>
                    </details>

                    <div class="search-box" style="margin-top: 1rem;">
                        <input type="text" id="searchPermission" placeholder="🔍 ค้นหาชื่อ/บ้าน..." oninput="filterPermissionTable()">
                    </div>

                    <!-- Warning: staff stored as cohabitant names -->
                    <div id="permStaffWarning" style="display:none; margin-top:0.75rem;"></div>

                    <div class="table-container">
                        <table id="permissionTable">
                            <thead>
                                <tr>
                                    <th style="width:40px;">#</th>
                                    <th style="text-align:left;">ชื่อ-นามสกุล / อีเมล</th>
                                    <th style="width:60px;" title="ผู้บันทึกค่าน้ำ">💧</th>
                                    <th style="width:60px;" title="ผู้บันทึกค่าไฟ">⚡</th>
                                    <th style="width:60px;" title="ผู้แจ้งยอดชำระ">📢</th>
                                    <th style="width:60px;" title="ผู้ตรวจสลิป">🧾</th>
                                    <th style="width:60px;" title="ผู้เบิกยอดประจำเดือน">💰</th>
                                    <th style="width:60px;" title="ผู้ทำบัญชี">📑</th>
                                    <th style="width:60px;" title="ผู้ตรวจคำร้อง/ลำดับคิว">📋</th>
                                    <th style="width:60px;" title="แอดมิน">🔧</th>
                                </tr>
                            </thead>
                            <tbody id="permissionTableBody">
                                <!-- Data will be loaded dynamically -->
                            </tbody>
                        </table>
                    </div>

                    <div class="btn-group" style="margin-top: 1rem;">
                        <button class="btn btn-success" onclick="savePermissions()">💾 บันทึกการตั้งค่าสิทธิ์</button>
                        <button class="btn btn-info" onclick="exportPermissions()">📥 ส่งออกข้อมูลสิทธิ์</button>
                    </div>

                    <div class="settings-card" style="margin-top: 1.5rem;">
                        <div class="settings-card-header">
                            <span class="settings-card-title">📊 สรุปการกำหนดสิทธิ์</span>
                        </div>
                        <div id="permissionSummary" style="margin-top: 0.5rem;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.5rem;">
                                <div>💧 ผู้บันทึกค่าน้ำ: <strong id="countWater">0</strong> คน</div>
                                <div>⚡ ผู้บันทึกค่าไฟ: <strong id="countElectric">0</strong> คน</div>
                                <div>📢 ผู้แจ้งยอดชำระ: <strong id="countNotify">0</strong> คน</div>
                                <div>🧾 ผู้ตรวจสลิป: <strong id="countSlip">0</strong> คน</div>
                                <div>💰 ผู้เบิกยอดประจำเดือน: <strong id="countWithdraw">0</strong> คน</div>
                                <div>📑 ผู้ทำบัญชี: <strong id="countAccounting">0</strong> คน</div>
                                <div>📋 ผู้ตรวจคำร้อง: <strong id="countRequest">0</strong> คน</div>
                                <div>🔧 แอดมิน: <strong id="countAdmin">0</strong> คน</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab: System -->
            <div class="tab-content" id="tab-system">
                <div class="section">
                    <div class="section-title">⚙️ ตั้งค่าระบบ</div>
                    <div class="section-desc">การตั้งค่าทั่วไปของระบบ</div>

                    <div class="settings-card">
                        <div class="settings-card-header">
                            <span class="settings-card-title">🏫 ข้อมูลหน่วยงาน</span>
                        </div>
                        <div class="form-grid" style="margin-top: 0.5rem;">
                            <div class="form-group">
                                <label for="orgName">ชื่อหน่วยงาน</label>
                                <input type="text" id="orgName" value="งานส่งเสริม กำกับ ดูแล และพัฒนาบ้านพักครู">
                            </div>
                            <div class="form-group">
                                <label for="schoolName">ชื่อโรงเรียน/สถานที่</label>
                                <input type="text" id="schoolName" value="โรงเรียนพะเยาพิทยาคม">
                            </div>
                            <div class="form-group">
                                <label for="adminEmail">อีเมลผู้ดูแลระบบ</label>
                                <input type="email" id="adminEmail" placeholder="admin@school.ac.th">
                            </div>
                            <div class="form-group">
                                <label for="adminPhone">เบอร์โทรติดต่อ</label>
                                <input type="tel" id="adminPhone" placeholder="054-XXXXXX">
                            </div>
                        </div>
                    </div>

                    <div class="settings-card">
                        <div class="settings-card-header">
                            <span class="settings-card-title">📅 ตั้งค่าวันกำหนดชำระ</span>
                        </div>
                        <div class="form-grid" style="margin-top: 0.5rem;">
                            <div class="form-group">
                                <label for="paymentDueWorkingDays">จำนวนวันทำการกำหนดชำระ</label>
                                <input type="number" id="paymentDueWorkingDays" value="15" min="1" max="30">
                                <span class="hint">นับจากวันที่แจ้งยอดชำระ (ข้ามเสาร์-อาทิตย์)</span>
                            </div>
                            <div class="form-group">
                                <label for="reminderDays">แจ้งเตือนล่วงหน้า (วัน)</label>
                                <input type="number" id="reminderDays" value="5" min="0" max="15">
                            </div>
                        </div>
                    </div>

                    <div class="settings-card">
                        <div class="settings-card-header">
                            <span class="settings-card-title">🔐 ตั้งค่าความปลอดภัย</span>
                        </div>
                        <div class="checkbox-group" style="margin-top: 0.5rem;">
                            <label class="checkbox-item">
                                <input type="checkbox" id="requireLogin" checked>
                                <span>บังคับเข้าสู่ระบบก่อนใช้งาน</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" id="allowResetPassword" checked>
                                <span>อนุญาตให้รีเซ็ตรหัสผ่านด้วยตัวเอง</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" id="allowRegistration">
                                <span>อนุญาตให้สมัครสมาชิกด้วยตัวเอง</span>
                            </label>
                        </div>
                    </div>

                    <div class="settings-card">
                        <div class="settings-card-header">
                            <span class="settings-card-title">⏰ วันหมดอายุคิวคำร้อง</span>
                        </div>
                        <div class="section-desc" style="margin-top: 0.3rem; margin-bottom: 0.5rem;">กำหนดวันหมดอายุคิวคำร้องขอเข้าพักอาศัย (ต่อ 1 ภาคเรียน)</div>
                        <div class="form-grid" style="margin-top: 0.5rem;">
                            <div class="form-group">
                                <label for="queueExpiryDateAdmin">วันหมดอายุคิว</label>
                                <input type="date" id="queueExpiryDateAdmin">
                                <span class="hint">คิวทั้งหมดจะหมดอายุพร้อมกันตามวันที่กำหนด</span>
                            </div>
                        </div>
                    </div>

                    <div class="settings-card">
                        <div class="settings-card-header">
                            <span class="settings-card-title">👤 ข้อมูลบุคลากรในตำแหน่งผู้อนุมัติ</span>
                        </div>
                        <div class="section-desc" style="margin-top: 0.3rem; margin-bottom: 0.5rem;">ชื่อบุคลากรที่จะแสดงในแบบฟอร์มคำร้องต่างๆ</div>
                        <div class="form-grid" style="margin-top: 0.5rem;">
                            <div class="form-group">
                                <label for="meterRecorder">ผู้บันทึกข้อมูล (มิเตอร์)</label>
                                <input type="text" id="meterRecorder" placeholder="ชื่อ-นามสกุล">
                            </div>
                            <div class="form-group">
                                <label for="meterChecker">ผู้ตรวจสอบ (มิเตอร์)</label>
                                <input type="text" id="meterChecker" placeholder="ชื่อ-นามสกุล">
                            </div>
                            <div class="form-group">
                                <label for="headOfPromotion">หัวหน้างานส่งเสริมฯ</label>
                                <input type="text" id="headOfPromotion" placeholder="ชื่อ-นามสกุล">
                            </div>
                            <div class="form-group">
                                <label for="viceDirector">รองผอ.กลุ่มบริหารทั่วไป</label>
                                <input type="text" id="viceDirector" placeholder="ชื่อ-นามสกุล">
                            </div>
                            <div class="form-group">
                                <label for="director">ผู้อำนวยการโรงเรียน</label>
                                <input type="text" id="director" placeholder="ชื่อ-นามสกุล">
                            </div>
                        </div>
                    </div>

                    <div class="settings-card">
                        <div class="settings-card-header">
                            <span class="settings-card-title">📧 เทมเพลตอีเมล</span>
                        </div>
                        <div class="section-desc" style="margin-top: 0.3rem; margin-bottom: 0.5rem;">ตั้งค่าอีเมลสำหรับส่งออก และปรับแต่งข้อมูลที่จะส่งในอีเมลแจ้งเตือนและใบเสร็จ</div>

                        <!-- อีเมลสำหรับส่ง -->
                        <div style="margin-top: 0.5rem; padding: 1rem; background: #eff6ff; border: 1px solid #93c5fd; border-radius: 8px;">
                            <label for="emailSender" style="font-weight: 600; color: #1e40af;">📤 อีเมลสำหรับใช้ส่ง</label>
                            <input type="email" id="emailSender" placeholder="ระบุอีเมลที่ใช้ส่งออก เช่น homeppk@school.ac.th" style="margin-top: 0.3rem;">
                            <span class="hint">อีเมลนี้จะเป็นผู้ส่งในอีเมลแจ้งเตือนและใบเสร็จทั้งหมด</span>
                        </div>

                        <!-- ลายเซ็นท้ายอีเมล -->
                        <div class="form-group" style="margin-top: 1rem;">
                            <label for="emailSignature">ลายเซ็นท้ายอีเมล (ใช้ร่วมกันทุกอีเมล)</label>
                            <textarea id="emailSignature" rows="2" placeholder="เช่น งานบ้านพักครู โรงเรียนพะเยาพิทยาคม">งานบ้านพักครู โรงเรียนพะเยาพิทยาคม</textarea>
                        </div>

                        <!-- ส่วนที่ 1: อีเมลแจ้งเตือนการชำระ -->
                        <div style="margin-top: 1.5rem; padding: 1rem; background: #fef3c7; border: 1px solid #fbbf24; border-radius: 8px;">
                            <div style="font-weight: 700; color: #92400e; margin-bottom: 0.5rem;">⚠️ อีเมลแจ้งเตือนการชำระ</div>
                            <div style="font-size: 0.85rem; color: #78350f; margin-bottom: 0.75rem;">เลือกข้อมูลที่ต้องการส่งในอีเมลเตือนค้างชำระ</div>
                            <div class="checkbox-group">
                                <label class="checkbox-item"><input type="checkbox" id="reminderIncludeUnit" checked><span>เลขที่บ้านพัก/ห้อง</span></label>
                                <label class="checkbox-item"><input type="checkbox" id="reminderIncludeTotal" checked><span>ยอดค้างชำระรวม</span></label>
                                <label class="checkbox-item"><input type="checkbox" id="reminderIncludeWater" checked><span>รายละเอียดค่าน้ำ</span></label>
                                <label class="checkbox-item"><input type="checkbox" id="reminderIncludeElectric" checked><span>รายละเอียดค่าไฟ</span></label>
                                <label class="checkbox-item"><input type="checkbox" id="reminderIncludeCommon" checked><span>รายละเอียดค่าส่วนกลาง</span></label>
                                <label class="checkbox-item"><input type="checkbox" id="reminderIncludeDueDate" checked><span>วันกำหนดชำระ</span></label>
                            </div>
                            <div class="form-group" style="margin-top: 0.75rem;">
                                <label for="emailReminderNote">ข้อความเพิ่มเติมในอีเมลเตือน</label>
                                <textarea id="emailReminderNote" rows="2" placeholder="เช่น กรุณาชำระเงินและส่งสลิปโดยเร็วที่สุด">กรุณาชำระเงินและส่งสลิปโดยเร็วที่สุด</textarea>
                            </div>
                        </div>

                        <!-- ส่วนที่ 2: อีเมลใบเสร็จ -->
                        <div style="margin-top: 1.5rem; padding: 1rem; background: #d1fae5; border: 1px solid #34d399; border-radius: 8px;">
                            <div style="font-weight: 700; color: #065f46; margin-bottom: 0.5rem;">✅ อีเมลใบเสร็จรับเงิน</div>
                            <div style="font-size: 0.85rem; color: #064e3b; margin-bottom: 0.75rem;">เลือกข้อมูลที่ต้องการส่งในอีเมลใบเสร็จ</div>
                            <div class="checkbox-group">
                                <label class="checkbox-item"><input type="checkbox" id="receiptIncludeUnit" checked><span>เลขที่บ้านพัก/ห้อง</span></label>
                                <label class="checkbox-item"><input type="checkbox" id="receiptIncludeTotal" checked><span>ยอดที่แจ้งชำระรวม</span></label>
                                <label class="checkbox-item"><input type="checkbox" id="receiptIncludeWater" checked><span>รายละเอียดค่าน้ำ</span></label>
                                <label class="checkbox-item"><input type="checkbox" id="receiptIncludeElectric" checked><span>รายละเอียดค่าไฟ</span></label>
                                <label class="checkbox-item"><input type="checkbox" id="receiptIncludeCommon" checked><span>รายละเอียดค่าส่วนกลาง</span></label>
                                <label class="checkbox-item"><input type="checkbox" id="receiptIncludePaid" checked><span>ยอดที่ชำระจริง</span></label>
                                <label class="checkbox-item"><input type="checkbox" id="receiptIncludeDate" checked><span>วันที่ชำระ</span></label>
                            </div>
                            <div class="form-group" style="margin-top: 0.75rem;">
                                <label for="emailReceiptNote">ข้อความเพิ่มเติมในใบเสร็จ</label>
                                <textarea id="emailReceiptNote" rows="2" placeholder="เช่น ขอบคุณที่ชำระตรงเวลาครับ/ค่ะ">ขอบคุณที่ชำระตรงเวลาครับ/ค่ะ</textarea>
                            </div>
                        </div>
                    </div>

                    <div class="settings-card">
                        <div class="settings-card-header">
                            <span class="settings-card-title">💾 สำรองและกู้คืนข้อมูล</span>
                        </div>
                        <div class="btn-group" style="margin-top: 0.5rem;">
                            <button class="btn btn-info" onclick="backupData()">📥 สำรองข้อมูลทั้งหมด</button>
                            <button class="btn btn-warning" onclick="restoreData()">📤 กู้คืนข้อมูล</button>
                            <button class="btn btn-danger" onclick="clearAllData()">🗑️ ล้างข้อมูลทั้งหมด</button>
                        </div>
                    </div>

                    <div class="settings-card">
                        <div class="settings-card-header">
                            <span class="settings-card-title">📚 จัดการไฟล์ระเบียบบ้านพักครู</span>
                        </div>
                        <div class="section-desc" style="margin-top: 0.3rem; margin-bottom: 0.8rem;">อัพโหลด เปลี่ยน หรือลบไฟล์ระเบียบ (PDF) ที่จะแสดงในหน้าระเบียบ</div>
                        <div style="background: #eff6ff; border: 1px solid #3b82f6; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <span style="font-size: 1.2rem;">📄</span>
                                <span id="regulationFileStatus" style="font-weight: 600; color: #1e40af;">ยังไม่มีไฟล์ระเบียบ</span>
                            </div>
                            <div id="regulationFileInfo" style="font-size: 0.9rem; color: #64748b;"></div>
                        </div>
                        <input type="file" id="regulationPdfUpload" accept="application/pdf" style="display: none;" onchange="handleRegulationPdfUpload(event)">
                        <div class="btn-group" style="margin-top: 0.5rem;">
                            <button class="btn btn-primary" onclick="document.getElementById('regulationPdfUpload').click()">
                                📄 เลือกไฟล์ PDF
                            </button>
                            <button class="btn btn-danger" onclick="deleteRegulationPdf()" id="deleteRegulationBtn" style="display: none;">
                                🗑️ ลบไฟล์ PDF
                            </button>
                        </div>
                    </div>

                    <div class="btn-group">
                        <button class="btn btn-success" onclick="saveSystemSettings()">💾 บันทึกการตั้งค่าระบบ</button>
                    </div>
                </div>
            </div>

            <!-- Tab: Announcements -->
            <div class="tab-content" id="tab-announcements">
                <div class="section">
                    <div class="section-title">📢 จัดการประกาศ</div>
                    <div class="section-desc">เพิ่ม แก้ไข ลบประกาศที่จะแสดงบนแดชบอร์ดของผู้ใช้งานทุกคน</div>

                    <div class="settings-card">
                        <div class="settings-card-header">
                            <span class="settings-card-title">➕ เพิ่มประกาศใหม่</span>
                        </div>
                        <div class="form-grid" style="margin-top: 0.5rem;">
                            <div class="form-group" style="grid-column: 1/-1;">
                                <label>ข้อความประกาศ</label>
                                <textarea id="newAnnouncementText" rows="3" placeholder="พิมพ์ข้อความประกาศที่นี่..."></textarea>
                            </div>
                            <div class="form-group">
                                <label>วันที่หมดอายุ (ถ้ามี)</label>
                                <input type="date" id="announcementExpiry">
                                <span class="hint">เว้นว่าง = ไม่หมดอายุ</span>
                            </div>
                            <div class="form-group">
                                <label>ระดับความสำคัญ</label>
                                <select id="announcementPriority">
                                    <option value="normal">ปกติ</option>
                                    <option value="important">สำคัญ</option>
                                    <option value="urgent">ด่วนมาก</option>
                                </select>
                            </div>
                        </div>
                        <div class="btn-group" style="margin-top: 0.5rem;">
                            <button class="btn btn-primary" onclick="addAnnouncement()">➕ เพิ่มประกาศ</button>
                        </div>
                    </div>

                    <div class="settings-card">
                        <div class="settings-card-header">
                            <span class="settings-card-title">📋 รายการประกาศ</span>
                        </div>
                        <div id="announcementsList" style="margin-top: 0.5rem;">
                            <!-- Announcements will be rendered here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab: Registration Approval (Step 28) -->
            <div class="tab-content" id="tab-registration">
                <div class="section">
                    <div class="section-title">📝 อนุมัติการสมัครสมาชิก</div>
                    <div class="section-desc">ตรวจสอบและอนุมัติ/ปฏิเสธผู้สมัครใช้งานระบบ ผู้สมัครใหม่จะต้องรอแอดมินอนุมัติก่อนจึงจะเข้าใช้งานได้</div>

                    <div class="alert alert-info" style="margin-bottom:1rem;">
                        ℹ️ เมื่อ<strong>อนุมัติ</strong> ระบบจะสร้างบัญชีผู้ใช้ + ข้อมูลผู้พักอาศัยโดยอัตโนมัติ ผู้สมัครจะเข้าสู่ระบบได้ทันที
                    </div>

                    <div class="btn-group" style="margin-bottom:1rem;">
                        <button class="btn btn-primary" onclick="loadPendingRegistrations()">🔄 โหลดรายการใหม่</button>
                    </div>

                    <div id="pendingRegLoading" style="text-align:center; color:var(--muted); padding:1rem; display:none;">
                        ⏳ กำลังโหลดข้อมูล...
                    </div>

                    <div class="table-container">
                        <table id="pendingRegTable">
                            <thead>
                                <tr>
                                    <th style="width:40px;">#</th>
                                    <th>ชื่อ-นามสกุล</th>
                                    <th>อีเมล</th>
                                    <th>เบอร์โทร</th>
                                    <th>ตำแหน่ง</th>
                                    <th>วันที่สมัคร</th>
                                    <th style="width:200px;">จัดการ</th>
                                </tr>
                            </thead>
                            <tbody id="pendingRegTableBody">
                                <tr><td colspan="7" style="color:var(--muted);">กดปุ่ม "โหลดรายการใหม่" เพื่อดูรายการรออนุมัติ</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Modal: Approve Registration -->
            <div class="modal-overlay" id="modal-approveReg">
                <div class="modal">
                    <div class="modal-header">
                        <span class="modal-title">✅ อนุมัติการสมัคร</span>
                        <button class="modal-close" onclick="closeModal('approveReg')">&times;</button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="approveRegId">
                        <div id="approveRegInfo" style="background:var(--hover); padding:1rem; border-radius:8px; margin-bottom:1rem;"></div>
                        <div class="form-group">
                            <label>กำหนดบ้าน/ห้อง (ถ้าทราบ)</label>
                            <input type="text" id="approveRegHouse" placeholder="เช่น บ้าน 1, แฟลต 101 (เว้นว่างได้)">
                        </div>
                        <div class="form-group">
                            <label>ประเภทผู้พักอาศัย</label>
                            <select id="approveRegType">
                                <option value="staff">บุคลากร</option>
                                <option value="teacher">ครู</option>
                                <option value="employee">ลูกจ้าง</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn" onclick="closeModal('approveReg')">ยกเลิก</button>
                        <button class="btn btn-success" onclick="confirmApproveRegistration()">✅ อนุมัติ</button>
                    </div>
                </div>
            </div>

            <!-- Modal: Reject Registration -->
            <div class="modal-overlay" id="modal-rejectReg">
                <div class="modal">
                    <div class="modal-header">
                        <span class="modal-title">❌ ปฏิเสธการสมัคร</span>
                        <button class="modal-close" onclick="closeModal('rejectReg')">&times;</button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="rejectRegId">
                        <div id="rejectRegInfo" style="background:var(--hover); padding:1rem; border-radius:8px; margin-bottom:1rem;"></div>
                        <div class="form-group">
                            <label>เหตุผลที่ปฏิเสธ</label>
                            <textarea id="rejectRegNote" rows="3" placeholder="ระบุเหตุผล..."></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn" onclick="closeModal('rejectReg')">ยกเลิก</button>
                        <button class="btn btn-danger" onclick="confirmRejectRegistration()">❌ ปฏิเสธ</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer-credit">
            ออกแบบและพัฒนาโดย ครูพงศธร โพธิแก้ว<br>
            งานส่งเสริม กำกับ ดูแล และพัฒนาบ้านพักครู โรงเรียนพะเยาพิทยาคม
        </div>
    </div>

    <!-- Modal: Add Housing -->
    <div class="modal-overlay" id="modal-addHousing">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">➕ เพิ่มบ้านพัก/แฟลต</span>
                <button class="modal-close" onclick="closeModal('addHousing')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-grid">
                    <div class="form-group">
                        <label>ประเภท</label>
                        <select id="housingType">
                            <option value="house">บ้านพัก</option>
                            <option value="flat">แฟลต</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>เลขที่/ชื่อ</label>
                        <input type="text" id="housingNumber" placeholder="เช่น 1, A-1, 101">
                    </div>
                    <div class="form-group">
                        <label>โซน/อาคาร (ถ้ามี)</label>
                        <input type="text" id="housingZone" placeholder="เช่น โซน A, อาคาร 1">
                    </div>
                    <div class="form-group">
                        <label>สถานะ</label>
                        <select id="housingStatus">
                            <option value="available">ว่าง</option>
                            <option value="occupied">มีผู้พักอาศัย</option>
                            <option value="maintenance">ซ่อมบำรุง</option>
                        </select>
                    </div>
                    <div class="form-group" style="grid-column: 1/-1;">
                        <label>หมายเหตุ</label>
                        <textarea id="housingNote" placeholder="หมายเหตุเพิ่มเติม (ถ้ามี)"></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('addHousing')">ยกเลิก</button>
                <button class="btn btn-primary" onclick="saveHousing()">บันทึก</button>
            </div>
        </div>
    </div>

    <!-- Modal: Edit Housing -->
    <div class="modal-overlay" id="modal-editHousing">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">✏️ แก้ไขบ้านพัก/แฟลต</span>
                <button class="modal-close" onclick="closeModal('editHousing')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editHousingId">
                <div class="form-grid">
                    <div class="form-group">
                        <label>ประเภท</label>
                        <select id="editHousingType">
                            <option value="house">บ้านพัก</option>
                            <option value="flat">แฟลต</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>เลขที่/ชื่อ</label>
                        <input type="text" id="editHousingNumber" placeholder="เช่น 1, A-1, 101">
                    </div>
                    <div class="form-group">
                        <label>โซน/อาคาร (ถ้ามี)</label>
                        <input type="text" id="editHousingZone" placeholder="เช่น โซน A, อาคาร 1">
                    </div>
                    <div class="form-group">
                        <label>สถานะ</label>
                        <select id="editHousingStatus">
                            <option value="available">ว่าง</option>
                            <option value="occupied">มีผู้พักอาศัย</option>
                            <option value="maintenance">ซ่อมบำรุง</option>
                        </select>
                    </div>
                    <div class="form-group" style="grid-column: 1/-1;">
                        <label>หมายเหตุ</label>
                        <textarea id="editHousingNote" placeholder="หมายเหตุเพิ่มเติม (ถ้ามี)"></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('editHousing')">ยกเลิก</button>
                <button class="btn btn-primary" onclick="updateHousing()">บันทึก</button>
            </div>
        </div>
    </div>

    <!-- Modal: Add Resident -->
    <div class="modal-overlay" id="modal-addResident">
        <div class="modal" style="max-width:780px;">
            <div class="modal-header">
                <span class="modal-title">➕ เพิ่มผู้พักอาศัย</span>
                <button class="modal-close" onclick="closeModal('addResident')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-grid">
                    <div class="form-group" style="grid-column: span 2;">
                        <label>ประเภทผู้พัก <span style="color:#ef4444">*</span></label>
                        <select id="residentType" required>
                            <option value="staff">👨‍🏫 บุคลากร (ครู/พนักงานในหน่วยงาน) - มีสิทธิ์เข้าระบบ</option>
                            <option value="cohabitant">👤 ผู้ร่วมพักอาศัย (บุคคลภายนอก) - ไม่มีสิทธิ์เข้าระบบ</option>
                        </select>
                        <div class="hint" style="color:#ef4444;">⚠️ ผู้ร่วมพักอาศัยที่ไม่ใช่บุคลากรจะไม่มีสิทธิ์เข้าใช้งานระบบโดยเด็ดขาด</div>
                    </div>
                    <div class="form-group">
                        <label>คำนำหน้า</label>
                        <select id="residentPrefix">
                            <option value="">เลือกคำนำหน้า</option>
                            <option value="นาย">นาย</option>
                            <option value="นาง">นาง</option>
                            <option value="นางสาว">นางสาว</option>
                            <option value="อื่นๆ">อื่นๆ</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ชื่อ</label>
                        <input type="text" id="residentFirstName" placeholder="ชื่อ">
                    </div>
                    <div class="form-group">
                        <label>นามสกุล</label>
                        <input type="text" id="residentLastName" placeholder="นามสกุล">
                    </div>
                    <div class="form-group">
                        <label>ตำแหน่งทางวิชาการ</label>
                        <select id="residentPosition">
                            <option value="">เลือกตำแหน่ง</option>
                            <option value="ผู้อำนวยการ">ผู้อำนวยการ</option>
                            <option value="รองผู้อำนวยการ">รองผู้อำนวยการ</option>
                            <option value="ครู">ครู</option>
                            <option value="ครูผู้ช่วย">ครูผู้ช่วย</option>
                            <option value="พนักงานราชการ">พนักงานราชการ</option>
                            <option value="ครูอัตราจ้าง">ครูอัตราจ้าง</option>
                            <option value="เจ้าหน้าที่">เจ้าหน้าที่</option>
                            <option value="ลูกจ้างประจำ">ลูกจ้างประจำ</option>
                            <option value="ลูกจ้างชั่วคราว">ลูกจ้างชั่วคราว</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>กลุ่มสาระการเรียนรู้</label>
                        <select id="residentSubjectGroup">
                            <option value="">เลือกกลุ่มสาระ (ถ้ามี)</option>
                            <option value="ภาษาไทย">ภาษาไทย</option>
                            <option value="คณิตศาสตร์">คณิตศาสตร์</option>
                            <option value="วิทยาศาสตร์และเทคโนโลยี">วิทยาศาสตร์และเทคโนโลยี</option>
                            <option value="สังคมศึกษา ศาสนาและวัฒนธรรม">สังคมศึกษา ศาสนาและวัฒนธรรม</option>
                            <option value="สุขศึกษาและพลศึกษา">สุขศึกษาและพลศึกษา</option>
                            <option value="ศิลปะ">ศิลปะ</option>
                            <option value="การงานอาชีพ">การงานอาชีพ</option>
                            <option value="ภาษาต่างประเทศ">ภาษาต่างประเทศ</option>
                            <option value="กิจกรรมพัฒนาผู้เรียน">กิจกรรมพัฒนาผู้เรียน</option>
                            <option value="ไม่ระบุ">ไม่ระบุ / ไม่สอน</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>เบอร์โทรศัพท์</label>
                        <input type="tel" id="residentPhone" placeholder="เบอร์โทรศัพท์">
                    </div>
                    <div class="form-group">
                        <label>บ้าน/ห้องที่พักอาศัย</label>
                        <select id="residentHouse">
                            <option value="">เลือกบ้าน/ห้อง</option>
                            <!-- Will be populated dynamically -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label>อีเมล</label>
                        <input type="email" id="residentEmail" placeholder="email@example.com">
                    </div>
                    <div class="form-group">
                        <label>วันเดือนปีเกิด</label>
                        <input type="date" id="residentBirthdate">
                    </div>
                    <div class="form-group">
                        <label>รหัสผ่าน</label>
                        <input type="password" id="residentPassword" placeholder="รหัสผ่าน (อย่างน้อย 8 ตัว)">
                    </div>
                    <div class="form-group"></div>
                    <div class="form-group" style="grid-column: span 2;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.5rem;">
                            <label style="margin:0;">👨‍👩‍👧 ผู้อาศัยร่วม</label>
                            <button type="button" class="btn btn-info" style="font-size:0.8rem; padding:0.3rem 0.75rem;" onclick="addCohabitantRow('residentCohabitantList')">➕ เพิ่มผู้อาศัยร่วม</button>
                        </div>
                        <div style="font-size:0.8rem; color:var(--muted); margin-bottom:0.4rem;">คำนำหน้า — ชื่อ — นามสกุล — ความสัมพันธ์ — วันเกิด</div>
                        <div id="residentCohabitantList" style="display:flex; flex-direction:column; gap:0.4rem;"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('addResident')">ยกเลิก</button>
                <button class="btn btn-primary" onclick="saveResident()">บันทึก</button>
            </div>
        </div>
    </div>

    <!-- Modal: Edit Resident -->
    <div class="modal-overlay" id="modal-editResident">
        <div class="modal" style="max-width:780px;">
            <div class="modal-header">
                <span class="modal-title">✏️ แก้ไขผู้พักอาศัย</span>
                <button class="modal-close" onclick="closeModal('editResident')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editResidentId">
                <div class="form-grid">
                    <div class="form-group" style="grid-column: span 2;">
                        <label>ประเภทผู้พัก <span style="color:#ef4444">*</span></label>
                        <select id="editResidentType" required>
                            <option value="staff">👨‍🏫 บุคลากร (ครู/พนักงานในหน่วยงาน) - มีสิทธิ์เข้าระบบ</option>
                            <option value="cohabitant">👤 ผู้ร่วมพักอาศัย (บุคคลภายนอก) - ไม่มีสิทธิ์เข้าระบบ</option>
                        </select>
                        <div class="hint" style="color:#ef4444;">⚠️ ผู้ร่วมพักอาศัยที่ไม่ใช่บุคลากรจะไม่มีสิทธิ์เข้าใช้งานระบบโดยเด็ดขาด</div>
                    </div>
                    <div class="form-group">
                        <label>คำนำหน้า</label>
                        <select id="editResidentPrefix">
                            <option value="">เลือกคำนำหน้า</option>
                            <option value="นาย">นาย</option>
                            <option value="นาง">นาง</option>
                            <option value="นางสาว">นางสาว</option>
                            <option value="อื่นๆ">อื่นๆ</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ชื่อ</label>
                        <input type="text" id="editResidentFirstName" placeholder="ชื่อ">
                    </div>
                    <div class="form-group">
                        <label>นามสกุล</label>
                        <input type="text" id="editResidentLastName" placeholder="นามสกุล">
                    </div>
                    <div class="form-group">
                        <label>ตำแหน่งทางวิชาการ</label>
                        <select id="editResidentPosition">
                            <option value="">เลือกตำแหน่ง</option>
                            <option value="ผู้อำนวยการ">ผู้อำนวยการ</option>
                            <option value="รองผู้อำนวยการ">รองผู้อำนวยการ</option>
                            <option value="ครู">ครู</option>
                            <option value="ครูผู้ช่วย">ครูผู้ช่วย</option>
                            <option value="พนักงานราชการ">พนักงานราชการ</option>
                            <option value="ครูอัตราจ้าง">ครูอัตราจ้าง</option>
                            <option value="เจ้าหน้าที่">เจ้าหน้าที่</option>
                            <option value="ลูกจ้างประจำ">ลูกจ้างประจำ</option>
                            <option value="ลูกจ้างชั่วคราว">ลูกจ้างชั่วคราว</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>กลุ่มสาระการเรียนรู้</label>
                        <select id="editResidentSubjectGroup">
                            <option value="">เลือกกลุ่มสาระ (ถ้ามี)</option>
                            <option value="ภาษาไทย">ภาษาไทย</option>
                            <option value="คณิตศาสตร์">คณิตศาสตร์</option>
                            <option value="วิทยาศาสตร์และเทคโนโลยี">วิทยาศาสตร์และเทคโนโลยี</option>
                            <option value="สังคมศึกษา ศาสนาและวัฒนธรรม">สังคมศึกษา ศาสนาและวัฒนธรรม</option>
                            <option value="สุขศึกษาและพลศึกษา">สุขศึกษาและพลศึกษา</option>
                            <option value="ศิลปะ">ศิลปะ</option>
                            <option value="การงานอาชีพ">การงานอาชีพ</option>
                            <option value="ภาษาต่างประเทศ">ภาษาต่างประเทศ</option>
                            <option value="กิจกรรมพัฒนาผู้เรียน">กิจกรรมพัฒนาผู้เรียน</option>
                            <option value="ไม่ระบุ">ไม่ระบุ / ไม่สอน</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>เบอร์โทรศัพท์</label>
                        <input type="tel" id="editResidentPhone" placeholder="เบอร์โทรศัพท์">
                    </div>
                    <div class="form-group">
                        <label>บ้าน/ห้องที่พักอาศัย</label>
                        <select id="editResidentHouse">
                            <option value="">เลือกบ้าน/ห้อง</option>
                            <!-- Will be populated dynamically -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label>อีเมล</label>
                        <input type="email" id="editResidentEmail" placeholder="email@example.com">
                    </div>
                    <div class="form-group">
                        <label>วันเดือนปีเกิด</label>
                        <input type="date" id="editResidentBirthdate">
                    </div>
                    <div class="form-group">
                        <label>รหัสผ่านใหม่ (เว้นว่างถ้าไม่ต้องการเปลี่ยน)</label>
                        <input type="password" id="editResidentPassword" placeholder="รหัสผ่านใหม่">
                    </div>
                    <div class="form-group">
                        <label>สถานะบัญชี</label>
                        <select id="editResidentStatus">
                            <option value="active">ใช้งานปกติ</option>
                            <option value="inactive">ระงับการใช้งาน</option>
                        </select>
                    </div>
                    <div class="form-group" style="grid-column: span 2;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.5rem;">
                            <label style="margin:0;">👨‍👩‍👧 ผู้อาศัยร่วม</label>
                            <button type="button" class="btn btn-info" style="font-size:0.8rem; padding:0.3rem 0.75rem;" onclick="addCohabitantRow('editResidentCohabitantList')">➕ เพิ่มผู้อาศัยร่วม</button>
                        </div>
                        <div style="font-size:0.8rem; color:var(--muted); margin-bottom:0.4rem;">คำนำหน้า — ชื่อ — นามสกุล — ความสัมพันธ์ — วันเกิด</div>
                        <div id="editResidentCohabitantList" style="display:flex; flex-direction:column; gap:0.4rem;"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('editResident')">ยกเลิก</button>
                <button class="btn btn-primary" onclick="updateResident()">บันทึก</button>
            </div>
        </div>
    </div>

    <!-- Modal: House Details (View residents in a house) -->
    <div class="modal-overlay" id="modal-houseDetails">
        <div class="modal" style="max-width: 820px;">
            <div class="modal-header">
                <span class="modal-title" id="houseDetailsTitle">🏠 รายละเอียดบ้าน</span>
                <button class="modal-close" onclick="closeModal('houseDetails')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info" style="margin-bottom: 1rem;">
                    <span id="houseDetailsInfo">-- ข้อมูลบ้าน --</span>
                </div>
                
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <strong id="houseResidentsLabel">👥 รายชื่อผู้พักอาศัยในบ้านนี้</strong>
                    <button class="btn btn-primary" id="houseDetailsAddBtn" onclick="addResidentToCurrentHouse()">➕ เพิ่มผู้พักอาศัย</button>
                </div>
                
                <div id="houseResidentsList">
                    <!-- Rendered by JS -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('houseDetails')">ปิด</button>
            </div>
        </div>
    </div>

    <!-- Modal: Move Resident -->
    <div class="modal-overlay" id="modal-moveResident">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">🔀 ย้ายผู้พักอาศัย</span>
                <button class="modal-close" onclick="closeModal('moveResident')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="moveResidentId">
                
                <div class="alert alert-warning" style="margin-bottom: 1rem;">
                    ⚠️ การย้ายผู้พักอาศัยจะเปลี่ยนบ้าน/ห้องที่ผู้พักอาศัยรายนี้อยู่
                </div>
                
                <div id="moveResidentInfo" style="background: var(--hover); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                    <strong>ผู้พักอาศัย:</strong> <span id="moveResidentName">-</span><br>
                    <strong>บ้าน/ห้องเดิม:</strong> <span id="moveResidentOldHouse">-</span>
                </div>
                
                <div class="form-group">
                    <label>ย้ายไปบ้าน/ห้อง <span style="color:#ef4444">*</span></label>
                    <select id="moveResidentNewHouse" required>
                        <option value="">เลือกบ้าน/ห้องใหม่</option>
                        <!-- Will be populated dynamically -->
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('moveResident')">ยกเลิก</button>
                <button class="btn btn-primary" onclick="confirmMoveResident()">ย้ายผู้พักอาศัย</button>
            </div>
        </div>
    </div>

    <script>

        // ============ Data Storage Keys (Fallback localStorage) ============
        const STORAGE_KEYS = {
            housing: 'adminSettings_housing',
            residents: 'residentsData',
            waterSettings: 'adminSettings_water',
            electricSettings: 'adminSettings_electric',
            commonFeeSettings: 'adminSettings_commonFee',
            systemSettings: 'adminSettings_system',
            housingFormat: 'adminSettings_housingFormat',
            permissions: 'adminSettings_permissions',
            exemptions: 'adminSettings_exemptions'
        };

        // Permission types
        const PERMISSION_TYPES = {
            water: { label: 'ผู้บันทึกค่าน้ำ', page: '?page=record-water', icon: '💧' },
            electric: { label: 'ผู้บันทึกค่าไฟ', page: '?page=record-electric', icon: '⚡' },
            notify: { label: 'ผู้แจ้งยอดชำระ', page: '?page=payment-notification', icon: '📢' },
            slip: { label: 'ผู้ตรวจสลิป', page: '?page=check-slip', icon: '🧾' },
            withdraw: { label: 'ผู้เบิกยอดประจำเดือน', page: '?page=monthly-withdraw', icon: '💰' },
            accounting: { label: 'ผู้ทำบัญชี', page: '?page=accounting', icon: '📑' },
            request: { label: 'ผู้ตรวจคำร้อง/ลำดับคิว', page: '?page=check-request', icon: '📋' },
            admin: { label: 'แอดมิน', page: '?page=admin-settings', icon: '🔧' }
        };

        // ========== Tab Functions ==========
        function showTab(tabName, btnEl) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById('tab-' + tabName).classList.add('active');
            var activeBtn = btnEl ? btnEl.closest('.tab-btn') : null;
            if (activeBtn) activeBtn.classList.add('active');
        }

        // ========== Modal Functions ==========
        function openModal(modalName) {
            document.getElementById('modal-' + modalName).classList.add('active');
            
            // Populate house dropdown when opening resident modal
            if (modalName === 'addResident' || modalName === 'editResident') {
                populateHouseDropdown(modalName === 'editResident' ? 'editResidentHouse' : 'residentHouse');
            }
        }

        function closeModal(modalName) {
            document.getElementById('modal-' + modalName).classList.remove('active');
        }

        // Close modal when clicking outside
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.classList.remove('active');
                }
            });
        });

        // ========== Housing Functions ==========
        function getHousingData() {
            const all = JSON.parse(localStorage.getItem(STORAGE_KEYS.housing) || '[]');
            // กรองรายการที่ display_number ไม่ตรงรูปแบบ "บ้าน N" / "แฟลต N" (ลบ duplicate เก่า)
            // ตรวจทั้ง snake_case (จาก backend) และ camelCase (จาก localStorage เก่า)
            const validPattern = /^(บ้าน|แฟลต) \d+$/;
            return all.filter(h => {
                const dn = String(h.display_number || h.displayNumber || '').trim();
                if (!dn) return true; // ไม่มี display_number เลย → คงไว้
                return validPattern.test(dn); // ต้องตรงรูปแบบ "บ้าน N" หรือ "แฟลต N" เท่านั้น
            });
        }

        function saveHousingData(data) {
            localStorage.setItem(STORAGE_KEYS.housing, JSON.stringify(data));
        }

        function renderManageHousingCards() {
            const data = JSON.parse(localStorage.getItem(STORAGE_KEYS.housing) || '[]');
            const residents = getResidentsData();
            const formatSettings = getHousingFormatSettings();
            const searchTerm = (document.getElementById('searchResident').value || '').toLowerCase();

            const grid = document.getElementById('manageHousingGrid');
            const summary = document.getElementById('manageHousingSummary');
            if (!grid) return;

            // Summary stats
            const totalHouses = data.filter(h => h.type === 'house').length;
            const totalFlats = data.filter(h => h.type === 'flat').length;
            const occupied = data.filter(h => {
                const dn = formatHousingNumber(h, formatSettings);
                return residents.some(r => r.house_number === dn);
            }).length;
            const vacant = data.length - occupied;
            if (summary) {
                summary.innerHTML = `
                    <div style="background:#eff6ff; border:1px solid #bfdbfe; border-radius:8px; padding:0.5rem 1rem; font-size:0.85rem;">
                        🏠 บ้านพัก <strong>${totalHouses}</strong> หลัง
                    </div>
                    <div style="background:#f0fdf4; border:1px solid #bbf7d0; border-radius:8px; padding:0.5rem 1rem; font-size:0.85rem;">
                        🏢 แฟลต <strong>${totalFlats}</strong> ห้อง
                    </div>
                    <div style="background:#fef9c3; border:1px solid #fde68a; border-radius:8px; padding:0.5rem 1rem; font-size:0.85rem;">
                        ✅ มีผู้พัก <strong>${occupied}</strong> &nbsp;|&nbsp; ⬜ ว่าง <strong>${vacant}</strong>
                    </div>
                `;
            }

            // Sort: houses first, then flats, by number
            const sorted = [...data].sort((a, b) => {
                if (a.type !== b.type) return a.type === 'house' ? -1 : 1;
                return parseInt(a.number) - parseInt(b.number) || a.number.localeCompare(b.number);
            });

            // Filter by search
            const filtered = sorted.filter(h => {
                if (!searchTerm) return true;
                const dn = formatHousingNumber(h, formatSettings).toLowerCase();
                return dn.includes(searchTerm) || (h.zone || '').toLowerCase().includes(searchTerm) || (h.note || '').toLowerCase().includes(searchTerm);
            });

            const statusColors = {
                available:   { bg: '#f0fdf4', border: '#86efac', dot: '#22c55e', label: 'ว่าง' },
                occupied:    { bg: '#eff6ff', border: '#93c5fd', dot: '#3b82f6', label: 'มีผู้พัก' },
                maintenance: { bg: '#fffbeb', border: '#fcd34d', dot: '#f59e0b', label: 'ซ่อมบำรุง' }
            };

            let html = '';

            filtered.forEach(h => {
                const dn = formatHousingNumber(h, formatSettings);
                const s = statusColors[h.status] || statusColors.available;
                const typeIcon = h.type === 'house' ? '🏠' : '🏢';
                const typeLabel = h.type === 'house' ? 'บ้านพัก' : 'แฟลต';
                const occupants = residents.filter(r => r.house_number === dn);
                const occupantCount = occupants.length;
                const safeId = String(h.id).replace(/'/g, '&apos;');
                const safeDn = dn.replace(/'/g, '&apos;');

                html += `
                <div style="background:${s.bg}; border:1.5px solid ${s.border}; border-radius:12px; padding:1rem; display:flex; flex-direction:column; gap:0.6rem; position:relative; transition:box-shadow 0.2s;"
                     onmouseover="this.style.boxShadow='0 4px 16px rgba(0,0,0,0.10)'"
                     onmouseout="this.style.boxShadow=''">
                    <!-- Header -->
                    <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                        <div>
                            <div style="font-size:1.25rem; font-weight:700; color:var(--primary); line-height:1.2;">${typeIcon} ${dn}</div>
                            <div style="font-size:0.75rem; color:var(--muted); margin-top:0.1rem;">${typeLabel}${h.zone ? ' · ' + h.zone : ''}</div>
                        </div>
                        <div style="display:flex; align-items:center; gap:0.3rem; background:white; border-radius:20px; padding:0.2rem 0.6rem; font-size:0.75rem; border:1px solid ${s.border};">
                            <span style="width:7px;height:7px;border-radius:50%;background:${s.dot};display:inline-block;"></span>
                            ${s.label}
                        </div>
                    </div>

                    <!-- Occupants count -->
                    <div style="display:flex; align-items:center; gap:0.5rem; font-size:0.85rem; color:var(--text);">
                        <span style="font-size:1.1rem;">👥</span>
                        <span><strong>${occupantCount}</strong> คน${occupantCount > 0 ? ': ' + occupants.slice(0,2).map(r=>`${r.firstname||''} ${r.lastname||''}`).join(', ') + (occupantCount > 2 ? '...' : '') : ' (ว่าง)'}</span>
                    </div>

                    ${h.note ? `<div style="font-size:0.78rem; color:var(--muted); background:rgba(255,255,255,0.7); padding:0.3rem 0.5rem; border-radius:6px;">📝 ${h.note}</div>` : ''}

                    <!-- Action buttons -->
                    <div style="display:flex; gap:0.5rem; margin-top:0.2rem; border-top:1px solid ${s.border}; padding-top:0.6rem;">
                        <button class="btn btn-info" style="flex:1; font-size:0.82rem; padding:0.35rem;"
                            onclick="openHouseDetails('${safeDn}')">👁️ ดูผู้พัก</button>
                        <button class="btn btn-primary" style="flex:1; font-size:0.82rem; padding:0.35rem;"
                            onclick="editHousing('${safeId}')">✏️ แก้ไข</button>
                        <button class="btn btn-danger" style="flex:1; font-size:0.82rem; padding:0.35rem;"
                            onclick="deleteHousing('${safeId}')">🗑️ ลบ</button>
                    </div>
                </div>`;
            });

            // "+" Add new card
            html += `
                <div style="border:2px dashed var(--border); border-radius:12px; padding:1rem; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:0.5rem; cursor:pointer; min-height:140px; color:var(--muted); transition:all 0.2s;"
                     onclick="openModal('addHousing')"
                     onmouseover="this.style.borderColor='var(--primary)'; this.style.color='var(--primary)'; this.style.background='#eff6ff';"
                     onmouseout="this.style.borderColor='var(--border)'; this.style.color='var(--muted)'; this.style.background='';">
                    <div style="font-size:2rem; line-height:1;">＋</div>
                    <div style="font-size:0.9rem; font-weight:600;">เพิ่มบ้าน/แฟลต</div>
                </div>`;

            grid.innerHTML = html || `<div style="grid-column:1/-1; text-align:center; color:var(--muted); padding:2rem;">ไม่พบข้อมูลที่ตรงกับการค้นหา</div>`;
        }

        function renderHousingTable() {
            // ใช้ข้อมูลดิบทั้งหมดจาก localStorage ไม่ผ่าน filter regex (admin view)
            const data = JSON.parse(localStorage.getItem(STORAGE_KEYS.housing) || '[]');
            const tbody = document.getElementById('housingTableBody');
            if (!tbody) return;
            const residents = getResidentsData();
            
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="color:var(--muted);">ยังไม่มีข้อมูลบ้านพัก/แฟลต กรุณาเพิ่มข้อมูล</td></tr>';
                return;
            }

            const formatSettings = getHousingFormatSettings();
            
            tbody.innerHTML = data.map((item, index) => {
                const statusBadge = getStatusBadge(item.status);
                const occupant = residents.find(r => r.house_number === item.displayNumber || r.house_number === item.number);
                const occupantName = occupant ? `${occupant.prefix || ''}${occupant.firstname} ${occupant.lastname}` : '-';
                
                return `
                    <tr data-id="${item.id}">
                        <td>${index + 1}</td>
                        <td>${item.type === 'house' ? '🏠 บ้านพัก' : '🏢 แฟลต'}</td>
                        <td><strong>${formatHousingNumber(item, formatSettings)}</strong></td>
                        <td>${item.zone || '-'}</td>
                        <td>${statusBadge}</td>
                        <td>${occupantName}</td>
                        <td>
                            <div class="action-btns">
                                <button class="btn btn-primary" onclick="editHousing('${item.id}')">✏️</button>
                                <button class="btn btn-danger" onclick="deleteHousing('${item.id}')">🗑️</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function formatHousingNumber(item, settings) {
            const prefix = item.type === 'house' ? settings.housePrefix : settings.flatPrefix;
            return prefix + item.number;
        }

        function getStatusBadge(status) {
            switch(status) {
                case 'available': return '<span class="badge badge-success">ว่าง</span>';
                case 'occupied': return '<span class="badge badge-info">มีผู้พักอาศัย</span>';
                case 'maintenance': return '<span class="badge badge-warning">ซ่อมบำรุง</span>';
                default: return '<span class="badge">-</span>';
            }
        }

        function saveHousing() {
            const type = document.getElementById('housingType').value;
            const number = document.getElementById('housingNumber').value.trim();
            const zone = document.getElementById('housingZone').value.trim();
            const status = document.getElementById('housingStatus').value;
            const note = document.getElementById('housingNote').value.trim();

            if (!number) {
                ppkAlert('กรุณากรอกเลขที่/ชื่อ');
                return;
            }

            // Save to Backend first
            if (WEB_APP_URL) {
                callBackend('addHousing', { type, number, zone, status, note }).then(result => {
                    if (result && result.success) {
                        // Add to local cache
                        const data = getHousingData();
                        const formatSettings = getHousingFormatSettings();
                        const prefix = type === 'house' ? formatSettings.housePrefix : formatSettings.flatPrefix;
                        data.push({
                            id: result.id || (data.length > 0 ? Math.max(...data.map(h => typeof h.id === 'number' ? h.id : 0)) + 1 : 1),
                            type, number, displayNumber: prefix + number, zone, status, note,
                            createdAt: new Date().toISOString()
                        });
                        saveHousingData(data);
                        renderHousingTable();
                        renderManageHousingCards();
                        closeModal('addHousing');
                        document.getElementById('housingNumber').value = '';
                        document.getElementById('housingZone').value = '';
                        document.getElementById('housingNote').value = '';
                        ppkAlert('บันทึกข้อมูลเรียบร้อยแล้ว');
                    } else {
                        ppkAlert('เกิดข้อผิดพลาด: ' + (result?.error || 'ไม่ทราบสาเหตุ'));
                    }
                }).catch(err => ppkAlert(err.message));
                return;
            }

            // Fallback: localStorage only
            const data = getHousingData();
            const newId = data.length > 0 ? Math.max(...data.map(h => h.id)) + 1 : 1;
            
            const formatSettings = getHousingFormatSettings();
            const prefix = type === 'house' ? formatSettings.housePrefix : formatSettings.flatPrefix;
            
            data.push({
                id: newId, type, number, displayNumber: prefix + number, zone, status, note,
                createdAt: new Date().toISOString()
            });

            saveHousingData(data);
            renderHousingTable();
            renderManageHousingCards();
            closeModal('addHousing');
            document.getElementById('housingNumber').value = '';
            document.getElementById('housingZone').value = '';
            document.getElementById('housingNote').value = '';
            ppkAlert('บันทึกข้อมูลเรียบร้อยแล้ว');
        }

        function editHousing(id) {
            const data = getHousingData();
            const item = data.find(h => String(h.id) === String(id));
            
            if (!item) return;

            document.getElementById('editHousingId').value = id;
            document.getElementById('editHousingType').value = item.type;
            document.getElementById('editHousingNumber').value = item.number;
            document.getElementById('editHousingZone').value = item.zone || '';
            document.getElementById('editHousingStatus').value = item.status;
            document.getElementById('editHousingNote').value = item.note || '';

            openModal('editHousing');
        }

        function updateHousing() {
            const id = document.getElementById('editHousingId').value;
            const type = document.getElementById('editHousingType').value;
            const number = document.getElementById('editHousingNumber').value.trim();
            const zone = document.getElementById('editHousingZone').value.trim();
            const status = document.getElementById('editHousingStatus').value;
            const note = document.getElementById('editHousingNote').value.trim();

            if (!number) {
                ppkAlert('กรุณากรอกเลขที่/ชื่อ');
                return;
            }

            const formatSettings = getHousingFormatSettings();
            const prefix = type === 'house' ? formatSettings.housePrefix : formatSettings.flatPrefix;
            const updatedItem = { type, number, displayNumber: prefix + number, zone, status, note, updatedAt: new Date().toISOString() };

            // Update via Backend
            if (WEB_APP_URL) {
                callBackend('updateHousing', { id: String(id), ...updatedItem }).then(result => {
                    if (result && result.success) {
                        const data = getHousingData();
                        const index = data.findIndex(h => String(h.id) === String(id));
                        if (index !== -1) { data[index] = { ...data[index], ...updatedItem }; saveHousingData(data); }
                        renderHousingTable();
                        renderManageHousingCards();
                        closeModal('editHousing');
                        ppkAlert('อัปเดตข้อมูลเรียบร้อยแล้ว');
                    } else {
                        ppkAlert('เกิดข้อผิดพลาด: ' + (result?.error || 'ไม่ทราบสาเหตุ'));
                    }
                }).catch(err => ppkAlert(err.message));
                return;
            }

            const data = getHousingData();
            const index = data.findIndex(h => h.id === id);
            if (index === -1) return;
            data[index] = { ...data[index], ...updatedItem };
            saveHousingData(data);
            renderHousingTable();
            renderManageHousingCards();
            closeModal('editHousing');
            ppkAlert('อัปเดตข้อมูลเรียบร้อยแล้ว');
        }

        async function deleteHousingFromCard(id, displayName) {
            const residents = getResidentsData();
            const residentCount = residents.filter(r => r.house_number === displayName).length;
            const residentWarning = residentCount > 0
                ? `\n⚠️ มีผู้พักอาศัย ${residentCount} คน (บุคลากรจะไม่มีบ้านพัก)`
                : '';
            const msg = `ต้องการลบ "${displayName}" หรือไม่?${residentWarning}\nการดำเนินการนี้ไม่สามารถยกเลิกได้`;
            if (!await ppkConfirm(msg)) return;

            if (WEB_APP_URL) {
                callBackend('deleteHousing', { id: String(id) }).then(result => {
                    if (result && result.success) {
                        const data = getHousingData();
                        saveHousingData(data.filter(h => String(h.id) !== String(id)));
                        renderManageHousingCards(); renderHouseCards();
                        ;
                        ppkAlert(`ลบ "${displayName}" เรียบร้อยแล้ว`);
                    } else {
                        ppkAlert('เกิดข้อผิดพลาด: ' + (result?.error || 'ไม่ทราบสาเหตุ'));
                    }
                }).catch(err => ppkAlert(err.message));
                return;
            }

            const data = getHousingData();
            saveHousingData(data.filter(h => String(h.id) !== String(id)));
            renderManageHousingCards(); renderHouseCards();
            ;
            ppkAlert(`ลบ "${displayName}" เรียบร้อยแล้ว`);
        }

        async function deleteHousing(id) {
            if (!await ppkConfirm('คุณต้องการลบข้อมูลนี้หรือไม่? การดำเนินการนี้ไม่สามารถยกเลิกได้')) {
                return;
            }

            // Delete from Backend
            if (WEB_APP_URL) {
                callBackend('deleteHousing', { id: String(id) }).then(result => {
                    if (result && result.success) {
                        const data = getHousingData();
                        const newData = data.filter(h => h.id !== id && String(h.id) !== String(id));
                        saveHousingData(newData);
                        renderManageHousingCards(); renderHouseCards();
                        ;
                        ppkAlert('ลบข้อมูลเรียบร้อยแล้ว');
                    } else {
                        ppkAlert('เกิดข้อผิดพลาด: ' + (result?.error || 'ไม่ทราบสาเหตุ'));
                    }
                }).catch(err => ppkAlert(err.message));
                return;
            }

            const data = getHousingData();
            const newData = data.filter(h => h.id !== id);
            saveHousingData(newData);
            renderManageHousingCards(); renderHouseCards();
            ;
            ppkAlert('ลบข้อมูลเรียบร้อยแล้ว');
        }

        function filterHousingTable() {
            // ถ้าอยู่ใน manageHousing mode ให้ re-render cards (search อยู่ใน renderManageHousingCards แล้ว)
            if (currentResidentViewMode === 'manageHousing') {
                renderManageHousingCards();
                return;
            }
            const el = document.getElementById('searchHousing') || document.getElementById('searchResident');
            const searchTerm = el ? el.value.toLowerCase() : '';
            const rows = document.querySelectorAll('#housingTableBody tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        function getHousingFormatSettings() {
            return JSON.parse(localStorage.getItem(STORAGE_KEYS.housingFormat) || JSON.stringify({
                houseFormat: 'prefix-number',
                housePrefix: 'บ้าน ',
                flatFormat: 'prefix-number',
                flatPrefix: 'ห้อง '
            }));
        }

        function saveHousingFormat() {
            const settings = {
                houseFormat: document.getElementById('houseNumberFormat').value,
                housePrefix: document.getElementById('housePrefix').value,
                flatFormat: document.getElementById('flatNumberFormat').value,
                flatPrefix: document.getElementById('flatPrefix').value
            };
            
            // Save to Backend
            if (WEB_APP_URL) {
                callBackend('saveHousingFormat', settings).then(result => {
                    if (result && result.success) {
                        // Also update settings keys
                        callBackend('updateSettings', {
                            house_prefix: settings.housePrefix,
                            flat_prefix: settings.flatPrefix,
                            house_number_format: settings.houseFormat === 'custom' ? settings.housePrefix + ' {number}' : '{prefix} {number}',
                            flat_number_format: settings.flatFormat === 'custom' ? settings.flatPrefix + ' {number}' : '{prefix} {number}'
                        });
                        ppkAlert('บันทึกรูปแบบเลขที่บ้านพัก/แฟลตเรียบร้อยแล้ว');
                    } else {
                        ppkAlert('เกิดข้อผิดพลาด: ' + (result?.error || 'ไม่ทราบสาเหตุ'));
                    }
                }).catch(err => ppkAlert(err.message));
            } else {
                ppkAlert('บันทึกรูปแบบเลขที่บ้านพัก/แฟลตเรียบร้อยแล้ว (localStorage)');
            }
            
            localStorage.setItem(STORAGE_KEYS.housingFormat, JSON.stringify(settings));
            
            // Update all housing display numbers
            const data = getHousingData();
            data.forEach(item => {
                const prefix = item.type === 'house' ? settings.housePrefix : settings.flatPrefix;
                item.displayNumber = prefix + item.number;
            });
            saveHousingData(data);
            renderHousingTable();
            renderManageHousingCards();
        }

        // ========== Resident Functions ==========
        function getResidentsData() {
            return JSON.parse(localStorage.getItem(STORAGE_KEYS.residents) || '[]');
        }

        function saveResidentsData(data) {
            localStorage.setItem(STORAGE_KEYS.residents, JSON.stringify(data));
        }

        function populateHouseDropdown(selectId) {
            const select = document.getElementById(selectId);
            const housing = getHousingData();
            const formatSettings = getHousingFormatSettings();
            
            select.innerHTML = '<option value="">เลือกบ้าน/ห้อง</option>';
            
            housing.forEach(h => {
                const displayName = formatHousingNumber(h, formatSettings);
                const statusText = h.status === 'available' ? ' (ว่าง)' : h.status === 'maintenance' ? ' (ซ่อมบำรุง)' : '';
                select.innerHTML += `<option value="${displayName}">${displayName}${statusText}</option>`;
            });
        }

        function renderResidentTable() {
            const data = getResidentsData();
            const tbody = document.getElementById('residentTableBody');
            
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="color:var(--muted);">ยังไม่มีข้อมูลผู้พักอาศัย กรุณาเพิ่มข้อมูล</td></tr>';
                return;
            }

            tbody.innerHTML = data.map((item, index) => {
                const fullName = `${item.prefix || ''}${item.firstname || ''} ${item.lastname || ''}`;
                const statusBadge = item.status === 'inactive' 
                    ? '<span class="badge badge-danger">ระงับ</span>' 
                    : '<span class="badge badge-success">ปกติ</span>';
                
                // Resident type badge
                const isStaff = item.residentType !== 'cohabitant';
                const typeBadge = isStaff 
                    ? '<span class="badge badge-success">👨‍🏫 บุคลากร</span>'
                    : '<span class="badge badge-warning">👤 ผู้ร่วมพัก</span>';
                
                // แสดงรายชื่อผู้ร่วมพักอาศัย
                const cohabitantList = parseCohabitantNames(item.cohabitantNames);
                const cohabitantHtml = cohabitantList.length > 0
                    ? `<div style="margin-top:0.3rem;">${cohabitantList.map(cn =>
                        `<div style="font-size:0.78rem; color:var(--muted); padding-left:0.8rem;">↳ ${cn}</div>`
                      ).join('')}</div>`
                    : '';

                return `
                    <tr data-id="${item.id}">
                        <td>${index + 1}</td>
                        <td style="text-align:left;">
                            <div style="font-weight:600;">${fullName}</div>
                            ${cohabitantHtml}
                        </td>
                        <td><strong>${item.house_number || '-'}</strong></td>
                        <td>${typeBadge}</td>
                        <td>${item.position || '-'}</td>
                        <td>${item.phone || '-'}</td>
                        <td>${statusBadge}</td>
                        <td>
                            <div class="action-btns">
                                <button class="btn btn-primary" onclick="editResident('${item.id}')">✏️</button>
                                <button class="btn btn-danger" onclick="deleteResident('${item.id}')">🗑️</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // ========== Resident View Mode Functions ==========
        let currentResidentViewMode = 'byHouse';
        let currentHouseForDetails = null;

        function setResidentViewMode(mode) {
            currentResidentViewMode = mode;

            const modes = ['byHouse', 'individual', 'manageHousing'];
            const btnIds = { byHouse: 'viewModeByHouse', individual: 'viewModeIndividual', manageHousing: 'viewModeManageHousing' };
            const viewIds = { byHouse: 'residentViewByHouse', individual: 'residentViewIndividual', manageHousing: 'residentViewManageHousing' };

            modes.forEach(m => {
                const btn = document.getElementById(btnIds[m]);
                const view = document.getElementById(viewIds[m]);
                if (btn) { btn.style.background = m === mode ? 'var(--primary)' : ''; btn.style.color = m === mode ? '#fff' : ''; }
                if (view) view.style.display = m === mode ? 'block' : 'none';
            });

            if (mode === 'byHouse') renderHouseCards();
            else if (mode === 'individual') renderResidentTable();
            else if (mode === 'manageHousing') {
                renderManageHousingCards();
                if (WEB_APP_URL) {
                    callBackendGet('getHousing').then(result => {
                        if (result && result.success && result.data) {
                            const housingData = result.data.map((h, i) => ({
                                id: h.id || (i + 1), type: h.type || 'house', number: h.number || '',
                                displayNumber: h.display_number || '', zone: h.zone || '',
                                status: h.status || 'available', note: h.note || ''
                            }));
                            localStorage.setItem(STORAGE_KEYS.housing, JSON.stringify(housingData));
                            renderManageHousingCards();
                        }
                    }).catch(() => {});
                }
            }
        }

        // Helper: parse cohabitant_names JSON array safely (supports both old string[] and new object[])
        function parseCohabitantNames(namesJson) {
            try {
                const arr = JSON.parse(namesJson || '[]');
                if (!Array.isArray(arr)) return [];
                return arr.map(item => {
                    if (typeof item === 'string') return item; // old format
                    // new format: {prefix, firstname, lastname, relationship, birthdate}
                    const name = `${item.prefix||''} ${item.firstname||''} ${item.lastname||''}`.trim();
                    const rel = item.relationship ? ` (${item.relationship})` : '';
                    return name + rel;
                }).filter(Boolean);
            } catch(e) { return []; }
        }

        // Add a cohabitant row to a container
        function addCohabitantRow(containerId, data = {}) {
            const container = document.getElementById(containerId);
            if (!container) return;
            const row = document.createElement('div');
            row.className = 'cohabitant-row';
            row.style.cssText = 'display:grid; grid-template-columns:90px 1fr 1fr 100px 130px 34px; gap:0.35rem; align-items:center; background:var(--bg); padding:0.5rem; border-radius:8px; border:1px solid var(--border);';
            const prefixOptions = ['นาย','นาง','นางสาว','เด็กชาย','เด็กหญิง','ด.ช.','ด.ญ.'];
            const relOptions = ['คู่สมรส','บุตร','บิดา','มารดา','พี่น้อง','ปู่','ย่า','ตา','ยาย','บุคลากรโรงเรียนพะเยาพิทยาคม','อื่นๆ'];
            const makePrefixOptions = (sel) => prefixOptions.map(o => `<option value="${o}" ${sel===o?'selected':''}>${o}</option>`).join('');
            const makeRelOptions = (sel) => relOptions.map(o => `<option value="${o}" ${sel===o?'selected':''}>${o}</option>`).join('');
            const bd = data.birthdate || '';
            row.innerHTML = `
                <select class="c-prefix" style="font-size:0.82rem; padding:0.35rem 0.2rem; border:1px solid var(--border); border-radius:6px; width:100%;">${makePrefixOptions(data.prefix||'')}</select>
                <input class="c-firstname" type="text" value="${data.firstname||''}" placeholder="\u0e0a\u0e37\u0e48\u0e2d" style="font-size:0.82rem; padding:0.35rem; border:1px solid var(--border); border-radius:6px; width:100%;">
                <input class="c-lastname" type="text" value="${data.lastname||''}" placeholder="\u0e19\u0e32\u0e21\u0e2a\u0e01\u0e38\u0e25" style="font-size:0.82rem; padding:0.35rem; border:1px solid var(--border); border-radius:6px; width:100%;">
                <select class="c-relationship" style="font-size:0.82rem; padding:0.35rem 0.2rem; border:1px solid var(--border); border-radius:6px; width:100%;">${makeRelOptions(data.relationship||'')}</select>
                <input class="c-birthdate" type="date" value="${bd}" title="\u0e27\u0e31\u0e19\u0e40\u0e01\u0e34\u0e14" style="font-size:0.82rem; padding:0.35rem; border:1px solid var(--border); border-radius:6px; width:100%;">
                <button type="button" onclick="this.closest('.cohabitant-row').remove()" style="background:#ef4444; color:#fff; border:none; border-radius:6px; padding:0.35rem 0.5rem; cursor:pointer; font-size:0.85rem;">🗑️</button>
            `;
            container.appendChild(row);
        }

        // Collect structured cohabitants from container
        function getCohabitantsFromContainer(containerId) {
            const rows = document.querySelectorAll(`#${containerId} .cohabitant-row`);
            const result = [];
            rows.forEach(row => {
                const prefix = (row.querySelector('.c-prefix')?.value || '').trim();
                const firstname = (row.querySelector('.c-firstname')?.value || '').trim();
                const lastname = (row.querySelector('.c-lastname')?.value || '').trim();
                const relationship = (row.querySelector('.c-relationship')?.value || '').trim();
                const birthdate = (row.querySelector('.c-birthdate')?.value || '').trim();
                if (firstname) result.push({ prefix, firstname, lastname, relationship, birthdate });
            });
            return result;
        }

        // Populate cohabitant container from JSON string (old or new format)
        function populateCohabitantContainer(containerId, namesJson) {
            const container = document.getElementById(containerId);
            if (!container) return;
            container.innerHTML = '';
            try {
                const arr = JSON.parse(namesJson || '[]');
                if (!Array.isArray(arr)) return;
                arr.forEach(item => {
                    if (typeof item === 'string') {
                        // Parse old format: "นายรังสรรค์ บุญฮุย (คู่สมรส)"
                        const relMatch = item.match(/\(([^)]+)\)$/);
                        const rel = relMatch ? relMatch[1] : '';
                        const namePart = relMatch ? item.slice(0, relMatch.index).trim() : item.trim();
                        const prefixList = ['นาย','นาง','นางสาว','เด็กชาย','เด็กหญิง','ด.ช.','ด.ญ.'];
                        let prefix = '', rest = namePart;
                        for (const p of prefixList) {
                            if (namePart.startsWith(p)) { prefix = p; rest = namePart.slice(p.length).trim(); break; }
                        }
                        const parts = rest.split(' ');
                        addCohabitantRow(containerId, { prefix, firstname: parts[0]||'', lastname: parts.slice(1).join(' '), relationship: rel, birthdate: '' });
                    } else {
                        addCohabitantRow(containerId, item);
                    }
                });
            } catch(e) {}
        }

        function renderHouseCards() {
            const residents = getResidentsData();
            const housing = getHousingData();
            const formatSettings = getHousingFormatSettings();
            const container = document.getElementById('houseCardsContainer');

            // Group residents by house
            const houseGroups = {};

            housing.forEach(h => {
                const displayNumber = formatHousingNumber(h, formatSettings);
                houseGroups[displayNumber] = { houseInfo: h, residents: [], displayNumber };
            });

            residents.forEach(r => {
                const houseNumber = r.house_number || '';
                if (houseNumber) {
                    if (!houseGroups[houseNumber]) {
                        houseGroups[houseNumber] = { houseInfo: null, residents: [], displayNumber: houseNumber };
                    }
                    houseGroups[houseNumber].residents.push(r);
                }
            });

            const noHouseResidents = residents.filter(r => !r.house_number);
            if (noHouseResidents.length > 0) {
                houseGroups['(ไม่ระบุบ้าน)'] = { houseInfo: null, residents: noHouseResidents, displayNumber: '(ไม่ระบุบ้าน)' };
            }

            const searchTerm = document.getElementById('searchResident').value.toLowerCase();

            let html = '';
            // เรียงลำดับตัวเลข: บ้าน 1,2,3...10,11,12 แล้วตามด้วย แฟลต 1,2,...
            Object.keys(houseGroups).sort((a, b) => {
                const typeOrder = s => s.startsWith('บ้าน') ? 0 : s.startsWith('แฟลต') ? 1 : 2;
                const getNum = s => parseInt((s.match(/\d+/) || ['0'])[0]);
                if (typeOrder(a) !== typeOrder(b)) return typeOrder(a) - typeOrder(b);
                return getNum(a) - getNum(b);
            }).forEach(houseKey => {
                const group = houseGroups[houseKey];

                // Build full occupant list: staff rows + cohabitant_names JSON from each staff
                const allOccupants = []; // { name, isCohabitant }
                group.residents.forEach(r => {
                    const fullName = `${r.prefix||''}${r.firstname||''} ${r.lastname||''}`.trim();
                    allOccupants.push({ name: fullName, isCohabitant: r.residentType === 'cohabitant' });
                    parseCohabitantNames(r.cohabitantNames).forEach(cn => {
                        allOccupants.push({ name: cn, isCohabitant: true });
                    });
                });

                const totalCount = allOccupants.length;
                const staffCount = group.residents.filter(r => r.residentType !== 'cohabitant').length;
                const cohabitantCount = totalCount - staffCount;

                // Filter by search (including cohabitant names)
                if (searchTerm) {
                    const matchesSearch = group.displayNumber.toLowerCase().includes(searchTerm) ||
                        allOccupants.some(o => o.name.toLowerCase().includes(searchTerm)) ||
                        group.residents.some(r => (r.email||'').toLowerCase().includes(searchTerm));
                    if (!matchesSearch) return;
                }

                const houseType = group.houseInfo ? (group.houseInfo.type === 'house' ? '🏠 บ้านพัก' : '🏢 แฟลต') : '📍';
                const statusColor = totalCount > 0 ? 'var(--success)' : 'var(--muted)';

                // Preview: main resident bold, cohabitants indented (up to 4 entries)
                const previewItems = allOccupants.slice(0, 4);
                const moreCount = allOccupants.length > 4 ? allOccupants.length - 4 : 0;
                const previewHtml = previewItems.map(o =>
                    o.isCohabitant
                        ? `<div style="color:var(--muted); padding-left:1rem;">↳ ${o.name}</div>`
                        : `<div style="font-weight:600;">${o.name}</div>`
                ).join('');

                html += `
                    <div class="settings-card" style="cursor:pointer; transition:transform 0.2s, box-shadow 0.2s;"
                         onclick="openHouseDetails('${houseKey.replace(/'/g, "&apos;")}')"
                         onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(0,0,0,0.12)';"
                         onmouseout="this.style.transform=''; this.style.boxShadow='';">
                        <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                            <div style="flex:1; min-width:0;">
                                <div style="font-size:1.1rem; font-weight:700; color:var(--primary);">${houseType} ${group.displayNumber}</div>
                                <div style="font-size:0.8rem; color:var(--muted); margin-top:0.15rem;">${group.houseInfo?.zone || ''}</div>
                            </div>
                            <div style="display:flex; flex-direction:column; align-items:flex-end; gap:0.4rem; flex-shrink:0;">
                                <div style="text-align:right;">
                                    <div style="font-size:1.5rem; font-weight:700; color:${statusColor};">${totalCount}</div>
                                    <div style="font-size:0.75rem; color:var(--muted);">ผู้อาศัยรวม</div>
                                </div>
                                ${group.houseInfo ? `<button class="btn btn-danger" style="padding:0.2rem 0.6rem; font-size:0.75rem; line-height:1.4;" onclick="event.stopPropagation(); deleteHousingFromCard('${group.houseInfo.id}', '${group.displayNumber.replace(/'/g, "&apos;")}')">🗑️ ลบ</button>` : ''}
                            </div>
                        </div>
                        ${totalCount > 0 ? `
                            <div style="margin-top:0.75rem; padding-top:0.75rem; border-top:1px solid var(--border);">
                                <div style="font-size:0.85rem; line-height:1.8;">
                                    ${previewHtml}
                                    ${moreCount > 0 ? `<div style="color:var(--muted); font-size:0.8rem;">และอีก ${moreCount} คน...</div>` : ''}
                                </div>
                                <div style="display:flex; gap:0.5rem; margin-top:0.6rem; flex-wrap:wrap; align-items:center;">
                                    ${staffCount > 0 ? `<span class="badge badge-success">👨‍🏫 ${staffCount} บุคลากร</span>` : ''}
                                    ${cohabitantCount > 0 ? `<span class="badge badge-warning">👪 ${cohabitantCount} ผู้ร่วมพัก</span>` : ''}
                                    <span style="font-size:0.75rem; color:var(--primary); margin-left:auto;">คลิกดูรายละเอียด →</span>
                                </div>
                            </div>
                        ` : `
                            <div style="margin-top:0.75rem; padding-top:0.75rem; border-top:1px solid var(--border); color:var(--muted); font-size:0.85rem;">
                                ว่าง - ไม่มีผู้พักอาศัย
                            </div>
                        `}
                    </div>
                `;
            });

            if (html === '') {
                html = '<div style="grid-column:1/-1; text-align:center; color:var(--muted); padding:2rem;">ไม่พบข้อมูลบ้าน/ห้องที่ตรงกับการค้นหา</div>';
            }

            container.innerHTML = html;
        }

        function openHouseDetails(houseNumber) {
            currentHouseForDetails = houseNumber;
            const residents = getResidentsData();
            const housing = getHousingData();
            const formatSettings = getHousingFormatSettings();

            const isUnassigned = houseNumber === '(ไม่ระบุบ้าน)';
            const houseInfo = housing.find(h => formatHousingNumber(h, formatSettings) === houseNumber);
            const houseResidents = isUnassigned
                ? residents.filter(r => !r.house_number)
                : residents.filter(r => r.house_number === houseNumber);

            const typeEmoji = isUnassigned ? '📍' : houseInfo ? (houseInfo.type === 'house' ? '🏠' : '🏢') : '📍';
            document.getElementById('houseDetailsTitle').textContent = isUnassigned
                ? '📍 ผู้พักอาศัยที่ยังไม่ได้รับมอบหมายบ้าน'
                : `${typeEmoji} รายละเอียด ${houseNumber}`;

            // แสดง/ซ่อนปุ่มเพิ่มผู้พักอาศัย
            const addBtn = document.getElementById('houseDetailsAddBtn');
            if (addBtn) addBtn.style.display = isUnassigned ? 'none' : '';

            // อัปเดต label
            const labelEl = document.getElementById('houseResidentsLabel');
            if (labelEl) labelEl.innerHTML = isUnassigned
                ? '👥 รายชื่อผู้พักอาศัยที่ยังไม่มีบ้าน <span style="font-size:0.82rem;color:var(--primary);font-weight:400;">(กดปุ่ม 🔀 เพื่อย้ายลงบ้าน)</span>'
                : '👥 รายชื่อผู้พักอาศัยในบ้านนี้';

            // Count cohabitants from JSON fields
            let totalCohabitantsFromJson = 0;
            houseResidents.forEach(r => {
                totalCohabitantsFromJson += parseCohabitantNames(r.cohabitantNames).length;
            });
            const totalOccupants = houseResidents.length + totalCohabitantsFromJson;

            const infoHtml = `
                <strong>บ้าน/ห้อง:</strong> ${houseNumber} &nbsp;|&nbsp;
                <strong>บุคลากร:</strong> ${houseResidents.length} คน &nbsp;|&nbsp;
                <strong>ผู้ร่วมพัก:</strong> ${totalCohabitantsFromJson} คน &nbsp;|&nbsp;
                <strong>รวมทั้งหมด:</strong> ${totalOccupants} คน
                ${houseInfo?.zone ? ` &nbsp;|&nbsp; <strong>โซน:</strong> ${houseInfo.zone}` : ''}
            `;
            document.getElementById('houseDetailsInfo').innerHTML = infoHtml;

            const container = document.getElementById('houseResidentsList');

            if (houseResidents.length === 0) {
                const emptyMsg = isUnassigned
                    ? '🎉 ทุกคนมีบ้านพักแล้ว ไม่มีผู้พักอาศัยที่รอมอบหมาย'
                    : 'ยังไม่มีผู้พักอาศัยในบ้าน/ห้องนี้';
                container.innerHTML = `<div style="text-align:center; color:var(--muted); padding:2rem 1rem;">${emptyMsg}</div>`;
            } else {
                container.innerHTML = houseResidents.map((r, idx) => {
                    const fullName = `${r.prefix||''}${r.firstname||''} ${r.lastname||''}`.trim();
                    const isStaff = r.residentType !== 'cohabitant';
                    const typeBadge = isStaff
                        ? '<span class="badge badge-success">👨‍🏫 บุคลากร</span>'
                        : '<span class="badge badge-warning">👤 ผู้ร่วมพัก</span>';
                    const statusBadge = (r.status === 'inactive' || r.status === 'suspended')
                        ? '<span class="badge badge-danger">ระงับ</span>'
                        : '<span class="badge badge-success">ปกติ</span>';

                    const cohabitantList = parseCohabitantNames(r.cohabitantNames);
                    const cohabitantsHtml = cohabitantList.length > 0 ? `
                        <div style="margin-top:0.75rem; padding:0.6rem 0.85rem; background:var(--hover); border-radius:6px; border-left:3px solid var(--warning);">
                            <div style="font-size:0.78rem; font-weight:700; color:var(--muted); text-transform:uppercase; letter-spacing:0.03em; margin-bottom:0.4rem;">👪 ผู้ร่วมพักอาศัย (${cohabitantList.length} คน)</div>
                            ${cohabitantList.map((cn, ci) => `
                                <div style="font-size:0.87rem; padding:0.2rem 0; display:flex; align-items:center; gap:0.4rem;">
                                    <span style="color:var(--muted); min-width:1.2rem;">${ci + 1}.</span>
                                    <span>${cn}</span>
                                </div>
                            `).join('')}
                        </div>
                    ` : '';

                    const safeId = String(r.id).replace(/'/g, "&apos;");
                    return `
                        <div style="border:1px solid var(--border); border-radius:8px; padding:1rem; margin-bottom:0.75rem;">
                            <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:0.75rem;">
                                <div style="flex:1; min-width:0;">
                                    <div style="display:flex; gap:0.5rem; align-items:center; flex-wrap:wrap; margin-bottom:0.4rem;">
                                        <span style="font-size:1rem; font-weight:700;">${idx + 1}. ${fullName}</span>
                                        ${typeBadge}
                                        ${statusBadge}
                                    </div>
                                    <div style="font-size:0.83rem; color:var(--muted); display:flex; flex-wrap:wrap; gap:0.75rem; margin-top:0.25rem;">
                                        ${r.position ? `<span>💼 ${r.position}</span>` : ''}
                                        ${r.subject_group ? `<span>📚 ${r.subject_group}</span>` : ''}
                                        ${r.phone ? `<span>📞 <a href="tel:${r.phone}" style="color:inherit;">${r.phone}</a></span>` : ''}
                                        ${r.email ? `<span>✉️ <a href="mailto:${r.email}" style="color:inherit;">${r.email}</a></span>` : ''}
                                    </div>
                                </div>
                                <div class="action-btns" style="flex-shrink:0;">
                                    <button class="btn btn-info" onclick="openMoveResidentModal('${safeId}')" title="ย้ายบ้าน">🔀</button>
                                    <button class="btn btn-primary" onclick="closeModal('houseDetails'); editResident('${safeId}');" title="แก้ไข">✏️</button>
                                    <button class="btn btn-danger" onclick="deleteResidentFromHouse('${safeId}')" title="ลบ">🗑️</button>
                                </div>
                            </div>
                            ${cohabitantsHtml}
                        </div>
                    `;
                }).join('');
            }

            openModal('houseDetails');
        }

        function addResidentToCurrentHouse() {
            closeModal('houseDetails');
            openModal('addResident');
            
            // Pre-select the current house
            setTimeout(() => {
                const select = document.getElementById('residentHouse');
                if (select && currentHouseForDetails && currentHouseForDetails !== '(ไม่ระบุบ้าน)') {
                    for (let option of select.options) {
                        if (option.value === currentHouseForDetails || option.value.includes(currentHouseForDetails)) {
                            select.value = option.value;
                            break;
                        }
                    }
                }
            }, 100);
        }

        function openMoveResidentModal(residentId) {
            const residents = getResidentsData();
            const housing = getHousingData();
            const formatSettings = getHousingFormatSettings();
            
            const resident = residents.find(r => r.id === residentId);
            if (!resident) {
                ppkAlert('ไม่พบข้อมูลผู้พักอาศัย');
                return;
            }
            
            // Set data
            document.getElementById('moveResidentId').value = residentId;
            document.getElementById('moveResidentName').textContent = 
                `${resident.prefix || ''}${resident.firstname || ''} ${resident.lastname || ''}`;
            document.getElementById('moveResidentOldHouse').textContent = resident.house_number || '-';
            
            // Populate house dropdown (excluding current house)
            const select = document.getElementById('moveResidentNewHouse');
            select.innerHTML = '<option value="">เลือกบ้าน/ห้องใหม่</option>';
            
            housing.forEach(h => {
                const displayName = formatHousingNumber(h, formatSettings);
                if (displayName !== resident.house_number) {
                    select.innerHTML += `<option value="${displayName}">${displayName}</option>`;
                }
            });
            
            closeModal('houseDetails');
            openModal('moveResident');
        }

        function confirmMoveResident() {
            const residentId = parseInt(document.getElementById('moveResidentId').value);
            const newHouse = document.getElementById('moveResidentNewHouse').value;
            
            if (!newHouse) {
                ppkAlert('กรุณาเลือกบ้าน/ห้องใหม่');
                return;
            }
            
            const data = getResidentsData();
            const index = data.findIndex(r => r.id === residentId);
            
            if (index === -1) {
                ppkAlert('ไม่พบข้อมูลผู้พักอาศัย');
                return;
            }
            
            const oldHouse = data[index].house_number;
            data[index].house_number = newHouse;

            // Sync move to Backend
            if (WEB_APP_URL) {
                callBackend('updateResident', { id: String(residentId), house_number: newHouse }).catch(err => console.warn(err));
            }
            
            saveResidentsData(data);
            closeModal('moveResident');
            
            ppkAlert(`ย้ายผู้พักอาศัยจาก "${oldHouse}" ไป "${newHouse}" เรียบร้อยแล้ว`);
            
            renderHouseCards();
            renderResidentTable();
            
            if (currentHouseForDetails) {
                openHouseDetails(currentHouseForDetails);
            }
        }

        async function deleteResidentFromHouse(residentId) {
            if (!await ppkConfirm('คุณแน่ใจหรือไม่ว่าต้องการลบผู้พักอาศัยรายนี้?')) {
                return;
            }

            // Delete from Backend
            if (WEB_APP_URL) {
                callBackend('removeResident', { id: String(residentId) }).catch(err => console.warn(err));
            }
            
            const data = getResidentsData();
            const index = data.findIndex(r => r.id === residentId || String(r.id) === String(residentId));
            
            if (index !== -1) {
                data.splice(index, 1);
                saveResidentsData(data);
                openHouseDetails(currentHouseForDetails);
                renderHouseCards();
                renderResidentTable();
            }
        }

        function filterResidentView() {
            if (currentResidentViewMode === 'byHouse') {
                renderHouseCards();
            } else {
                filterResidentTable();
            }
        }

        function saveResident() {
            const residentType = document.getElementById('residentType').value;
            const prefix = document.getElementById('residentPrefix').value;
            const firstName = document.getElementById('residentFirstName').value.trim();
            const lastName = document.getElementById('residentLastName').value.trim();
            const position = document.getElementById('residentPosition').value;
            const subject_group = document.getElementById('residentSubjectGroup').value;
            const phone = document.getElementById('residentPhone').value.trim();
            const house = document.getElementById('residentHouse').value;
            const email = document.getElementById('residentEmail').value.trim();
            const birthdate = document.getElementById('residentBirthdate').value;
            const password = document.getElementById('residentPassword').value;
            const cohabitantList = getCohabitantsFromContainer('residentCohabitantList');
            const cohabitantNames = JSON.stringify(cohabitantList);
            const cohabitants = cohabitantList.length;

            if (!firstName || !lastName) {
                ppkAlert('กรุณากรอกชื่อและนามสกุล');
                return;
            }

            if (email && !/^\S+@\S+\.\S+$/.test(email)) {
                ppkAlert('กรุณากรอกอีเมลให้ถูกต้อง');
                return;
            }

            if (password && password.length < 8) {
                ppkAlert('รหัสผ่านต้องมีอย่างน้อย 8 ตัวอักษร');
                return;
            }

            const data = getResidentsData();
            const newId = data.length > 0 ? Math.max(...data.map(r => r.id || 0)) + 1 : 1;

            data.push({
                id: newId,
                residentType,
                prefix,
                firstname: firstName,
                lastname: lastName,
                resident: `${prefix}${firstName} ${lastName}`,
                position,
                subject_group,
                phone,
                house_number: house,
                email,
                birthdate,
                password: password ? btoa(password) : '',
                cohabitants,
                cohabitantNames,
                status: 'active',
                createdAt: new Date().toISOString()
            });

            const clearAddForm = () => {
                document.getElementById('residentType').value = 'staff';
                document.getElementById('residentPrefix').value = '';
                document.getElementById('residentFirstName').value = '';
                document.getElementById('residentLastName').value = '';
                document.getElementById('residentPosition').value = '';
                document.getElementById('residentSubjectGroup').value = '';
                document.getElementById('residentPhone').value = '';
                document.getElementById('residentHouse').value = '';
                document.getElementById('residentEmail').value = '';
                document.getElementById('residentBirthdate').value = '';
                document.getElementById('residentPassword').value = '';
                document.getElementById('residentCohabitantList').innerHTML = '';
            };

            const newResident = data[data.length - 1]; // just pushed

            // Save to Backend
            if (WEB_APP_URL) {
                callBackend('addResident', newResident).then(result => {
                    if (result && result.success) {
                        saveResidentsData(data);
                        renderResidentTable();
                        renderHouseCards();
                        closeModal('addResident');
                        clearAddForm();
                        ppkAlert('บันทึกข้อมูลผู้พักอาศัยเรียบร้อยแล้ว');
                    } else {
                        data.pop(); // revert
                        ppkAlert('เกิดข้อผิดพลาด: ' + (result?.error || 'ไม่ทราบสาเหตุ'));
                    }
                }).catch(err => { data.pop(); ppkAlert(err.message); });
                return;
            }

            saveResidentsData(data);
            renderResidentTable();
            renderHouseCards();
            closeModal('addResident');
            clearAddForm();
            ppkAlert('บันทึกข้อมูลผู้พักอาศัยเรียบร้อยแล้ว');
        }

        function editResident(id) {
            const data = getResidentsData();
            const item = data.find(r => String(r.id) === String(id));
            
            if (!item) return;

            document.getElementById('editResidentId').value = id;
            document.getElementById('editResidentType').value = item.residentType || 'staff';
            document.getElementById('editResidentPrefix').value = item.prefix || '';
            document.getElementById('editResidentFirstName').value = item.firstname || '';
            document.getElementById('editResidentLastName').value = item.lastname || '';
            document.getElementById('editResidentPosition').value = item.position || '';
            document.getElementById('editResidentSubjectGroup').value = item.subject_group || '';
            document.getElementById('editResidentPhone').value = item.phone || '';
            document.getElementById('editResidentEmail').value = item.email || '';
            document.getElementById('editResidentBirthdate').value = item.birthdate || '';
            document.getElementById('editResidentPassword').value = '';
            document.getElementById('editResidentStatus').value = item.status || 'active';
            populateCohabitantContainer('editResidentCohabitantList', item.cohabitantNames || '[]');

            // Populate and select house
            populateHouseDropdown('editResidentHouse');
            setTimeout(() => {
                document.getElementById('editResidentHouse').value = item.house_number || '';
            }, 100);

            openModal('editResident');
        }

        function updateResident() {
            const id = document.getElementById('editResidentId').value; // ใช้ string ตรงๆ ไม่ parseInt เพราะ ID เป็น "RES001"
            const residentType = document.getElementById('editResidentType').value;
            const prefix = document.getElementById('editResidentPrefix').value;
            const firstName = document.getElementById('editResidentFirstName').value.trim();
            const lastName = document.getElementById('editResidentLastName').value.trim();
            const position = document.getElementById('editResidentPosition').value;
            const subject_group = document.getElementById('editResidentSubjectGroup').value;
            const phone = document.getElementById('editResidentPhone').value.trim();
            const house = document.getElementById('editResidentHouse').value;
            const email = document.getElementById('editResidentEmail').value.trim();
            const birthdate = document.getElementById('editResidentBirthdate').value;
            const password = document.getElementById('editResidentPassword').value;
            const cohabitantList = getCohabitantsFromContainer('editResidentCohabitantList');
            const cohabitantNames = JSON.stringify(cohabitantList);
            const cohabitants = cohabitantList.length;
            const status = document.getElementById('editResidentStatus').value;

            if (!id) {
                ppkAlert('ไม่พบ ID ผู้พักอาศัย กรุณาปิดแล้วเปิดฟอร์มใหม่');
                return;
            }

            if (!firstName || !lastName) {
                ppkAlert('กรุณากรอกชื่อและนามสกุล');
                return;
            }

            if (email && !/^\S+@\S+\.\S+$/.test(email)) {
                ppkAlert('กรุณากรอกอีเมลให้ถูกต้อง');
                return;
            }

            if (password && password.length < 8) {
                ppkAlert('รหัสผ่านต้องมีอย่างน้อย 8 ตัวอักษร');
                return;
            }

            const updated = {
                residentType, prefix,
                firstname: firstName, lastname: lastName,
                resident: `${prefix}${firstName} ${lastName}`,
                position, subject_group, phone, house_number: house, email,
                birthdate, cohabitants, cohabitantNames, status,
                updatedAt: new Date().toISOString()
            };
            if (password) { updated.password = btoa(password); }

            // Update via Backend (ถ้ามี WEB_APP_URL — ไม่พึ่ง localStorage เป็นหลัก)
            if (WEB_APP_URL) {
                callBackend('updateResident', { id: String(id), ...updated }).then(result => {
                    if (result && result.success) {
                        // sync กับ localStorage ด้วย (cache)
                        const data = getResidentsData();
                        const index = data.findIndex(r => String(r.id) === String(id));
                        if (index !== -1) {
                            data[index] = { ...data[index], ...updated };
                            saveResidentsData(data);
                        }
                        renderResidentTable();
                        renderHouseCards();
                        closeModal('editResident');
                        ppkAlert('อัปเดตข้อมูลผู้พักอาศัยเรียบร้อยแล้ว');
                    } else {
                        ppkAlert('เกิดข้อผิดพลาด: ' + (result?.error || 'ไม่ทราบสาเหตุ'));
                    }
                }).catch(err => ppkAlert(err.message));
                return;
            }

            // Fallback: localStorage-only mode
            const data = getResidentsData();
            const index = data.findIndex(r => String(r.id) === String(id));
            if (index === -1) { ppkAlert('ไม่พบข้อมูลผู้พักอาศัย ID: ' + id); return; }
            data[index] = { ...data[index], ...updated };
            saveResidentsData(data);
            renderResidentTable();
            renderHouseCards();
            closeModal('editResident');
            ppkAlert('อัปเดตข้อมูลผู้พักอาศัยเรียบร้อยแล้ว');
        }

        async function deleteResident(id) {
            if (!await ppkConfirm('คุณต้องการลบข้อมูลผู้พักอาศัยนี้หรือไม่? การดำเนินการนี้ไม่สามารถยกเลิกได้')) {
                return;
            }

            // Delete from Backend
            if (WEB_APP_URL) {
                callBackend('removeResident', { id: String(id) }).then(result => {
                    if (result && result.success) {
                        const data = getResidentsData();
                        const newData = data.filter(r => r.id !== id && String(r.id) !== String(id));
                        saveResidentsData(newData);
                        renderResidentTable();
                        renderHouseCards();
                        ppkAlert('ลบข้อมูลผู้พักอาศัยเรียบร้อยแล้ว');
                    } else {
                        ppkAlert('เกิดข้อผิดพลาด: ' + (result?.error || 'ไม่ทราบสาเหตุ'));
                    }
                }).catch(err => ppkAlert(err.message));
                return;
            }

            const data = getResidentsData();
            const newData = data.filter(r => r.id !== id);
            saveResidentsData(newData);
            renderResidentTable();
            renderHouseCards();
            ppkAlert('ลบข้อมูลผู้พักอาศัยเรียบร้อยแล้ว');
        }

        function resetResidentPassword(id) {
            const newPassword = prompt('กรอกรหัสผ่านใหม่สำหรับผู้พักอาศัย (อย่างน้อย 8 ตัวอักษร):');
            
            if (!newPassword) return;
            
            if (newPassword.length < 8) {
                ppkAlert('รหัสผ่านต้องมีอย่างน้อย 8 ตัวอักษร');
                return;
            }

            const data = getResidentsData();
            const index = data.findIndex(r => String(r.id) === String(id));
            
            if (index === -1) return;

            data[index].password = btoa(newPassword);
            data[index].updatedAt = new Date().toISOString();

            // Sync to Backend
            if (WEB_APP_URL) {
                callBackend('updateResident', { id: String(id), password: newPassword }).catch(err => console.warn(err));
            }

            saveResidentsData(data);
            ppkAlert('รีเซ็ตรหัสผ่านเรียบร้อยแล้ว');
        }

        function filterResidentTable() {
            const searchTerm = document.getElementById('searchResident').value.toLowerCase();
            const rows = document.querySelectorAll('#residentTableBody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        function exportResidents() {
            const data = getResidentsData();
            const dataStr = JSON.stringify(data, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'residents_backup_' + new Date().toISOString().slice(0,10) + '.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        function importResidents() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (Array.isArray(data)) {
                            if (await ppkConfirm(`พบข้อมูล ${data.length} รายการ ต้องการนำเข้าหรือไม่? (ข้อมูลเดิมจะถูกรวมกับข้อมูลใหม่)`)) {
                                const existing = getResidentsData();
                                const merged = [...existing, ...data];
                                saveResidentsData(merged);
                                renderResidentTable();
                                ppkAlert('นำเข้าข้อมูลเรียบร้อยแล้ว');
                            }
                        } else {
                            ppkAlert('รูปแบบไฟล์ไม่ถูกต้อง');
                        }
                    } catch(err) {
                        ppkAlert('เกิดข้อผิดพลาดในการอ่านไฟล์');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // ========== Water Settings Functions ==========
        function getWaterSettings() {
            return JSON.parse(localStorage.getItem(STORAGE_KEYS.waterSettings) || JSON.stringify({
                rate: 18,
                minCharge: 0,
                rounding: 'round'
            }));
        }

        function saveWaterSettings() {
            const settings = {
                rate: parseFloat(document.getElementById('waterRate').value) || 18,
                minCharge: parseFloat(document.getElementById('waterMinCharge').value) || 0,
                rounding: document.getElementById('waterRounding').value
            };
            
            // Save to Backend
            if (WEB_APP_URL) {
                callBackend('updateSettings', {
                    water_rate: String(settings.rate),
                    water_min_charge: String(settings.minCharge),
                    water_rounding: settings.rounding
                }).then(result => {
                    if (result && result.success) {
                        ppkAlert('บันทึกการตั้งค่าค่าน้ำเรียบร้อยแล้ว');
                    } else {
                        ppkAlert('เกิดข้อผิดพลาด: ' + (result?.error || 'ไม่ทราบสาเหตุ'));
                    }
                }).catch(err => ppkAlert(err.message));
            } else {
                ppkAlert('บันทึกการตั้งค่าค่าน้ำเรียบร้อยแล้ว (localStorage)');
            }
            
            localStorage.setItem(STORAGE_KEYS.waterSettings, JSON.stringify(settings));
            localStorage.setItem('waterRate', settings.rate);
            document.getElementById('currentWaterRate').textContent = settings.rate + ' บาท/หน่วย';
        }

        function loadWaterSettings() {
            const settings = getWaterSettings();
            document.getElementById('waterRate').value = settings.rate;
            document.getElementById('waterMinCharge').value = settings.minCharge;
            document.getElementById('waterRounding').value = settings.rounding;
            document.getElementById('currentWaterRate').textContent = settings.rate + ' บาท/หน่วย';
        }

        // ========== Electric Settings Functions ==========
        function getElectricSettings() {
            return JSON.parse(localStorage.getItem(STORAGE_KEYS.electricSettings) || JSON.stringify({
                method: 'bill',
                rate: 4,
                rounding: 'round',
                minCharge: 0
            }));
        }

        function saveElectricSettings() {
            const settings = {
                method: document.getElementById('electricMethod').value,
                rate: parseFloat(document.getElementById('electricRate').value) || 4,
                rounding: document.getElementById('electricRounding').value,
                minCharge: parseFloat(document.getElementById('electricMinCharge').value) || 0
            };
            
            // Save to Backend
            if (WEB_APP_URL) {
                callBackend('updateSettings', {
                    electric_method: settings.method,
                    electric_rate: String(settings.rate),
                    electric_rounding: settings.rounding,
                    electric_min_charge: String(settings.minCharge)
                }).then(result => {
                    if (result && result.success) {
                        ppkAlert('บันทึกการตั้งค่าค่าไฟเรียบร้อยแล้ว');
                    } else {
                        ppkAlert('เกิดข้อผิดพลาด: ' + (result?.error || 'ไม่ทราบสาเหตุ'));
                    }
                }).catch(err => ppkAlert(err.message));
            } else {
                ppkAlert('บันทึกการตั้งค่าค่าไฟเรียบร้อยแล้ว (localStorage)');
            }
            
            localStorage.setItem(STORAGE_KEYS.electricSettings, JSON.stringify(settings));
            document.getElementById('currentElectricMethod').textContent = 
                settings.method === 'bill' ? 'ตามใบแจ้งหนี้' : 'ตามหน่วยที่ใช้';
        }

        function loadElectricSettings() {
            const settings = getElectricSettings();
            document.getElementById('electricMethod').value = settings.method;
            document.getElementById('electricRate').value = settings.rate;
            document.getElementById('electricRounding').value = settings.rounding;
            document.getElementById('electricMinCharge').value = settings.minCharge;
            document.getElementById('currentElectricMethod').textContent = 
                settings.method === 'bill' ? 'ตามใบแจ้งหนี้' : 'ตามหน่วยที่ใช้';
            
            // Toggle rate input visibility
            document.getElementById('electricRateGroup').style.display = 
                settings.method === 'unit' ? 'block' : 'none';
        }

        // Toggle electric rate input based on method
        document.getElementById('electricMethod').addEventListener('change', function() {
            document.getElementById('electricRateGroup').style.display = 
                this.value === 'unit' ? 'block' : 'none';
        });

        // ========== Common Fee Settings Functions ==========
        function getCommonFeeSettings() {
            return JSON.parse(localStorage.getItem(STORAGE_KEYS.commonFeeSettings) || JSON.stringify({
                house: 110,
                flat: 110,
                note: 'รวมค่าขยะและค่าดูแลส่วนกลาง'
            }));
        }

        function saveCommonFeeSettings() {
            const settings = {
                house: parseFloat(document.getElementById('commonFeeHouse').value) || 110,
                flat: parseFloat(document.getElementById('commonFeeFlat').value) || 110,
                note: document.getElementById('commonFeeNote').value
            };
            
            // Save to Backend
            if (WEB_APP_URL) {
                callBackend('updateSettings', {
                    common_fee_house: String(settings.house),
                    common_fee_flat: String(settings.flat)
                }).then(result => {
                    if (result && result.success) {
                        ppkAlert('บันทึกการตั้งค่าค่าส่วนกลางเรียบร้อยแล้ว');
                    } else {
                        ppkAlert('เกิดข้อผิดพลาด: ' + (result?.error || 'ไม่ทราบสาเหตุ'));
                    }
                }).catch(err => ppkAlert(err.message));
            } else {
                ppkAlert('บันทึกการตั้งค่าค่าส่วนกลางเรียบร้อยแล้ว (localStorage)');
            }
            
            localStorage.setItem(STORAGE_KEYS.commonFeeSettings, JSON.stringify(settings));
            localStorage.setItem('commonFee', settings.house);
            document.getElementById('currentCommonFee').textContent = settings.house + ' บาท/เดือน';
        }

        function loadCommonFeeSettings() {
            const settings = getCommonFeeSettings();
            document.getElementById('commonFeeHouse').value = settings.house;
            document.getElementById('commonFeeFlat').value = settings.flat;
            document.getElementById('commonFeeNote').value = settings.note;
            document.getElementById('currentCommonFee').textContent = settings.house + ' บาท/เดือน';
        }

        // ========== System Settings Functions ==========
        function getSystemSettings() {
            return JSON.parse(localStorage.getItem(STORAGE_KEYS.systemSettings) || JSON.stringify({
                orgName: 'งานส่งเสริม กำกับ ดูแล และพัฒนาบ้านพักครู',
                schoolName: 'โรงเรียนพะเยาพิทยาคม',
                adminEmail: '',
                adminPhone: '',
                paymentDueWorkingDays: 15,
                reminderDays: 5,
                requireLogin: true,
                allowResetPassword: true,
                allowRegistration: false,
                queueExpiryDate: '',
                meterRecorder: '',
                meterChecker: '',
                headOfPromotion: '',
                viceDirector: '',
                director: '',
                emailSender: '',
                emailSignature: 'งานบ้านพักครู โรงเรียนพะเยาพิทยาคม',
                emailReminderNote: 'กรุณาชำระเงินและส่งสลิปโดยเร็วที่สุด',
                reminderIncludeUnit: true,
                reminderIncludeTotal: true,
                reminderIncludeWater: true,
                reminderIncludeElectric: true,
                reminderIncludeCommon: true,
                reminderIncludeDueDate: true,
                emailReceiptNote: 'ขอบคุณที่ชำระตรงเวลาครับ/ค่ะ',
                receiptIncludeUnit: true,
                receiptIncludeTotal: true,
                receiptIncludeWater: true,
                receiptIncludeElectric: true,
                receiptIncludeCommon: true,
                receiptIncludePaid: true,
                receiptIncludeDate: true
            }));
        }

        function saveSystemSettings() {
            const settings = {
                orgName: document.getElementById('orgName').value,
                schoolName: document.getElementById('schoolName').value,
                adminEmail: document.getElementById('adminEmail').value,
                adminPhone: document.getElementById('adminPhone').value,
                paymentDueWorkingDays: parseInt(document.getElementById('paymentDueWorkingDays').value) || 15,
                reminderDays: parseInt(document.getElementById('reminderDays').value) || 5,
                requireLogin: document.getElementById('requireLogin').checked,
                allowResetPassword: document.getElementById('allowResetPassword').checked,
                allowRegistration: document.getElementById('allowRegistration').checked,
                queueExpiryDate: document.getElementById('queueExpiryDateAdmin').value || '',
                meterRecorder: document.getElementById('meterRecorder').value,
                meterChecker: document.getElementById('meterChecker').value,
                headOfPromotion: document.getElementById('headOfPromotion').value,
                viceDirector: document.getElementById('viceDirector').value,
                director: document.getElementById('director').value,
                emailSender: document.getElementById('emailSender').value,
                emailSignature: document.getElementById('emailSignature').value,
                emailReminderNote: document.getElementById('emailReminderNote').value,
                reminderIncludeUnit: document.getElementById('reminderIncludeUnit').checked,
                reminderIncludeTotal: document.getElementById('reminderIncludeTotal').checked,
                reminderIncludeWater: document.getElementById('reminderIncludeWater').checked,
                reminderIncludeElectric: document.getElementById('reminderIncludeElectric').checked,
                reminderIncludeCommon: document.getElementById('reminderIncludeCommon').checked,
                reminderIncludeDueDate: document.getElementById('reminderIncludeDueDate').checked,
                emailReceiptNote: document.getElementById('emailReceiptNote').value,
                receiptIncludeUnit: document.getElementById('receiptIncludeUnit').checked,
                receiptIncludeTotal: document.getElementById('receiptIncludeTotal').checked,
                receiptIncludeWater: document.getElementById('receiptIncludeWater').checked,
                receiptIncludeElectric: document.getElementById('receiptIncludeElectric').checked,
                receiptIncludeCommon: document.getElementById('receiptIncludeCommon').checked,
                receiptIncludePaid: document.getElementById('receiptIncludePaid').checked,
                receiptIncludeDate: document.getElementById('receiptIncludeDate').checked
            };
            
            // Save to Backend
            if (WEB_APP_URL) {
                callBackend('updateSettings', {
                    org_name: settings.orgName,
                    school_name: settings.schoolName,
                    admin_email: settings.adminEmail,
                    admin_phone: settings.adminPhone,
                    due_date: String(settings.paymentDueWorkingDays),
                    reminder_days: String(settings.reminderDays),
                    require_login: String(settings.requireLogin),
                    allow_reset_password: String(settings.allowResetPassword),
                    allow_registration: String(settings.allowRegistration),
                    queue_expiry_days: settings.queueExpiryDate,
                    meter_recorder: settings.meterRecorder,
                    meter_checker: settings.meterChecker,
                    head_of_promotion: settings.headOfPromotion,
                    vice_director: settings.viceDirector,
                    director: settings.director,
                    email_sender: settings.emailSender,
                    email_signature: settings.emailSignature,
                    email_reminder_note: settings.emailReminderNote,
                    reminder_include_water: String(settings.reminderIncludeWater),
                    reminder_include_electric: String(settings.reminderIncludeElectric),
                    reminder_include_common: String(settings.reminderIncludeCommon),
                    reminder_include_total: String(settings.reminderIncludeTotal),
                    reminder_include_due: String(settings.reminderIncludeDueDate),
                    reminder_include_meter: String(settings.reminderIncludeUnit),
                    email_receipt_note: settings.emailReceiptNote,
                    receipt_include_water: String(settings.receiptIncludeWater),
                    receipt_include_electric: String(settings.receiptIncludeElectric),
                    receipt_include_common: String(settings.receiptIncludeCommon),
                    receipt_include_total: String(settings.receiptIncludeTotal),
                    receipt_include_paid: String(settings.receiptIncludePaid),
                    receipt_include_date: String(settings.receiptIncludeDate)
                }).then(result => {
                    if (result && result.success) {
                        ppkAlert('บันทึกการตั้งค่าระบบเรียบร้อยแล้ว');
                    } else {
                        ppkAlert('เกิดข้อผิดพลาด: ' + (result?.error || 'ไม่ทราบสาเหตุ'));
                    }
                }).catch(err => ppkAlert(err.message));
            } else {
                ppkAlert('บันทึกการตั้งค่าระบบเรียบร้อยแล้ว (localStorage)');
            }
            
            localStorage.setItem(STORAGE_KEYS.systemSettings, JSON.stringify(settings));
            localStorage.setItem('adminEmail', settings.adminEmail);
            localStorage.setItem('due_date_working_days', settings.paymentDueWorkingDays);
            if (settings.queueExpiryDate) {
                localStorage.setItem('queueExpiryDate', settings.queueExpiryDate);
            }
        }

        function loadSystemSettings() {
            const settings = getSystemSettings();
            document.getElementById('orgName').value = settings.orgName;
            document.getElementById('schoolName').value = settings.schoolName;
            document.getElementById('adminEmail').value = settings.adminEmail;
            document.getElementById('adminPhone').value = settings.adminPhone;
            document.getElementById('paymentDueWorkingDays').value = settings.paymentDueWorkingDays;
            document.getElementById('reminderDays').value = settings.reminderDays;
            document.getElementById('requireLogin').checked = settings.requireLogin;
            document.getElementById('allowResetPassword').checked = settings.allowResetPassword;
            document.getElementById('allowRegistration').checked = settings.allowRegistration;
            document.getElementById('queueExpiryDateAdmin').value = settings.queueExpiryDate || '';
            document.getElementById('meterRecorder').value = settings.meterRecorder || '';
            document.getElementById('meterChecker').value = settings.meterChecker || '';
            document.getElementById('headOfPromotion').value = settings.headOfPromotion || '';
            document.getElementById('viceDirector').value = settings.viceDirector || '';
            document.getElementById('director').value = settings.director || '';
            document.getElementById('emailSender').value = settings.emailSender || '';
            document.getElementById('emailSignature').value = settings.emailSignature || 'งานบ้านพักครู โรงเรียนพะเยาพิทยาคม';
            document.getElementById('emailReminderNote').value = settings.emailReminderNote || 'กรุณาชำระเงินและส่งสลิปโดยเร็วที่สุด';
            document.getElementById('reminderIncludeUnit').checked = settings.reminderIncludeUnit !== false;
            document.getElementById('reminderIncludeTotal').checked = settings.reminderIncludeTotal !== false;
            document.getElementById('reminderIncludeWater').checked = settings.reminderIncludeWater !== false;
            document.getElementById('reminderIncludeElectric').checked = settings.reminderIncludeElectric !== false;
            document.getElementById('reminderIncludeCommon').checked = settings.reminderIncludeCommon !== false;
            document.getElementById('reminderIncludeDueDate').checked = settings.reminderIncludeDueDate !== false;
            document.getElementById('emailReceiptNote').value = settings.emailReceiptNote || 'ขอบคุณที่ชำระตรงเวลาครับ/ค่ะ';
            document.getElementById('receiptIncludeUnit').checked = settings.receiptIncludeUnit !== false;
            document.getElementById('receiptIncludeTotal').checked = settings.receiptIncludeTotal !== false;
            document.getElementById('receiptIncludeWater').checked = settings.receiptIncludeWater !== false;
            document.getElementById('receiptIncludeElectric').checked = settings.receiptIncludeElectric !== false;
            document.getElementById('receiptIncludeCommon').checked = settings.receiptIncludeCommon !== false;
            document.getElementById('receiptIncludePaid').checked = settings.receiptIncludePaid !== false;
            document.getElementById('receiptIncludeDate').checked = settings.receiptIncludeDate !== false;
        }

        // ========== Backup/Restore Functions ==========
        function backupData() {
            const backup = {
                timestamp: new Date().toISOString(),
                housing: getHousingData(),
                residents: getResidentsData(),
                housingFormat: getHousingFormatSettings(),
                waterSettings: getWaterSettings(),
                electricSettings: getElectricSettings(),
                commonFeeSettings: getCommonFeeSettings(),
                systemSettings: getSystemSettings(),
                permissions: getPermissionsData(),
                exemptions: getExemptionsData()
            };
            
            const dataStr = JSON.stringify(backup, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'home_ppk_backup_' + new Date().toISOString().slice(0,10) + '.json';
            a.click();
            URL.revokeObjectURL(url);
            
            ppkAlert('สำรองข้อมูลเรียบร้อยแล้ว');
        }

        function restoreData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        const backup = JSON.parse(e.target.result);
                        
                        if (!backup.timestamp) {
                            ppkAlert('รูปแบบไฟล์สำรองข้อมูลไม่ถูกต้อง');
                            return;
                        }

                        if (!await ppkConfirm(`ต้องการกู้คืนข้อมูลจากวันที่ ${new Date(backup.timestamp).toLocaleString('th-TH')} หรือไม่?\n\nคำเตือน: ข้อมูลปัจจุบันจะถูกแทนที่ด้วยข้อมูลจากไฟล์สำรอง`)) {
                            return;
                        }

                        // Restore all data
                        if (backup.housing) saveHousingData(backup.housing);
                        if (backup.residents) saveResidentsData(backup.residents);
                        if (backup.housingFormat) localStorage.setItem(STORAGE_KEYS.housingFormat, JSON.stringify(backup.housingFormat));
                        if (backup.waterSettings) localStorage.setItem(STORAGE_KEYS.waterSettings, JSON.stringify(backup.waterSettings));
                        if (backup.electricSettings) localStorage.setItem(STORAGE_KEYS.electricSettings, JSON.stringify(backup.electricSettings));
                        if (backup.commonFeeSettings) localStorage.setItem(STORAGE_KEYS.commonFeeSettings, JSON.stringify(backup.commonFeeSettings));
                        if (backup.systemSettings) localStorage.setItem(STORAGE_KEYS.systemSettings, JSON.stringify(backup.systemSettings));
                        if (backup.permissions) savePermissionsData(backup.permissions);
                        if (backup.exemptions) saveExemptionsData(backup.exemptions);

                        // Reload all data
                        loadAllSettings();
                        
                        ppkAlert('กู้คืนข้อมูลเรียบร้อยแล้ว');
                    } catch(err) {
                        console.error(err);
                        ppkAlert('เกิดข้อผิดพลาดในการอ่านไฟล์สำรองข้อมูล');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        async function clearAllData() {
            if (!await ppkConfirm('คุณต้องการล้างข้อมูลทั้งหมดหรือไม่?\n\nคำเตือน: การดำเนินการนี้ไม่สามารถยกเลิกได้! กรุณาสำรองข้อมูลก่อนดำเนินการ')) {
                return;
            }
            
            if (!await ppkConfirm('ยืนยันอีกครั้ง: ข้อมูลทั้งหมดจะถูกลบ รวมถึงข้อมูลบ้านพัก ผู้พักอาศัย สิทธิ์ และการตั้งค่าทั้งหมด')) {
                return;
            }

            // Clear all localStorage
            Object.values(STORAGE_KEYS).forEach(key => {
                localStorage.removeItem(key);
            });
            
            // Also clear related keys
            localStorage.removeItem('waterRate');
            localStorage.removeItem('commonFee');
            localStorage.removeItem('adminEmail');

            // Reload page
            location.reload();
        }

        // ========== Regulation PDF Functions ==========
        function handleRegulationPdfUpload(event) {
            const file = event.target.files[0];
            if (file && file.type === 'application/pdf') {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const base64 = e.target.result;
                    localStorage.setItem('regulations_pdf', base64);
                    updateRegulationFileStatus();
                    ppkAlert('อัพโหลดไฟล์ระเบียบเรียบร้อยแล้ว!');
                };
                reader.readAsDataURL(file);
            } else {
                ppkAlert('กรุณาเลือกไฟล์ PDF เท่านั้น');
            }
            event.target.value = '';
        }

        async function deleteRegulationPdf() {
            if (await ppkConfirm('ต้องการลบไฟล์ระเบียบนี้หรือไม่?')) {
                localStorage.removeItem('regulations_pdf');
                updateRegulationFileStatus();
                ppkAlert('ลบไฟล์ระเบียบเรียบร้อยแล้ว');
            }
        }

        function updateRegulationFileStatus() {
            const savedPdf = localStorage.getItem('regulations_pdf');
            const statusEl = document.getElementById('regulationFileStatus');
            const infoEl = document.getElementById('regulationFileInfo');
            const deleteBtn = document.getElementById('deleteRegulationBtn');
            
            if (savedPdf) {
                statusEl.textContent = '✅ มีไฟล์ระเบียบในระบบ';
                statusEl.style.color = '#059669';
                // Calculate file size
                const fileSizeKB = Math.round((savedPdf.length * 3 / 4) / 1024);
                infoEl.textContent = 'ขนาดไฟล์ประมาณ: ' + fileSizeKB + ' KB';
                deleteBtn.style.display = 'inline-flex';
            } else {
                statusEl.textContent = '❌ ยังไม่มีไฟล์ระเบียบ';
                statusEl.style.color = '#dc2626';
                infoEl.textContent = 'กรุณาอัพโหลดไฟล์ PDF เพื่อแสดงในหน้าระเบียบ';
                deleteBtn.style.display = 'none';
            }
        }

        // ========== Announcement Functions ==========
        function getAnnouncementsData() {
            return JSON.parse(localStorage.getItem('announcements') || '[]');
        }

        function saveAnnouncementsData(data) {
            localStorage.setItem('announcements', JSON.stringify(data));
        }

        function addAnnouncement() {
            const text = document.getElementById('newAnnouncementText').value.trim();
            const expiry = document.getElementById('announcementExpiry').value;
            const priority = document.getElementById('announcementPriority').value;

            if (!text) {
                ppkAlert('กรุณากรอกข้อความประกาศ');
                return;
            }

            // Save to Backend
            if (WEB_APP_URL) {
                callBackend('addAnnouncement', { text, expiry: expiry || null, priority }).then(result => {
                    if (result && result.success) {
                        // Also add to local cache
                        const announcements = getAnnouncementsData();
                        announcements.unshift({
                            id: result.id || Date.now(),
                            text, expiry: expiry || null, priority,
                            createdAt: new Date().toISOString(), active: true
                        });
                        saveAnnouncementsData(announcements);
                        document.getElementById('newAnnouncementText').value = '';
                        document.getElementById('announcementExpiry').value = '';
                        document.getElementById('announcementPriority').value = 'normal';
                        renderAnnouncementsList();
                        ppkAlert('เพิ่มประกาศเรียบร้อยแล้ว!');
                    } else {
                        ppkAlert('เกิดข้อผิดพลาด: ' + (result?.error || 'ไม่ทราบสาเหตุ'));
                    }
                }).catch(err => ppkAlert(err.message));
                return;
            }

            const announcements = getAnnouncementsData();
            const newAnnouncement = {
                id: Date.now(),
                text: text,
                expiry: expiry || null,
                priority: priority,
                createdAt: new Date().toISOString(),
                active: true
            };

            announcements.unshift(newAnnouncement);
            saveAnnouncementsData(announcements);

            // Clear form
            document.getElementById('newAnnouncementText').value = '';
            document.getElementById('announcementExpiry').value = '';
            document.getElementById('announcementPriority').value = 'normal';

            renderAnnouncementsList();
            ppkAlert('เพิ่มประกาศเรียบร้อยแล้ว!');
        }

        async function deleteAnnouncement(id) {
            if (!await ppkConfirm('ต้องการลบประกาศนี้หรือไม่?')) return;

            // Delete from Backend
            if (WEB_APP_URL) {
                callBackend('deleteAnnouncement', { id: String(id) }).catch(err => console.warn(err));
            }

            let announcements = getAnnouncementsData();
            announcements = announcements.filter(a => a.id !== id && String(a.id) !== String(id));
            saveAnnouncementsData(announcements);
            renderAnnouncementsList();
        }

        function toggleAnnouncement(id) {
            let announcements = getAnnouncementsData();
            let newActive;
            announcements = announcements.map(a => {
                if (a.id === id || String(a.id) === String(id)) {
                    a.active = !a.active;
                    newActive = a.active;
                }
                return a;
            });
            saveAnnouncementsData(announcements);
            renderAnnouncementsList();

            // Sync toggle to backend (fire-and-forget)
            if (WEB_APP_URL) {
                callBackend('addAnnouncement', { id: String(id), active: newActive, _toggle: true }).catch(() => {});
            }
        }

        function renderAnnouncementsList() {
            const container = document.getElementById('announcementsList');
            const announcements = getAnnouncementsData();

            if (announcements.length === 0) {
                container.innerHTML = '<div style="color: var(--muted); text-align: center; padding: 1rem;">ยังไม่มีประกาศ</div>';
                return;
            }

            const priorityColors = {
                'normal': '#64748b',
                'important': '#f59e0b',
                'urgent': '#ef4444'
            };
            const priorityLabels = {
                'normal': 'ปกติ',
                'important': '⚠️ สำคัญ',
                'urgent': '🚨 ด่วนมาก'
            };

            container.innerHTML = announcements.map(a => {
                const isExpired = a.expiry && new Date(a.expiry) < new Date();
                const expiryText = a.expiry ? `หมดอายุ: ${new Date(a.expiry).toLocaleDateString('th-TH')}` : 'ไม่หมดอายุ';
                const createdText = new Date(a.createdAt).toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: 'numeric' });
                
                return `
                    <div style="background: ${a.active && !isExpired ? '#f0fdf4' : '#f1f5f9'}; border: 1px solid ${a.active && !isExpired ? '#22c55e' : '#e5e7eb'}; border-left: 4px solid ${priorityColors[a.priority]}; border-radius: 8px; padding: 0.8rem; margin-bottom: 0.5rem; opacity: ${a.active && !isExpired ? 1 : 0.6};">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 0.5rem; flex-wrap: wrap;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; margin-bottom: 0.3rem;">${a.text}</div>
                                <div style="font-size: 0.85rem; color: var(--muted);">
                                    <span style="color: ${priorityColors[a.priority]};">${priorityLabels[a.priority]}</span>
                                    · สร้างเมื่อ: ${createdText}
                                    · ${expiryText}
                                    ${isExpired ? '<span style="color: #ef4444;">· หมดอายุแล้ว</span>' : ''}
                                </div>
                            </div>
                            <div class="action-btns">
                                <button class="btn ${a.active ? 'btn-warning' : 'btn-success'}" onclick="toggleAnnouncement(${a.id})">${a.active ? '⏸️ ปิด' : '▶️ เปิด'}</button>
                                <button class="btn btn-danger" onclick="deleteAnnouncement(${a.id})">🗑️ ลบ</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ========== Load All Settings ==========
        function loadAllSettings() {
            renderHousingTable();
            renderManageHousingCards();
            renderResidentTable();
            renderHouseCards(); // เพิ่มการโหลด house cards view
            loadWaterSettings();
            loadElectricSettings();
            loadCommonFeeSettings();
            loadSystemSettings();
            renderExemptionTable();
            renderPermissionTable();
            renderAnnouncementsList();
            
            // Load housing format settings
            const formatSettings = getHousingFormatSettings();
            document.getElementById('houseNumberFormat').value = formatSettings.houseFormat;
            document.getElementById('housePrefix').value = formatSettings.housePrefix;
            document.getElementById('flatNumberFormat').value = formatSettings.flatFormat;
            document.getElementById('flatPrefix').value = formatSettings.flatPrefix;
        }

        // ========== Load from Backend & Sync to localStorage ==========
        async function loadFromBackend() {
            if (!WEB_APP_URL) return;
            
            try {
                // ── batchGet: 1 HTTP request แทน 5 requests ──
                const BATCH_KEYS = 'getSettings,getHousing,getResidents,getAnnouncements,getPendingRegistrations';
                const batchResult = await callBackendGet('batchGet', { keys: BATCH_KEYS });

                // ดึง results แต่ละ action ออกมา
                const results = (batchResult && batchResult.success) ? batchResult.results : {};
                const settingsResult      = results['getSettings']      || {};
                const housingResult       = results['getHousing']       || {};
                const residentsResult     = results['getResidents']      || {};
                const announcementsResult = results['getAnnouncements']  || {};
                const pendingResult       = results['getPendingRegistrations'] || {};

                // Process settings
                if (settingsResult && settingsResult.success && settingsResult.data) {
                    const s = settingsResult.data;
                    
                    // Sync water settings
                    if (s.water_rate !== undefined) {
                        const waterSettings = {
                            rate: parseFloat(s.water_rate) || 18,
                            minCharge: parseFloat(s.water_min_charge) || 0,
                            rounding: s.water_rounding || 'none'
                        };
                        localStorage.setItem(STORAGE_KEYS.waterSettings, JSON.stringify(waterSettings));
                        localStorage.setItem('waterRate', waterSettings.rate);
                    }
                    
                    // Sync electric settings
                    if (s.electric_method !== undefined) {
                        const electricSettings = {
                            method: s.electric_method || 'bill',
                            rate: parseFloat(s.electric_rate) || 4,
                            rounding: s.electric_rounding || 'ceil',
                            minCharge: parseFloat(s.electric_min_charge) || 0
                        };
                        localStorage.setItem(STORAGE_KEYS.electricSettings, JSON.stringify(electricSettings));
                    }
                    
                    // Sync common fee settings
                    if (s.common_fee_house !== undefined) {
                        const commonSettings = {
                            house: parseFloat(s.common_fee_house) || 110,
                            flat: parseFloat(s.common_fee_flat) || 110,
                            note: ''
                        };
                        localStorage.setItem(STORAGE_KEYS.commonFeeSettings, JSON.stringify(commonSettings));
                        localStorage.setItem('commonFee', commonSettings.house);
                    }
                    
                    // Sync system settings
                    const systemSettings = {
                        orgName: s.org_name || '',
                        schoolName: s.school_name || '',
                        adminEmail: s.admin_email || '',
                        adminPhone: s.admin_phone || '',
                        paymentDueWorkingDays: parseInt(s.due_date) || 15,
                        reminderDays: parseInt(s.reminder_days) || 5,
                        requireLogin: s.require_login === 'true',
                        allowResetPassword: s.allow_reset_password === 'true',
                        allowRegistration: s.allow_registration === 'true',
                        queueExpiryDate: s.queue_expiry_days || '',
                        meterRecorder: s.meter_recorder || '',
                        meterChecker: s.meter_checker || '',
                        headOfPromotion: s.head_of_promotion || '',
                        viceDirector: s.vice_director || '',
                        director: s.director || '',
                        emailSender: s.email_sender || '',
                        emailSignature: s.email_signature || '',
                        emailReminderNote: s.email_reminder_note || '',
                        reminderIncludeUnit: s.reminder_include_meter !== 'false',
                        reminderIncludeTotal: s.reminder_include_total !== 'false',
                        reminderIncludeWater: s.reminder_include_water !== 'false',
                        reminderIncludeElectric: s.reminder_include_electric !== 'false',
                        reminderIncludeCommon: s.reminder_include_common !== 'false',
                        reminderIncludeDueDate: s.reminder_include_due !== 'false',
                        emailReceiptNote: s.email_receipt_note || '',
                        receiptIncludeUnit: s.receipt_include_meter !== 'false',
                        receiptIncludeTotal: s.receipt_include_total !== 'false',
                        receiptIncludeWater: s.receipt_include_water !== 'false',
                        receiptIncludeElectric: s.receipt_include_electric !== 'false',
                        receiptIncludeCommon: s.receipt_include_common !== 'false',
                        receiptIncludePaid: s.receipt_include_paid !== 'false',
                        receiptIncludeDate: s.receipt_include_date !== 'false'
                    };
                    localStorage.setItem(STORAGE_KEYS.systemSettings, JSON.stringify(systemSettings));
                    
                    // Sync housing format
                    if (s.house_prefix !== undefined || s.flat_prefix !== undefined) {
                        const formatSettings = {
                            houseFormat: 'prefix-number',
                            housePrefix: s.house_prefix || 'บ้าน ',
                            flatFormat: 'prefix-number',
                            flatPrefix: s.flat_prefix || 'แฟลต'
                        };
                        localStorage.setItem(STORAGE_KEYS.housingFormat, JSON.stringify(formatSettings));
                    }
                }

                // Process housing data
                if (housingResult && housingResult.success && housingResult.data) {
                    const housingData = housingResult.data.map((h, i) => ({
                        id: h.id || (i + 1),
                        type: h.type || 'house',
                        number: h.number || '',
                        displayNumber: h.display_number || '',
                        zone: h.zone || '',
                        status: h.status || 'available',
                        note: h.note || ''
                    }));
                    localStorage.setItem(STORAGE_KEYS.housing, JSON.stringify(housingData));
                }

                // Process residents data
                if (residentsResult && residentsResult.success && residentsResult.data) {
                    const residentsData = residentsResult.data.map(r => ({
                        id: r.id || '',
                        prefix: r.prefix || '',
                        firstname: r.firstname || '',
                        lastname: r.lastname || '',
                        position: r.position || '',
                        subject_group: r.subject_group || '',
                        phone: r.phone || '',
                        email: r.email || '',
                        house_number: r.house_number || '',
                        residentType: r.resident_type || 'staff',
                        cohabitants: r.cohabitants || 0,
                        cohabitantNames: r.cohabitant_names || '[]',
                        birthdate: r.birthdate || '',
                        status: r.status || 'active'
                    }));
                    localStorage.setItem(STORAGE_KEYS.residents, JSON.stringify(residentsData));
                }

                // Process announcements
                if (announcementsResult && announcementsResult.success && announcementsResult.data) {
                    localStorage.setItem('announcements', JSON.stringify(announcementsResult.data));
                }

                // Process pending registrations (already loaded in parallel)
                if (pendingResult && pendingResult.success) {
                    _pendingRegistrations = pendingResult.data || [];
                    renderPendingRegistrations();
                    const badge = document.getElementById('pendingCount');
                    if (_pendingRegistrations.length > 0) {
                        badge.textContent = _pendingRegistrations.length;
                        badge.style.display = 'inline';
                    } else {
                        badge.style.display = 'none';
                    }
                }

            } catch (err) {
                console.warn('Backend load failed, using localStorage:', err.message);
            }
            
            // Reload UI from localStorage (now synced with backend)
            loadAllSettings();
        }

        // ========== Registration Approval Functions (Step 28) ==========
        let _pendingRegistrations = [];

        async function loadPendingRegistrations() {
            if (!WEB_APP_URL) {
                document.getElementById('pendingRegTableBody').innerHTML = 
                    '<tr><td colspan="7" style="color:var(--muted);">ยังไม่ได้ตั้งค่า WEB_APP_URL</td></tr>';
                return;
            }

            document.getElementById('pendingRegLoading').style.display = 'block';
            
            try {
                const result = await callBackendGet('getPendingRegistrations');
                
                if (result && result.success) {
                    _pendingRegistrations = result.data || [];
                    renderPendingRegistrations();
                    
                    // Update badge count
                    const badge = document.getElementById('pendingCount');
                    if (_pendingRegistrations.length > 0) {
                        badge.textContent = _pendingRegistrations.length;
                        badge.style.display = 'inline';
                    } else {
                        badge.style.display = 'none';
                    }
                } else {
                    document.getElementById('pendingRegTableBody').innerHTML = 
                        '<tr><td colspan="7" style="color:var(--danger);">โหลดข้อมูลไม่สำเร็จ: ' + (result?.error || '') + '</td></tr>';
                }
            } catch (err) {
                document.getElementById('pendingRegTableBody').innerHTML = 
                    '<tr><td colspan="7" style="color:var(--danger);">' + err.message + '</td></tr>';
            } finally {
                document.getElementById('pendingRegLoading').style.display = 'none';
            }
        }

        function renderPendingRegistrations() {
            const tbody = document.getElementById('pendingRegTableBody');
            
            if (_pendingRegistrations.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="color:var(--muted);">🎉 ไม่มีรายการรออนุมัติ</td></tr>';
                return;
            }

            tbody.innerHTML = _pendingRegistrations.map((reg, i) => {
                const name = `${reg.prefix || ''}${reg.firstname || ''} ${reg.lastname || ''}`;
                const date = reg.submitted_at ? new Date(reg.submitted_at).toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: 'numeric' }) : '-';
                
                return `
                    <tr>
                        <td>${i + 1}</td>
                        <td style="text-align:left;">${name}</td>
                        <td>${reg.email || '-'}</td>
                        <td>${reg.phone || '-'}</td>
                        <td>${reg.position || '-'}</td>
                        <td>${date}</td>
                        <td>
                            <div class="action-btns">
                                <button class="btn btn-success" onclick="openApproveModal('${reg.id}')">✅ อนุมัติ</button>
                                <button class="btn btn-danger" onclick="openRejectModal('${reg.id}')">❌ ปฏิเสธ</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function openApproveModal(regId) {
            const reg = _pendingRegistrations.find(r => r.id === regId);
            if (!reg) return;
            
            document.getElementById('approveRegId').value = regId;
            document.getElementById('approveRegInfo').innerHTML = `
                <strong>ชื่อ:</strong> ${reg.prefix || ''}${reg.firstname || ''} ${reg.lastname || ''}<br>
                <strong>อีเมล:</strong> ${reg.email || '-'}<br>
                <strong>เบอร์โทร:</strong> ${reg.phone || '-'}<br>
                <strong>ตำแหน่ง:</strong> ${reg.position || '-'}
            `;
            openModal('approveReg');
        }

        function openRejectModal(regId) {
            const reg = _pendingRegistrations.find(r => r.id === regId);
            if (!reg) return;
            
            document.getElementById('rejectRegId').value = regId;
            document.getElementById('rejectRegInfo').innerHTML = `
                <strong>ชื่อ:</strong> ${reg.prefix || ''}${reg.firstname || ''} ${reg.lastname || ''}<br>
                <strong>อีเมล:</strong> ${reg.email || '-'}
            `;
            document.getElementById('rejectRegNote').value = '';
            openModal('rejectReg');
        }

        async function confirmApproveRegistration() {
            const regId = document.getElementById('approveRegId').value;
            const houseNumber = document.getElementById('approveRegHouse').value.trim();
            const residentType = document.getElementById('approveRegType').value;

            try {
                const result = await callBackend('approveRegistration', {
                    regId: regId,
                    house_number: houseNumber,
                    resident_type: residentType
                });

                if (result && result.success) {
                    ppkAlert('อนุมัติเรียบร้อยแล้ว!\nUser ID: ' + (result.userId || '-') + '\nResident ID: ' + (result.residentId || '-'));
                    closeModal('approveReg');
                    loadPendingRegistrations();
                    // Reload residents data
                    loadFromBackend();
                } else {
                    ppkAlert('เกิดข้อผิดพลาด: ' + (result?.error || result?.message || 'ไม่ทราบสาเหตุ'));
                }
            } catch (err) {
                ppkAlert(err.message);
            }
        }

        async function confirmRejectRegistration() {
            const regId = document.getElementById('rejectRegId').value;
            const note = document.getElementById('rejectRegNote').value.trim();

            if (!note) {
                ppkAlert('กรุณาระบุเหตุผลที่ปฏิเสธ');
                return;
            }

            try {
                const result = await callBackend('rejectRegistration', {
                    regId: regId,
                    note: note
                });

                if (result && result.success) {
                    ppkAlert('ปฏิเสธเรียบร้อยแล้ว');
                    closeModal('rejectReg');
                    loadPendingRegistrations();
                } else {
                    ppkAlert('เกิดข้อผิดพลาด: ' + (result?.error || result?.message || 'ไม่ทราบสาเหตุ'));
                }
            } catch (err) {
                ppkAlert(err.message);
            }
        }

        // ========== Exemption Functions ==========
        function getExemptionsData() {
            return JSON.parse(localStorage.getItem(STORAGE_KEYS.exemptions) || '{}');
        }

        function saveExemptionsData(data) {
            localStorage.setItem(STORAGE_KEYS.exemptions, JSON.stringify(data));
        }

        function renderExemptionTable() {
            const housing = getHousingData();
            const residents = getResidentsData();
            const exemptions = getExemptionsData();
            const tbody = document.getElementById('exemptionTableBody');
            const formatSettings = getHousingFormatSettings();
            
            if (housing.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="color:var(--muted);">ยังไม่มีข้อมูลบ้านพัก/แฟลต กรุณาเพิ่มข้อมูลในแท็บ "บ้านพักและแฟลต"</td></tr>';
                return;
            }

            tbody.innerHTML = housing.map((item, index) => {
                const displayNumber = formatHousingNumber(item, formatSettings);
                const occupant = residents.find(r => r.house_number === displayNumber || r.house_number === item.number);
                const occupantName = occupant ? `${occupant.prefix || ''}${occupant.firstname} ${occupant.lastname}` : '<span style="color:var(--muted);">ไม่มีผู้พักอาศัย</span>';
                const exemption = exemptions[item.id] || { exempt: false, note: '' };
                
                return `
                    <tr data-id="${item.id}">
                        <td>${index + 1}</td>
                        <td><strong>${displayNumber}</strong></td>
                        <td style="text-align:left;">${occupantName}</td>
                        <td>
                            <input type="checkbox" class="exemption-checkbox" data-id="${item.id}" ${exemption.exempt ? 'checked' : ''}>
                        </td>
                        <td>
                            <input type="text" class="exemption-note" data-id="${item.id}" value="${exemption.note || ''}" placeholder="เหตุผล..." style="width:100%;padding:0.3rem 0.5rem;border:1px solid var(--border);border-radius:4px;font:inherit;font-size:0.85rem;">
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function filterExemptionTable() {
            const searchTerm = document.getElementById('searchExemption').value.toLowerCase();
            const rows = document.querySelectorAll('#exemptionTableBody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        function saveExemptions() {
            const exemptions = {};
            
            document.querySelectorAll('.exemption-checkbox').forEach(checkbox => {
                const id = checkbox.dataset.id;
                const noteInput = document.querySelector(`.exemption-note[data-id="${id}"]`);
                exemptions[id] = {
                    exempt: checkbox.checked,
                    note: noteInput ? noteInput.value : ''
                };
            });
            
            saveExemptionsData(exemptions);
            ppkAlert('บันทึกการยกเว้นค่าส่วนกลางเรียบร้อยแล้ว');
        }

        // ========== Permission Functions ==========
        function getPermissionsData() {
            return JSON.parse(localStorage.getItem(STORAGE_KEYS.permissions) || '{}');
        }

        function savePermissionsData(data) {
            localStorage.setItem(STORAGE_KEYS.permissions, JSON.stringify(data));
        }

        function renderPermissionTable() {
            const allResidents = getResidentsData();
            const permissions = getPermissionsData();
            const tbody = document.getElementById('permissionTableBody');
            
            // ถ้ายังไม่มีข้อมูลเลย ลองดึงจาก backend ใหม่
            if (allResidents.length === 0 && WEB_APP_URL) {
                callBackendGet('getResidents').then(result => {
                    if (result && result.success && result.data) {
                        const residentsData = result.data.map(r => ({
                            id: r.id || '',
                            prefix: r.prefix || '',
                            firstname: r.firstname || '',
                            lastname: r.lastname || '',
                            position: r.position || '',
                            subject_group: r.subject_group || '',
                            phone: r.phone || '',
                            email: r.email || '',
                            house_number: r.house_number || '',
                            residentType: r.resident_type || 'staff',
                            cohabitants: r.cohabitants || 0,
                            cohabitantNames: r.cohabitant_names || '[]',
                            birthdate: r.birthdate || '',
                            status: r.status || 'active'
                        }));
                        localStorage.setItem(STORAGE_KEYS.residents, JSON.stringify(residentsData));
                        renderPermissionTable(); // re-render
                    }
                }).catch(() => {});
                tbody.innerHTML = '<tr><td colspan="12" style="color:var(--muted);">&#x23F3; กำลังโหลดข้อมูล...</td></tr>';
                return;
            }

            // ---- รวมบุคลากรทุกคน (staff) ไม่ว่าจะมีอีเมลหรือไม่ ----
            // staff = residentType ไม่ใช่ cohabitant
            const staffResidents = allResidents
                .filter(r => r.residentType !== 'cohabitant')
                .map(r => ({ ...r, isVirtual: !(r.email && r.email.trim()) }));

            // ---- ดึงบุคลากรที่บันทึกไว้ใน cohabitantNames ด้วย relationship = บุคลากรโรงเรียนพะเยาพิทยาคม ----
            const existingNameKeys = new Set(allResidents.map(r =>
                (r.prefix + r.firstname + r.lastname).replace(/\s/g, '')
            ));
            const prefixList = ['นางสาว','นาง','นาย','เด็กชาย','เด็กหญิง','ด.ช.','ด.ญ.'];
            const STAFF_REL_VALUES = ['บุคลากรโรงเรียนพะเยาพิทยาคม','บุคลากร','staff'];
            const virtualStaff = [];
            allResidents.forEach(parentRes => {
                try {
                    const arr = JSON.parse(parentRes.cohabitantNames || '[]');
                    if (!Array.isArray(arr)) return;
                    arr.forEach((item, idx) => {
                        let pfx = '', fn = '', ln = '', isStaffCoh = false;
                        if (typeof item === 'string' && item.includes('(บุคลากร)')) {
                            // รูปแบบเก่า: "นางสาวXXX YYY (บุคลากร)"
                            const namePart = item.replace(/\s*\([^)]+\)\s*/g, '').trim();
                            let rest = namePart;
                            for (const p of prefixList) { if (rest.startsWith(p)) { pfx = p; rest = rest.slice(p.length).trim(); break; } }
                            const pts = rest.split(' '); fn = pts[0]||''; ln = pts.slice(1).join(' ');
                            isStaffCoh = true;
                        } else if (item && typeof item === 'object') {
                            const rel = (item.relationship || '').trim();
                            if (STAFF_REL_VALUES.includes(rel)) {
                                pfx = item.prefix||''; fn = item.firstname||''; ln = item.lastname||'';
                                isStaffCoh = true;
                            }
                        }
                        if (!isStaffCoh || !fn) return;
                        const nameKey = (pfx+fn+ln).replace(/\s/g, '');
                        if (existingNameKeys.has(nameKey)) return; // มี record แล้ว
                        const synId = `coh_${parentRes.id}_${idx}`;
                        virtualStaff.push({
                            id: synId, prefix: pfx, firstname: fn, lastname: ln,
                            house_number: parentRes.house_number || '',
                            residentType: 'staff', email: '', isVirtual: true
                        });
                        existingNameKeys.add(nameKey);
                    });
                } catch(e) {}
            });

            // ซ่อน warning div
            const warnDiv = document.getElementById('permStaffWarning');
            if (warnDiv) warnDiv.style.display = 'none';

            const allToShow = [...staffResidents, ...virtualStaff];

            if (allToShow.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" style="color:var(--muted);">ยังไม่มีบุคลากรในระบบ</td></tr>';
                updatePermissionSummary();
                return;
            }

            // จัดกลุ่มตามบ้าน
            const houseGroups = {};
            allToShow.forEach(r => {
                const hk = r.house_number || '__none__';
                if (!houseGroups[hk]) houseGroups[hk] = [];
                houseGroups[hk].push(r);
            });

            // เรียง: บ้าน → แฟลต → ไม่ระบุ; ภายในกลุ่มเลขน้อยไปมาก
            const isFlat = s => /แฟลต|flat/i.test(s);
            const numOf  = s => parseInt((s.match(/\d+/) || ['0'])[0]);
            const sortedHouseKeys = Object.keys(houseGroups).sort((a, b) => {
                if (a === '__none__') return 1;
                if (b === '__none__') return -1;
                const ta = isFlat(a) ? 1 : 0, tb = isFlat(b) ? 1 : 0;
                if (ta !== tb) return ta - tb;
                return numOf(a) - numOf(b);
            });

            let rowNum = 0;
            let html = '';

            sortedHouseKeys.forEach(houseKey => {
                const members = houseGroups[houseKey];
                const houseLabel = houseKey === '__none__' ? '⚫ ยังไม่ระบุบ้าน' :
                    (isFlat(houseKey) ? `🏢 ${houseKey}` : `🏠 ${houseKey}`);
                const houseColor = houseKey === '__none__' ? '#64748b' :
                    (isFlat(houseKey) ? '#0891b2' : '#1d4ed8');
                const bgColor = houseKey === '__none__' ? '#f8fafc' :
                    (isFlat(houseKey) ? '#e0f2fe' : '#eff6ff');
                const hasNoEmail = members.some(m => m.isVirtual);

                // Group header row
                html += `<tr class="perm-group-header" data-house="${houseKey}"
                    style="background:${bgColor}; border-top:2px solid ${houseColor}; border-bottom:1px solid ${houseColor}40;">
                    <td colspan="10" style="text-align:left; padding:0.5rem 1rem; font-weight:700; color:${houseColor}; font-size:0.93rem;">
                        ${houseLabel}
                        <span style="font-weight:400; font-size:0.82rem; color:#64748b; margin-left:0.75rem;">${members.length} บุคลากร</span>
                        ${hasNoEmail ? '<span style="font-size:0.78rem; color:#f59e0b; margin-left:0.5rem;">⚠️ บางท่านยังไม่มีอีเมล</span>' : ''}
                    </td>
                </tr>`;

                // Individual member rows
                members.forEach(resident => {
                    rowNum++;
                    const fullName = `${resident.prefix || ''}${resident.firstname || ''} ${resident.lastname || ''}`;
                    const userPerms = permissions[resident.id] || {};
                    const noAccess = resident.isVirtual;

                    const makeCheckbox = (perm, accentColor = '') => {
                        if (noAccess) {
                            const style = accentColor
                                ? `style="accent-color:${accentColor}; width:16px; height:16px; opacity:0.3;"`
                                : 'style="width:16px; height:16px; opacity:0.3;"';
                            return `<input type="checkbox" disabled title="ต้องเพิ่มอีเมลก่อนจึงจะกำหนดสิทธิ์ได้" ${style}>`;
                        }
                        const style = accentColor
                            ? `style="accent-color:${accentColor}; width:16px; height:16px;"`
                            : 'style="width:16px; height:16px;"';
                        return `<input type="checkbox" class="perm-checkbox" data-id="${resident.id}" data-perm="${perm}" ${userPerms[perm] ? 'checked' : ''} ${style}>`;
                    };

                    const emailNote = noAccess
                        ? `<span style="font-size:0.72rem;color:#f59e0b;">⚠️ ยังไม่มีอีเมล — <a href="#" onclick="addMissingStaff('${fullName.replace(/'/g,"\\'")}','${(resident.house_number||'').replace(/'/g,"\\'")}');return false;" style="color:var(--primary);">เพิ่มข้อมูล</a></span>`
                        : `<span style="font-size:0.72rem;color:var(--muted);">${resident.email}</span>`;

                    html += `
                        <tr class="perm-member-row" data-id="${resident.id}" data-house="${houseKey}" ${noAccess ? 'style="opacity:0.76;"' : ''}>
                            <td style="color:var(--muted); font-size:0.82rem;">${rowNum}</td>
                            <td style="text-align:left; padding-left:1.75rem;">
                                <div style="font-weight:600; font-size:0.9rem;">${fullName}</div>
                                <div>${emailNote}</div>
                            </td>
                            <td>${makeCheckbox('water')}</td>
                            <td>${makeCheckbox('electric')}</td>
                            <td>${makeCheckbox('notify')}</td>
                            <td>${makeCheckbox('slip')}</td>
                            <td>${makeCheckbox('withdraw')}</td>
                            <td>${makeCheckbox('accounting')}</td>
                            <td>${makeCheckbox('request')}</td>
                            <td>${makeCheckbox('admin', '#ef4444')}</td>
                        </tr>
                    `;
                });
            });

            tbody.innerHTML = html;
            
            document.querySelectorAll('.perm-checkbox').forEach(cb => {
                cb.addEventListener('change', updatePermissionSummary);
            });
            
            updatePermissionSummary();
        }

        // Pre-fill addResident modal for a staff member stored only as cohabitant name
        function addMissingStaff(fullname, house) {
            // Parse prefix from name
            const prefixes = ['นางสาว','นาง','นาย','เด็กชาย','เด็กหญิง','ด.ช.','ด.ญ.'];
            let prefix = '', rest = fullname.trim();
            for (const p of prefixes) {
                if (rest.startsWith(p)) { prefix = p; rest = rest.slice(p.length).trim(); break; }
            }
            const parts = rest.split(' ');
            const firstname = parts[0] || '';
            const lastname = parts.slice(1).join(' ');

            // Open modal and fill fields
            openModal('addResident');
            setTimeout(() => {
                document.getElementById('residentType').value = 'staff';
                document.getElementById('residentPrefix').value = prefix;
                document.getElementById('residentFirstName').value = firstname;
                document.getElementById('residentLastName').value = lastname;
                populateHouseDropdown('residentHouse');
                setTimeout(() => {
                    document.getElementById('residentHouse').value = house;
                }, 150);
            }, 100);
        }

        function filterPermissionTable() {
            const searchTerm = document.getElementById('searchPermission').value.toLowerCase();
            // group headers hide/show based on whether any member in that house matches
            const groupHeaders = document.querySelectorAll('#permissionTableBody tr.perm-group-header');
            groupHeaders.forEach(headerRow => {
                const houseKey = headerRow.dataset.house;
                const memberRows = document.querySelectorAll(`#permissionTableBody tr.perm-member-row[data-house="${houseKey}"]`);
                let anyVisible = false;
                memberRows.forEach(row => {
                    const text = row.textContent.toLowerCase();
                    const show = !searchTerm || text.includes(searchTerm) || houseKey.toLowerCase().includes(searchTerm);
                    row.style.display = show ? '' : 'none';
                    if (show) anyVisible = true;
                });
                headerRow.style.display = anyVisible || !searchTerm ? '' : 'none';
            });
            // fallback for non-grouped rows
            document.querySelectorAll('#permissionTableBody tr:not(.perm-group-header):not(.perm-member-row)').forEach(row => {
                row.style.display = !searchTerm || row.textContent.toLowerCase().includes(searchTerm) ? '' : 'none';
            });
        }

        function updatePermissionSummary() {
            const counts = {
                water: 0, electric: 0, notify: 0, slip: 0,
                withdraw: 0, accounting: 0, request: 0, admin: 0
            };
            
            document.querySelectorAll('.perm-checkbox:checked').forEach(cb => {
                const perm = cb.dataset.perm;
                if (counts.hasOwnProperty(perm)) {
                    counts[perm]++;
                }
            });
            
            document.getElementById('countWater').textContent = counts.water;
            document.getElementById('countElectric').textContent = counts.electric;
            document.getElementById('countNotify').textContent = counts.notify;
            document.getElementById('countSlip').textContent = counts.slip;
            document.getElementById('countWithdraw').textContent = counts.withdraw;
            document.getElementById('countAccounting').textContent = counts.accounting;
            document.getElementById('countRequest').textContent = counts.request;
            document.getElementById('countAdmin').textContent = counts.admin;
        }

        function savePermissions() {
            const permissions = {};
            
            document.querySelectorAll('.perm-checkbox').forEach(checkbox => {
                const userId = checkbox.dataset.id;
                const perm = checkbox.dataset.perm;
                
                if (!permissions[userId]) {
                    permissions[userId] = {};
                }
                permissions[userId][perm] = checkbox.checked;
            });
            
            // Save to Backend
            if (WEB_APP_URL) {
                callBackend('updatePermissions', { permissions }).then(result => {
                    if (result && result.success) {
                        ppkAlert('บันทึกการตั้งค่าสิทธิ์เรียบร้อยแล้ว');
                    } else {
                        ppkAlert('เกิดข้อผิดพลาด: ' + (result?.error || 'ไม่ทราบสาเหตุ'));
                    }
                }).catch(err => ppkAlert(err.message));
            } else {
                ppkAlert('บันทึกการตั้งค่าสิทธิ์เรียบร้อยแล้ว (localStorage)');
            }
            
            savePermissionsData(permissions);
        }

        function exportPermissions() {
            const permissions = getPermissionsData();
            const residents = getResidentsData();
            
            const exportData = {
                timestamp: new Date().toISOString(),
                permissions: permissions,
                summary: {}
            };
            
            // Build summary
            Object.keys(PERMISSION_TYPES).forEach(perm => {
                exportData.summary[perm] = {
                    label: PERMISSION_TYPES[perm].label,
                    users: []
                };
            });
            
            residents.forEach(r => {
                const userPerms = permissions[r.id] || {};
                const fullName = `${r.prefix || ''}${r.firstname || ''} ${r.lastname || ''}`;
                
                Object.keys(userPerms).forEach(perm => {
                    if (userPerms[perm] && exportData.summary[perm]) {
                        exportData.summary[perm].users.push({
                            name: fullName,
                            house: r.house_number || '-'
                        });
                    }
                });
            });
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'permissions_' + new Date().toISOString().slice(0,10) + '.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        // Check user permission (for use in other pages)
        function checkUserPermission(userId, permissionType) {
            const permissions = getPermissionsData();
            const userPerms = permissions[userId] || {};
            return userPerms[permissionType] === true || userPerms.admin === true;
        }

        // ========== Sidebar Toggle ==========
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebarToggle');
        sidebarToggle.onclick = function() {
            sidebar.classList.toggle('expanded');
            document.getElementById('dashboardContainer').style.marginLeft = sidebar.classList.contains('expanded')
                ? (window.innerWidth <= 600 ? '160px' : '280px')
                : (window.innerWidth <= 600 ? '48px' : '62px');
        };
        document.getElementById('dashboardContainer').style.marginLeft = (window.innerWidth <= 600 ? '48px' : '62px');
        window.addEventListener('resize', function() {
            document.getElementById('dashboardContainer').style.marginLeft = sidebar.classList.contains('expanded')
                ? (window.innerWidth <= 600 ? '160px' : '280px')
                : (window.innerWidth <= 600 ? '48px' : '62px');
        });

        // ========== Initialize ==========
        window.onload = async function() {
            // Check session first
            const user = await checkSession();
            if (!user) return;
            
            // Load from localStorage first (instant UI)
            loadAllSettings();
            updateRegulationFileStatus();
            
            // Then sync from Backend (async update)
            if (WEB_APP_URL) {
                await loadFromBackend();
            }
        };
    
        async function doLogout() {
            if (!await ppkConfirm('ยืนยันออกจากระบบ?')) return;
            var token = getSessionToken ? getSessionToken() : (localStorage.getItem('sessionToken') || '');
            if (token && WEB_APP_URL) {
                try { await callBackend('logout', {}); } catch(e) {}
            }
            localStorage.clear();
            navigate('?page=login');
        }
        </script>
    <script src="ppk-api.js"></script>
    <script src="ppk-utils.js"></script></body>
</html>
