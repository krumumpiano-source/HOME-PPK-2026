<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ส่งสลิปการชำระเงิน | HOME PPK 2026</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@400;600;700&display=swap');

        :root {
            --bg: #f8fafc;
            --surface: #ffffff;
            --border: #e5e7eb;
            --text: #0f172a;
            --muted: #64748b;
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #06b6d4;
            --shadow: 0 8px 24px rgba(15,23,42,.06);
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Kanit', sans-serif;
            background: var(--bg);
            min-height: 100vh;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--text);
        }
        .upload-slip-container {
            background: var(--surface);
            border-radius: 22px;
            box-shadow: var(--shadow);
            padding: 2rem;
            width: 100%;
            max-width: 480px;
            text-align: center;
        }
        .upload-slip-container h2 {
            margin-bottom: 1.5rem;
            color: var(--primary);
            font-weight: 700;
            font-size: 1.8rem;
        }
        .form-group {
            margin-bottom: 1.5rem;
            text-align: left;
        }
        .form-group label {
            display: block;
            font-size: 1rem;
            margin-bottom: 0.5rem;
            color: var(--text);
        }
        .form-group input[type="text"],
        .form-group input[type="file"],
        .form-group input[type="number"] {
            width: 100%;
            padding: 0.8rem;
            font-size: 1rem;
            border: 1px solid var(--border);
            border-radius: 8px;
        }
        .form-group input[type="file"] {
            padding: 0.5rem;
        }
        .submit-btn {
            background: linear-gradient(to right, var(--primary), var(--primary-dark));
            border-radius: 12px;
            font-size: 1.2rem;
            font-weight: bold;
            color: white;
            padding: 0.5rem 1rem;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s, box-shadow 0.2s;
            margin-bottom: 1rem;
        }
        .submit-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }
        .submit-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .back-btn {
            background: linear-gradient(to right, #d1d5db, #9ca3af);
            border-radius: 12px;
            font-size: 1.2rem;
            font-weight: bold;
            color: white;
            padding: 0.5rem 1rem;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .back-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }
        .back-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body>
    <div class="upload-slip-container">
        <h2>ส่งสลิปการชำระเงิน</h2>
        <form id="slipForm" action="#" method="post" enctype="multipart/form-data">
            <!-- Admin Override Panel (แสดงเฉพาะ admin) -->
            <div id="admin-override-panel" style="display:none; background:#eff6ff; border:1.5px solid #2563eb; border-radius:12px; padding:1rem; margin-bottom:1.2rem; text-align:left;">
                <div style="font-size:0.85rem; font-weight:700; color:#2563eb; margin-bottom:0.6rem;">🔧 โหมดแอดมิน — เลือกส่งสลิปแทนผู้พักอาศัย</div>
                <div class="form-group" style="margin-bottom:0.8rem;">
                    <label style="font-size:0.9rem;">เลือกบ้านพัก / แฟลต:</label>
                    <select id="admin-house-select" style="width:100%;padding:0.6rem;border-radius:8px;border:1px solid #d1d5db;font-family:Kanit,sans-serif;font-size:0.95rem;" onchange="onAdminHouseChange()">
                        <option value="">-- เลือกบ้านพัก --</option>
                    </select>
                </div>
                <div class="form-group" style="margin-bottom:0;">
                    <label style="font-size:0.9rem;">อีเมลผู้พักอาศัย (สำหรับใบเสร็จ):</label>
                    <input type="email" id="admin-email-input" placeholder="กรอกอีเมลผู้พักอาศัย" style="width:100%;padding:0.6rem;border-radius:8px;border:1px solid #d1d5db;font-family:Kanit,sans-serif;font-size:0.95rem;">
                </div>
            </div>

            <div class="form-group">
                <label>บ้านพักเลขที่:</label>
                <div id="display-unit" style="font-size: 1.2rem; font-weight: bold; color: #2563eb; margin-bottom: 0.5rem;">-</div>
            </div>
            <div class="form-group">
                <label>ประจำเดือน:</label>
                <div id="display-period" style="font-size: 1rem; color: #666; margin-bottom: 0.5rem;">-</div>
            </div>
            <div class="form-group">
                <label for="amount">ยอดที่ต้องชำระ (บาท):</label>
                <div id="display-amount" style="font-size: 1.2rem; font-weight: bold; color: #e11d48; margin-bottom: 1rem;">0 บาท</div>
            </div>
            <div class="form-group">
                <label for="paid-amount">กรอกจำนวนเงินที่ชำระ (บาท):</label>
                <input type="number" id="paid-amount" name="paid-amount" placeholder="กรอกจำนวนเงินที่ชำระ" required min="0" step="0.01">
            </div>
            <div class="form-group">
                <label for="slip">แนบไฟล์สลิป (รองรับไม่เกิน 3 รูป):</label>
                <input type="file" id="slip" name="slip[]" accept="image/*" multiple required>
                <div id="preview-container" style="display:flex;gap:0.5rem;flex-wrap:wrap;margin-top:0.5rem;"></div>
            </div>
            <button type="submit" class="submit-btn">ยืนยันการส่งสลิป</button>
            <button type="button" class="back-btn" onclick="window.navigate('?page=dashboard')">ย้อนกลับ</button>
        </form>

        <div style="text-align:center; margin-top:1.5rem; font-size:0.95rem; color:#888;">
            ออกแบบและพัฒนาโดย ครูพงศธร โพธิแก้ว<br>
            งานส่งเสริม กำกับ ดูแล และพัฒนาบ้านพักครู โรงเรียนพะเยาพิทยาคม
        </div>
    </div>

    <script>
        // ============ API Configuration ============
        var WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyA9KchBb2jhanAjz7VrMesRSINa35wkdH7VXY8dTig3lSFPY0M4bBbaIjgbuMRUX-0mQ/exec';
        function navigate(page) { var m = page.match(/[?&]page=([^&]+)/); window.location.href = m ? m[1] + '.html' : page; }

        async function callBackend(action, data = {}) {
            const token = localStorage.getItem('sessionToken');
            const payload = { action, token, ...data };
            try {
                const response = await fetch(WEB_APP_URL, {
                    method: 'POST', headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify(payload), redirect: 'follow'
                });
                const text = await response.text();
                const result = JSON.parse(text);
                if (result.error === 'SESSION_EXPIRED') { localStorage.clear(); window.navigate('?page=login'); return; }
                return result;
            } catch (err) { console.error('Backend error:', err); throw new Error('ไม่สามารถเชื่อมต่อระบบได้'); }
        }

        async function callBackendGet(action, params = {}) {
            if (!WEB_APP_URL) return null;
            const token = localStorage.getItem('sessionToken');
            const q = new URLSearchParams({ action, token, ...params }).toString();
            const res = await fetch(WEB_APP_URL + '?' + q, { redirect: 'follow' });
            return res.json();
        }
        //  cachedCall: GET + localStorage cache (TTL 2 นาที) 
                // cachedCall: stale-while-revalidate — แสดงทันที, refresh ใน background
        async function cachedCall(action, params, ttlMs) {
            ttlMs = ttlMs || 300000; // 5 นาที
            var ck = 'apicache_' + action + '_' + JSON.stringify(params || {});
            var fresh = null;
            try { var s = localStorage.getItem(ck); if (s) { var p = JSON.parse(s); fresh = p; } } catch(e) {}
            if (fresh && fresh.d) {
                if (Date.now() - fresh.t > ttlMs) {
                    // หมดอายุ — refresh background โดยไม่รอ
                    callBackendGet(action, params || {}).then(function(r) {
                        if (r && r.success !== false) {
                            try { localStorage.setItem(ck, JSON.stringify({t: Date.now(), d: r})); } catch(e) {}
                        }
                    }).catch(function(){});
                }
                return fresh.d; // return ทันทีจาก cache
            }
            // ไม่มี cache — ต้องรอ fetch จริง
            var r = await callBackendGet(action, params || {});
            if (r && r.success !== false) {
                try { localStorage.setItem(ck, JSON.stringify({t: Date.now(), d: r})); } catch(e) {}
            }
            return r;
        }

        async function checkSession() {
            const token = localStorage.getItem('sessionToken');
            if (!token) { window.navigate('?page=login'); return null; }
            if (!WEB_APP_URL) return JSON.parse(localStorage.getItem('currentUser') || 'null');
            try {
                const result = await callBackendGet('getCurrentUser');
                if (!result || !result.success) { localStorage.clear(); window.navigate('?page=login'); return null; }
                // บันทึก house_number ลง localStorage เพื่อให้ทุกหน้าอ่านได้
                var hn = (result.user && result.user.resident && result.user.resident.house_number)
                         ? result.user.resident.house_number
                         : (result.user && result.user.house_number ? result.user.house_number : '');
                if (hn) localStorage.setItem('currentUserUnit', hn);
                localStorage.setItem('currentUser', JSON.stringify(result.user));
                return result.user;
            } catch { localStorage.clear(); window.navigate('?page=login'); return null; }
        }

        // ============ Helpers ============
        const urlParams = new URLSearchParams(window.location.search);
        var unitNumber = urlParams.get('unit') || localStorage.getItem('currentUserUnit') || '';
        const periodKey = urlParams.get('period') || getCurrentPeriodKey();

        const THAI_MONTHS = [
            'มกราคม','กุมภาพันธ์','มีนาคม','เมษายน','พฤษภาคม','มิถุนายน',
            'กรกฎาคม','สิงหาคม','กันยายน','ตุลาคม','พฤศจิกายน','ธันวาคม'
        ];

        function getCurrentPeriodKey(){
            const now = new Date();
            const yearBE = now.getFullYear() + 543;
            const month = String(now.getMonth() + 1).padStart(2, '0');
            return yearBE + month;
        }

        // แปลง key 256902 → 2569-02
        function toApiPeriod(key){
            if (!key || key.length < 6) return key;
            if (key.includes('-')) return key;
            return key.substring(0, 4) + '-' + key.substring(4, 6);
        }

        function formatPeriod(key){
            if(!key || key.length < 6) return '-';
            const year = key.substring(0, 4);
            const monthIdx = parseInt(key.substring(4, 6)) - 1;
            return THAI_MONTHS[monthIdx] + ' ' + year;
        }

        function formatMoney(v){
            const n = Number(v);
            return Number.isFinite(n) ? n.toLocaleString('th-TH') : '0';
        }

        // ============ ย่อขนาดรูป (max 1200px, quality 0.7) ============
        function resizeImage(file, maxWidth = 1200, quality = 0.7){
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = function(e){
                    const img = new Image();
                    img.onload = function(){
                        let w = img.width, h = img.height;
                        if (w > maxWidth) { h = Math.round(h * maxWidth / w); w = maxWidth; }
                        const canvas = document.createElement('canvas');
                        canvas.width = w; canvas.height = h;
                        canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                        resolve(canvas.toDataURL('image/jpeg', quality));
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        // ============ โหลดยอดที่ต้องชำระ ============
        async function loadBillingInfo(){
            document.getElementById('display-unit').textContent = unitNumber || '-';
            document.getElementById('display-period').textContent = formatPeriod(periodKey);

            let totalAmount = 0;
            let residentName = '';

            // ลองจาก Backend ก่อน
            if (WEB_APP_URL) {
                try {
                    const period = toApiPeriod(periodKey);
                    const result = await callBackendGet('getBillSummaryAll', { period });
                    if (result && result.success && result.data) {
                        const row = result.data.find(r => String(r.house_number) === String(unitNumber));
                        if (row) {
                            totalAmount = (parseFloat(row.water_amount) || 0) + (parseFloat(row.electric_amount) || 0) + (parseFloat(row.common_fee) || 0);
                            residentName = row.resident_name || '';
                        }
                    }
                } catch (e) { console.error('getBillSummaryAll error:', e); }
            }

            // Fallback ถ้า Backend ไม่มีข้อมูล
            if (totalAmount === 0) {
                const residentsData = JSON.parse(localStorage.getItem('residentsData') || '[]');
                const waterData = JSON.parse(localStorage.getItem('waterBill_' + periodKey) || '{}');
                const waterRecords = waterData.records || [];
                const electricData = JSON.parse(localStorage.getItem('electricBill_' + periodKey) || '{}');
                const electricRecords = electricData.records || [];
                const commonFeeRate = Number(localStorage.getItem('commonFee') || '110');

                const resident = residentsData.find(r => r.house_number === unitNumber);
                const waterRecord = waterRecords.find(w => w.house === unitNumber) || {};
                const electricRecord = electricRecords.find(e => e.house === unitNumber) || {};

                const waterAmount = parseFloat(waterRecord.amount) || 0;
                const electricAmount = parseFloat(electricRecord.amount) || 0;
                const commonFee = resident && resident.no_resident ? 0 : commonFeeRate;
                totalAmount = waterAmount + electricAmount + commonFee;
                residentName = resident ? resident.resident : '';
            }

            document.getElementById('display-amount').textContent = formatMoney(totalAmount) + ' บาท';
            document.getElementById('paid-amount').value = totalAmount;

            window.billingInfo = {
                unitNumber: unitNumber,
                periodKey: periodKey,
                period: toApiPeriod(periodKey),
                notifiedAmount: totalAmount,
                residentName: residentName
            };
        }

        // ============ Preview ============
        document.getElementById('slip').addEventListener('change', function(e){
            const previewContainer = document.getElementById('preview-container');
            previewContainer.innerHTML = '';
            const files = Array.from(e.target.files).slice(0, 3); // จำกัด 3 รูป
            files.forEach((file) => {
                const reader = new FileReader();
                reader.onload = function(event){
                    const img = document.createElement('img');
                    img.src = event.target.result;
                    img.style.cssText = 'width:80px;height:80px;object-fit:cover;border-radius:8px;border:2px solid #4f8cff;';
                    previewContainer.appendChild(img);
                };
                reader.readAsDataURL(file);
            });
        });

        // ============ Submit ============
        document.getElementById('slipForm').addEventListener('submit', async function(e){
            e.preventDefault();

            const paidAmount = parseFloat(document.getElementById('paid-amount').value) || 0;
            const fileInput = document.getElementById('slip');
            const files = Array.from(fileInput.files).slice(0, 3);

            if(files.length === 0){ ppkAlert('กรุณาแนบรูปสลิปอย่างน้อย 1 รูป'); return; }
            if(paidAmount <= 0){ ppkAlert('กรุณากรอกจำนวนเงินที่ชำระ'); return; }

            const submitBtn = document.querySelector('.submit-btn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'กำลังส่ง...';

            try {
                // ย่อขนาดรูปทุกรูป
                const resizedImages = [];
                for (const file of files) {
                    const resized = await resizeImage(file);
                    resizedImages.push(resized);
                }

                // ส่งไป Backend (ถ้ามี)
                if (WEB_APP_URL) {
                    // อัปโหลดรูปทีละรูป
                    const fileIds = [];
                    for (let i = 0; i < resizedImages.length; i++) {
                        const uploadResult = await callBackend('uploadSlipImage', {
                            image: resizedImages[i],
                            houseId: window.billingInfo.unitNumber,
                            period: window.billingInfo.period,
                            index: i
                        });
                        if (uploadResult && uploadResult.success) {
                            fileIds.push(uploadResult.fileId);
                        } else {
                            throw new Error(uploadResult?.error || 'อัปโหลดรูปล้มเหลว');
                        }
                    }

                    // ส่งข้อมูลสลิป
                    const user = JSON.parse(localStorage.getItem('currentUser') || '{}');
                    // ถ้าเป็น admin mode ให้ใช้ email จากช่อง override แทน
                    const submitEmail = isAdmin
                        ? (document.getElementById('admin-email-input').value.trim() || user.email || '')
                        : (user.email || '');
                    const submitResult = await callBackend('submitSlip', {
                        period: window.billingInfo.period,
                        house_number: window.billingInfo.unitNumber,
                        resident_name: window.billingInfo.residentName || user.name || '',
                        email: submitEmail,
                        notified_amount: window.billingInfo.notifiedAmount,
                        paid_amount: paidAmount,
                        slip_file_ids: fileIds,
                        payment_method: 'transfer'
                    });

                    if (submitResult && submitResult.success) {
                        ppkAlert('✓ ส่งสลิปเรียบร้อยแล้ว!\n\nกรุณารอการตรวจสอบจากเจ้าหน้าที่');
                        window.navigate('?page=dashboard');
                        return;
                    } else {
                        throw new Error(submitResult?.error || 'ส่งสลิปไม่สำเร็จ');
                    }
                }

                // Fallback: บันทึกลง localStorage
                const slipData = {
                    unitNumber: window.billingInfo.unitNumber,
                    name: window.billingInfo.residentName,
                    periodKey: window.billingInfo.periodKey,
                    notifiedAmount: window.billingInfo.notifiedAmount,
                    paidAmount: paidAmount,
                    slipImages: resizedImages,
                    submittedAt: new Date().toISOString(),
                    status: 'pending'
                };

                const key = 'slipSubmissions_' + window.billingInfo.periodKey;
                const submissions = JSON.parse(localStorage.getItem(key) || '[]');
                const existingIndex = submissions.findIndex(s => s.unitNumber === slipData.unitNumber);
                if (existingIndex !== -1) {
                    if (!await ppkConfirm('คุณเคยส่งสลิปแล้ว ต้องการส่งใหม่หรือไม่?')) {
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'ยืนยันการส่งสลิป';
                        return;
                    }
                    submissions[existingIndex] = slipData;
                } else {
                    submissions.push(slipData);
                }
                localStorage.setItem(key, JSON.stringify(submissions));

                ppkAlert('✓ ส่งสลิปเรียบร้อยแล้ว!\n\nกรุณารอการตรวจสอบจากเจ้าหน้าที่');
                window.navigate('?page=dashboard');

            } catch (err) {
                ppkAlert('เกิดข้อผิดพลาด: ' + err.message);
                submitBtn.disabled = false;
                submitBtn.textContent = 'ยืนยันการส่งสลิป';
            }
        });

        // ============ Admin Override Helpers ============
        var isAdmin = false;

        async function initAdminOverride(user) {
            if (user.role !== 'admin') return;
            isAdmin = true;
            document.getElementById('admin-override-panel').style.display = 'block';

            // โหลดรายการบ้าน/แฟลตทั้งหมด
            let houses = JSON.parse(localStorage.getItem('housingData') || '[]');
            if (houses.length === 0 && WEB_APP_URL) {
                try {
                    const r = await callBackendGet('getHousingList');
                    if (r && r.success) houses = r.data || [];
                } catch(e) {}
            }
            // เรียงตัวเลข
            houses.sort((a, b) => {
                const typeA = (a.display_number||'').startsWith('บ้าน') ? 0 : 1;
                const typeB = (b.display_number||'').startsWith('บ้าน') ? 0 : 1;
                if (typeA !== typeB) return typeA - typeB;
                return parseInt((a.display_number||'').match(/\d+/)||[0]) - parseInt((b.display_number||'').match(/\d+/)||[0]);
            });
            const sel = document.getElementById('admin-house-select');
            houses.forEach(h => {
                const dn = h.display_number || '';
                if (!dn) return;
                const opt = document.createElement('option');
                opt.value = dn;
                opt.textContent = dn + (h.status === 'occupied' ? ' (มีผู้พัก)' : ' (ว่าง)');
                // ถ้า unitNumber มีการระบุมาก่อน → pre-select
                if (unitNumber && dn === unitNumber) opt.selected = true;
                sel.appendChild(opt);
            });

            // ไม่ pre-fill ด้วย email admin — ปล่อยว่างไว้ให้ admin กรอกเองหรือ auto-fill จากผู้พัก
            document.getElementById('admin-email-input').value = '';
            document.getElementById('admin-email-input').placeholder = 'กรอกอีเมลผู้พักอาศัย (อีเมลอื่น ไม่ใช่ admin)';

            // ถ้าเลือกบ้านไว้แล้ว (จาก URL param) → auto-fill email จากผู้พักบ้านนั้น
            if (unitNumber) await fillResidentEmail(unitNumber);
        }

        async function fillResidentEmail(houseNumber) {
            // พยายามหา email ของผู้พักในบ้านนั้นจาก residents
            let residents = JSON.parse(localStorage.getItem('residentsData') || '[]');
            if (residents.length === 0 && WEB_APP_URL) {
                try {
                    const r = await callBackendGet('getResidentsList');
                    if (r && r.success) residents = r.data || [];
                } catch(e) {}
            }
            const found = residents.find(r => r.house_number === houseNumber && r.resident_type !== 'cohabitant');
            if (found && found.email) {
                document.getElementById('admin-email-input').value = found.email;
            }
        }

        async function onAdminHouseChange() {
            const sel = document.getElementById('admin-house-select');
            const selected = sel.value;
            if (!selected) return;
            unitNumber = selected;
            document.getElementById('display-unit').textContent = unitNumber;
            await fillResidentEmail(unitNumber);
            await loadBillingInfo();
        }

        // โหลดข้อมูลเมื่อเปิดหน้า
        window.onload = async function(){
            const user = await checkSession();
            if (!user) return;
            // อัปเดต unitNumber จาก user ถ้ายังว่าง
            if (!unitNumber) {
                unitNumber = (user.resident && user.resident.house_number)
                    ? user.resident.house_number
                    : (user.house_number || '');
            }
            // Admin mode
            await initAdminOverride(user);
            await loadBillingInfo();
        };
    </script>
    <script src="ppk-utils.js"></script></body>
</html>