<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ลืมรหัสผ่าน | ระบบสมาชิก</title>
    <style>
    @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@400;700&display=swap');
    body {
        font-family: 'Kanit', sans-serif;
        background: linear-gradient(135deg, #4f8cff 0%, #38e8ff 100%);
        min-height: 100vh;
        margin: 0;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .login-container {
        background: #fff;
        border-radius: 18px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.15);
        padding: 2.5rem 2rem 2rem 2rem;
        max-width: 370px;
        width: 100%;
        display: flex;
        flex-direction: column;
        gap: 1.2rem;
    }
    .login-container h2 {
        margin: 0 0 1rem 0;
        color: #2563eb;
        font-weight: 700;
        text-align: center;
    }
    .form-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }
    label {
        font-size: 1rem;
        color: #333;
    }
    input[type="email"] {
        padding: 0.7rem 1rem;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 1rem;
        outline: none;
        transition: border 0.2s;
    }
    input[type="email"]:focus {
        border: 1.5px solid #2563eb;
    }
    .error-message {
        color: #e11d48;
        font-size: 0.95rem;
        margin-top: -0.5rem;
        margin-bottom: 0.5rem;
        display: none;
    }
    .login-btn {
        background: linear-gradient(90deg, #2563eb 0%, #38e8ff 100%);
        color: #fff;
        border: none;
        border-radius: 8px;
        padding: 0.8rem 0;
        font-size: 1.1rem;
        font-weight: 700;
        cursor: pointer;
        transition: background 0.2s;
    }
    .login-btn:hover {
        background: linear-gradient(90deg, #38e8ff 0%, #2563eb 100%);
    }
    .menu-links {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        margin-top: 0.5rem;
    }
    .menu-links a {
        color: #2563eb;
        text-decoration: none;
        font-size: 0.98rem;
        text-align: center;
        transition: color 0.2s;
    }
    .menu-links a:hover {
        color: #e11d48;
    }
    @media (max-width: 480px) {
        .login-container {
            padding: 1.5rem 0.7rem 1.2rem 0.7rem;
            max-width: 98vw;
        }
    }
    </style>
</head>
<body>
    <form class="login-container" id="forgotForm" autocomplete="on" onsubmit="return validateForgot();">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.5rem;">
            <div>
                <div style="font-size:1.15rem; font-weight:700; color:#2563eb;">HOME PPK 2026</div>
                <div style="font-size:0.98rem; color:#555;">โปรแกรมบริหารจัดการ งานส่งเสริม กำกับ ดูแล และพัฒนาบ้านพักครู โรงเรียนพะเยาพิทยาคม</div>
            </div>
        </div>
        <h2 id="forgotTitle">ลืมรหัสผ่าน</h2>
        <div class="form-group">
            <label for="email" id="emailLabel">กรอกอีเมลที่ใช้สมัคร</label>
            <input type="email" id="email" name="email" required placeholder="กรอกอีเมลของคุณ">
        </div>
        <div class="error-message" id="errorMsg"></div>
        <button type="submit" class="login-btn" id="forgotBtn">ขอรหัสผ่านใหม่</button>
        <div class="menu-links">
            <a href="#" onclick="navigate('?page=login');return false;" id="backToLogin">กลับสู่หน้าเข้าสู่ระบบ</a>
        </div>
        <div style="text-align:center; margin-top:1.2rem; font-size:0.95rem; color:#888;" id="footerCredit">
            ออกแบบและพัฒนาโดย ครูพงศธร โพธิแก้ว
            <br>งานส่งเสริม กำกับ ดูแล และพัฒนาบ้านพักครู โรงเรียนพะเยาพิทยาคม
        </div>
    </form>
    <script>
        // ============ API Configuration ============
        var WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzZA4dyjggDBAs94YF62rwr68IKlKq-AuIeHVxUVvLImAXhzVzhMeZd85jvxzU9CGepPg/exec';
        function navigate(page) { var m = page.match(/[?&]page=([^&]+)/); window.location.href = m ? m[1] + '.html' : page; }

        // ============ API Helper ============
        async function callBackend(action, data = {}) {
            const payload = { action, ...data };
            try {
                const response = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify(payload),
                    redirect: 'follow'
                });
                const text = await response.text();
                return JSON.parse(text);
            } catch (err) {
                console.error('Backend error:', err);
                throw new Error('ไม่สามารถเชื่อมต่อระบบได้ — กรุณาลองใหม่');
            }
        }

        // ============ Form Validation ============
        function validateForgot() {
            const email = document.getElementById('email').value.trim();
            const errorMsg = document.getElementById('errorMsg');
            errorMsg.style.display = 'none';
            errorMsg.textContent = '';
            if (!/^\S+@\S+\.\S+$/.test(email)) {
                errorMsg.textContent = 'กรุณากรอกอีเมลให้ถูกต้อง';
                errorMsg.style.display = 'block';
                return false;
            }
            // Validation passed → call backend
            handleResetPassword();
            return false; // prevent form submission
        }

        // ============ Reset Password Handler ============
        async function handleResetPassword() {
            const email = document.getElementById('email').value.trim();
            const errorMsg = document.getElementById('errorMsg');
            const forgotBtn = document.getElementById('forgotBtn');

            forgotBtn.disabled = true;
            forgotBtn.textContent = 'กำลังดำเนินการ...';
            errorMsg.style.display = 'none';

            try {
                if (!WEB_APP_URL) {
                    throw new Error('ยังไม่ได้ตั้งค่า WEB_APP_URL — กรุณาติดต่อผู้ดูแลระบบ');
                }

                const result = await callBackend('resetPassword', { email });

                if (result.success) {
                    // แสดงข้อความสำเร็จ
                    document.getElementById('forgotForm').innerHTML = `
                        <div style="text-align:center; padding:2rem 1rem;">
                            <div style="font-size:3rem; margin-bottom:1rem;">📧</div>
                            <h2 style="color:#10b981; margin-bottom:1rem;">ส่งคำขอเรียบร้อย!</h2>
                            <p style="color:#555; font-size:1.05rem; margin-bottom:1.5rem;">
                                ${result.message || 'หากอีเมลนี้มีในระบบ คุณจะได้รับรหัสผ่านใหม่ทางอีเมล'}<br>
                                <small style="color:#888;">กรุณาตรวจสอบกล่องจดหมายของคุณ (รวมถึงโฟลเดอร์สแปม)</small>
                            </p>
                            <a href="#" onclick="navigate('?page=login');return false;" style="display:inline-block; padding:0.8rem 2rem; background:linear-gradient(90deg,#2563eb,#38e8ff); color:#fff; border-radius:8px; text-decoration:none; font-weight:700;">กลับสู่หน้าเข้าสู่ระบบ</a>
                        </div>
                    `;
                } else {
                    errorMsg.textContent = result.error || 'ไม่สามารถดำเนินการได้';
                    errorMsg.style.display = 'block';
                }
            } catch (err) {
                errorMsg.textContent = err.message || 'ไม่สามารถเชื่อมต่อระบบได้';
                errorMsg.style.display = 'block';
            } finally {
                forgotBtn.disabled = false;
                forgotBtn.textContent = 'ขอรหัสผ่านใหม่';
            }
        }
    </script>
</body>
</html>

