<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>แดชบอร์ด | HOME PPK 2026</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@400;600;700&display=swap');

        :root {
            --bg: #f8fafc;
            --surface: #ffffff;
            --border: #e5e7eb;
            --text: #0f172a;
            --muted: #64748b;
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #06b6d4;
            --shadow: 0 8px 24px rgba(15,23,42,.06);
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            min-height: 100vh;
            font-family: 'Kanit', sans-serif;
            background: var(--bg);
            color: var(--text);
        }

        /* Sidebar */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            width: 62px;
            background: linear-gradient(135deg, #2563eb 0%, #38e8ff 100%);
            box-shadow: 2px 0 12px rgba(0,0,0,0.07);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1.2rem 0.3rem;
            transition: width 0.2s;
            z-index: 100;
        }
        .sidebar.expanded { width: 280px; align-items: flex-start; padding-left: 0.7rem; }
        .sidebar-toggle {
            background: none;
            border: none;
            color: #fff;
            font-size: 1.7rem;
            margin-bottom: 1.2rem;
            cursor: pointer;
            outline: none;
            align-self: flex-end;
        }
        .sidebar-menu { display: flex; flex-direction: column; gap: 0.2rem; width: 100%; flex: 1; }
        .sidebar-link {
            display: flex;
            align-items: center;
            gap: 0.9rem;
            color: #fff;
            background: none;
            border: none;
            font-size: 1.08rem;
            font-family: inherit;
            padding: 0.5rem;
            border-radius: 8px;
            cursor: pointer;
            text-align: left;
            width: 100%;
            transition: background 0.15s, color 0.15s;
        }
        .sidebar-link.active, .sidebar-link:hover { background: #fff; color: #2563eb; }
        .sidebar-link-icon { font-size: 1.25rem; min-width: 1.5em; text-align: center; }
        .sidebar-label { display: none; font-size: 1rem; line-height: 1.3; }
        .sidebar.expanded .sidebar-label { display: inline; }

        @media (max-width: 600px) {
            .sidebar { width: 48px; }
            .sidebar.expanded { width: 160px; }
        }

        /* Main Container */
        .dashboard-container {
            margin-left: 62px;
            min-height: 100vh;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            align-items: center;
            transition: margin-left 0.2s;
        }
        .sidebar.expanded ~ .dashboard-container { margin-left: 280px; }
        @media (max-width: 600px) {
            .dashboard-container { margin-left: 48px; padding: 1rem; }
            .sidebar.expanded ~ .dashboard-container { margin-left: 160px; }
        }

        /* Header */
        .dashboard-header {
            display: flex;
            align-items: center;
            gap: 0.7rem;
            margin-bottom: 0.5rem;
            justify-content: center;
        }
        .dashboard-header-icon {
            font-size: 2.1rem;
            color: var(--primary);
        }
        .dashboard-container h2 {
            margin: 0;
            color: var(--primary);
            font-weight: 700;
            font-size: 1.8rem;
            text-align: center;
        }

        /* Section Cards */
        .section {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            width: 100%;
            max-width: 600px;
        }
        .section-title {
            font-size: 1.15rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .announce-list {
            margin: 0;
            padding-left: 1.2em;
            color: var(--text);
            font-size: 1rem;
            line-height: 1.8;
        }
        .amount {
            font-size: 1.25rem;
            color: var(--danger);
            font-weight: 700;
        }
        .amount-ok {
            color: var(--success);
        }
        .section-content {
            font-size: 1.05rem;
            color: var(--text);
            margin-top: 0.25rem;
        }

        .footer-note {
            text-align: center;
            margin-top: 1rem;
            font-size: 0.95rem;
            color: var(--muted);
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <button class="sidebar-toggle" id="sidebarToggle" title="ขยาย/ย่อเมนู">☰</button>
        <nav class="sidebar-menu">
            <button class="sidebar-link active" onclick="navigate('?page=dashboard')">
                <span class="sidebar-link-icon">🏠</span>
                <span class="sidebar-label">แดชบอร์ด</span>
            </button>
            <button class="sidebar-link" onclick="navigate('?page=payment-history')">
                <span class="sidebar-link-icon">💸</span>
                <span class="sidebar-label">ข้อมูลการชำระย้อนหลัง</span>
            </button>
            <button class="sidebar-link" onclick="navigate('?page=upload-slip')">
                <span class="sidebar-link-icon">📤</span>
                <span class="sidebar-label">ส่งสลิปชำระเงิน</span>
            </button>
            <button class="sidebar-link" onclick="navigate('?page=form')">
                <span class="sidebar-link-icon">📝</span>
                <span class="sidebar-label">แบบฟอร์มคำร้อง</span>
            </button>
            <button class="sidebar-link" onclick="navigate('?page=regulations')">
                <span class="sidebar-link-icon">📚</span>
                <span class="sidebar-label">ระเบียบ</span>
            </button>
            <button class="sidebar-link" onclick="navigate('?page=settings')">
                <span class="sidebar-link-icon">⚙️</span>
                <span class="sidebar-label">ตั้งค่าส่วนตัว</span>
            </button>
            <button class="sidebar-link" onclick="navigate('?page=team-management')">
                <span class="sidebar-link-icon">👥</span>
                <span class="sidebar-label">โปรแกรมบริหารจัดการ</span>
            </button>
            <button class="sidebar-link" onclick="doLogout()" style="margin-top:auto;border-top:1px solid rgba(255,255,255,0.12);color:#fca5a5;">
                <span class="sidebar-link-icon">🚪</span>
                <span class="sidebar-label">ออกจากระบบ</span>
            </button>

        </nav>
    </div>

    <div class="dashboard-container" id="dashboardContainer">
        <div class="dashboard-header">
            <span class="dashboard-header-icon">🏠</span>
            <h2>แดชบอร์ด</h2>
        </div>
        <div class="section">
            <div class="section-title">📢 ประกาศ</div>
            <ul class="announce-list" id="announceList">
                <li style="color: var(--muted);">กำลังโหลดประกาศ...</li>
            </ul>
        </div>
        <div class="section">
            <div class="section-title">💳 แจ้งยอดชำระประจำเดือน</div>
            <div class="section-content">ยอดที่ต้องชำระเดือนนี้: <span class="amount" id="currentMonthAmount">0</span> บาท</div>
        </div>
        <div class="section">
            <div class="section-title">🧾 แจ้งยอดคงค้าง</div>
            <div class="section-content">ยอดคงค้างสะสม: <span class="amount" id="outstandingAmount">0</span> บาท</div>
        </div>
        <div class="footer-note">
            ออกแบบและพัฒนาโดย ครูพงศธร โพธิแก้ว<br>
            งานส่งเสริม กำกับ ดูแล และพัฒนาบ้านพักครู โรงเรียนพะเยาพิทยาคม
        </div>
    </div>

    <script>
        // ========== Backend Infrastructure ==========
        var WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzZA4dyjggDBAs94YF62rwr68IKlKq-AuIeHVxUVvLImAXhzVzhMeZd85jvxzU9CGepPg/exec';
        function navigate(page) { var m = page.match(/[?&]page=([^&]+)/); window.location.href = m ? m[1] + '.html' : page; }
        function getSessionToken() { return localStorage.getItem('sessionToken') || ''; }

        async function callBackend(action, data) {
            if (!WEB_APP_URL) return null;
            const res = await fetch(WEB_APP_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify({ action, token: getSessionToken(), ...data })
            });
            return res.json();
        }
        //  cachedCall: GET + localStorage cache (TTL 2 นาที) 
        async function cachedCall(action, params, ttlMs) {
            ttlMs = ttlMs || 120000;
            var ck = 'apicache_' + action + '_' + JSON.stringify(params || {});
            try {
                var s = localStorage.getItem(ck);
                if (s) { var p = JSON.parse(s); if (Date.now() - p.t < ttlMs) return p.d; }
            } catch(e) {}
            var r = await callBackendGet(action, params || {});
            if (r && r.success !== false) {
                try { localStorage.setItem(ck, JSON.stringify({t: Date.now(), d: r})); } catch(e) {}
            }
            return r;
        }

        async function callBackendGet(action, params) {
            if (!WEB_APP_URL) return null;
            const token = getSessionToken();
            const q = new URLSearchParams({ action, token, ...params }).toString();
            const res = await fetch(WEB_APP_URL + '?' + q);
            return res.json();
        }
        //  cachedCall: GET + localStorage cache (TTL 2 นาที) 
        async function cachedCall(action, params, ttlMs) {
            ttlMs = ttlMs || 120000;
            var ck = 'apicache_' + action + '_' + JSON.stringify(params || {});
            try {
                var s = localStorage.getItem(ck);
                if (s) { var p = JSON.parse(s); if (Date.now() - p.t < ttlMs) return p.d; }
            } catch(e) {}
            var r = await callBackendGet(action, params || {});
            if (r && r.success !== false) {
                try { localStorage.setItem(ck, JSON.stringify({t: Date.now(), d: r})); } catch(e) {}
            }
            return r;
        }

        // ========== Render Announcements ==========
        function renderAnnouncements(announcements) {
            const announceList = document.getElementById('announceList');
            if (!Array.isArray(announcements)) announcements = [];
            const today = new Date();
            const active = announcements.filter(a => {
                if (!a.active && a.active !== undefined) return false;
                if (a.expiry && new Date(a.expiry) < today) return false;
                return true;
            });
            if (active.length === 0) {
                announceList.innerHTML = '<li style="color: var(--muted);">ไม่มีประกาศในขณะนี้</li>';
                return;
            }
            const colors = { normal: 'inherit', important: '#f59e0b', urgent: '#ef4444' };
            announceList.innerHTML = active.map(a => {
                const color = colors[a.priority] || 'inherit';
                const prefix = a.priority === 'urgent' ? '🚨 ' : (a.priority === 'important' ? '⚠️ ' : '');
                return `<li style="color: ${color};">${prefix}${a.text}</li>`;
            }).join('');
        }

        // ========== Render Payment Info ==========
        function renderPaymentInfo(outstandingArr, recentPayments, userHouse) {
            const outstandingEl = document.getElementById('outstandingAmount');
            const currentAmountEl = document.getElementById('currentMonthAmount');

            // Outstanding (backend already filtered for resident role)
            const totalOutstanding = (outstandingArr || []).reduce((s, r) => s + (Number(r.balance) || 0), 0);
            outstandingEl.textContent = totalOutstanding.toLocaleString('th-TH');
            outstandingEl.className = totalOutstanding > 0 ? 'amount' : 'amount amount-ok';

            // Current month total from recent payments
            const now = new Date();
            const currentMonth = String(now.getMonth() + 1).padStart(2, '0');
            const currentYear = String(now.getFullYear() + 543);
            const thisMonth = (recentPayments || []).filter(r =>
                String(r.month) === currentMonth && String(r.year) === currentYear
            );
            const monthTotal = thisMonth.reduce((s, r) => s + (Number(r.total_amount || r.amount) || 0), 0);
            currentAmountEl.textContent = monthTotal > 0 ? monthTotal.toLocaleString('th-TH') : '-';
            currentAmountEl.className = monthTotal > 0 ? 'amount' : 'amount amount-ok';
        }

        // ========== Fallback: localStorage ==========
        function renderPaymentInfoFromStorage(userHouse) {
            const now = new Date();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const year = String(now.getFullYear() + 543);
            const key = year + month;
            const waterData = JSON.parse(localStorage.getItem('waterBill_' + key) || '{}');
            const electricData = JSON.parse(localStorage.getItem('electricBill_' + key) || '{}');
            const waterRecord = (waterData.records || []).find(w => w.house === userHouse) || {};
            const electricRecord = (electricData.records || []).find(e => e.house === userHouse) || {};
            const commonFee = Number(localStorage.getItem('commonFee')) || 110;
            const total = (parseFloat(waterRecord.amount) || 0) + (parseFloat(electricRecord.amount) || 0) + commonFee;
            document.getElementById('currentMonthAmount').textContent = total.toLocaleString('th-TH');
            document.getElementById('currentMonthAmount').className = total > 0 ? 'amount' : 'amount amount-ok';
            let outstandingTotal = 0;
            JSON.parse(localStorage.getItem('paymentHistory_' + userHouse) || '[]').forEach(p => {
                if (p.status === 'unpaid' || p.status === 'pending') outstandingTotal += parseFloat(p.amount) || 0;
            });
            document.getElementById('outstandingAmount').textContent = outstandingTotal.toLocaleString('th-TH');
            document.getElementById('outstandingAmount').className = outstandingTotal > 0 ? 'amount' : 'amount amount-ok';
        }

        // ========== Load Dashboard (single API call) ==========
        async function loadDashboard() {
            const token = getSessionToken();
            if (!token) { navigate('?page=login'); return; }

            if (!WEB_APP_URL) {
                // Fallback local
                const cached = JSON.parse(localStorage.getItem('currentUser') || '{}');
                const userHouse = cached.house_number || cached.resident?.house_number || '';
                renderAnnouncements(JSON.parse(localStorage.getItem('announcements') || '[]'));
                renderPaymentInfoFromStorage(userHouse);
                return;
            }

            try {
                const result = await callBackendGet('getDashboardData', {});
                if (!result || !result.success) { localStorage.clear(); navigate('?page=login'); return; }

                // Store user data
                const userData = result.user && result.user.user ? result.user.user : null;
                if (userData) {
                    localStorage.setItem('currentUser', JSON.stringify(userData));
                    // Cache house_number แยกเป็น currentUserUnit เพื่อใช้ในหน้าอื่น
                    var hn = (userData.resident && userData.resident.house_number)
                             ? userData.resident.house_number
                             : (userData.house_number || '');
                    if (hn) localStorage.setItem('currentUserUnit', hn);
                }

                // Cache announcements
                if (Array.isArray(result.announcements)) {
                    localStorage.setItem('announcements', JSON.stringify(result.announcements));
                }

                const userHouse = userData?.resident?.house_number || userData?.house_number || '';
                renderAnnouncements(result.announcements || []);
                renderPaymentInfo(result.outstanding || [], result.recentPayments || [], userHouse);

            } catch(e) {
                console.warn('getDashboardData failed, falling back to localStorage', e);
                const cached = JSON.parse(localStorage.getItem('currentUser') || '{}');
                const userHouse = cached.house_number || cached.resident?.house_number || '';
                renderAnnouncements(JSON.parse(localStorage.getItem('announcements') || '[]'));
                renderPaymentInfoFromStorage(userHouse);
            }
        }

        // Sidebar toggle
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebarToggle');
        sidebarToggle.onclick = function() {
            sidebar.classList.toggle('expanded');
            document.getElementById('dashboardContainer').style.marginLeft = sidebar.classList.contains('expanded')
                ? (window.innerWidth <= 600 ? '160px' : '280px')
                : (window.innerWidth <= 600 ? '48px' : '62px');
        };
        document.getElementById('dashboardContainer').style.marginLeft = (window.innerWidth <= 600 ? '48px' : '62px');
        window.addEventListener('resize', function() {
            document.getElementById('dashboardContainer').style.marginLeft = sidebar.classList.contains('expanded')
                ? (window.innerWidth <= 600 ? '160px' : '280px')
                : (window.innerWidth <= 600 ? '48px' : '62px');
        });

        // Initialize on page load
        window.onload = async function() {
            await loadDashboard();
        };
    
        async function doLogout() {
            if (!confirm('ยืนยันออกจากระบบ?')) return;
            var token = getSessionToken ? getSessionToken() : (localStorage.getItem('sessionToken') || '');
            if (token && WEB_APP_URL) {
                try { await callBackend('logout', {}); } catch(e) {}
            }
            localStorage.clear();
            navigate('?page=login');
        }
        </script>
</body>
</html>

